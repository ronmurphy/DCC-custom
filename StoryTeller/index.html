<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Story Teller Tool - Unified Interface</title>
    
    <!-- Fonts -->
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&family=Playfair+Display:wght@700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rpg-awesome/0.2.0/css/rpg-awesome.min.css">

    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        /* Device Detection and Resolution Variables */
        :root {
            /* Base values - will be overridden by device detection */
            --base-font-size: 16px;
            --touch-target-min: 44px;
            --panel-gap: 2px;
            --padding-base: 20px;
            --border-radius: 6px;
            --header-height: 60px;
            --tab-height: 50px;
            
            /* Color scheme */
            --primary-gradient: linear-gradient(135deg, #1e3c72 0%, #2a5298 100%);
            --panel-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --success-gradient: linear-gradient(135deg, #00b894 0%, #00a085 100%);
            --danger-gradient: linear-gradient(135deg, #ff7675 0%, #d63031 100%);
            --warning-gradient: linear-gradient(135deg, #fdcb6e 0%, #e17055 100%);
            --action-gradient: linear-gradient(135deg, #74b9ff 0%, #0984e3 100%);
        }

        /* Tablet Mode (Default) */
        .mode-tablet {
            --base-font-size: 16px;
            --touch-target-min: 44px;
            --panel-gap: 2px;
            --padding-base: 20px;
            --border-radius: 6px;
            --header-height: 60px;
            --tab-height: 50px;
            --button-padding: 10px 12px;
            --input-height: 44px;
            --grid-gap: 10px;
        }

        /* High Resolution Mode */
        .mode-highres {
            --base-font-size: 18px;
            --touch-target-min: 48px;
            --panel-gap: 3px;
            --padding-base: 25px;
            --border-radius: 8px;
            --header-height: 70px;
            --tab-height: 55px;
            --button-padding: 12px 16px;
            --input-height: 52px;
            --grid-gap: 15px;
        }

        /* Ultra Mode (Premium) */
        .mode-ultra {
            --base-font-size: 20px;
            --touch-target-min: 60px;
            --panel-gap: 4px;
            --padding-base: 30px;
            --border-radius: 12px;
            --header-height: 80px;
            --tab-height: 60px;
            --button-padding: 15px 20px;
            --input-height: 60px;
            --grid-gap: 20px;
        }

        body {
            font-family: 'Poppins', sans-serif;
            font-size: var(--base-font-size);
            background: var(--primary-gradient);
            height: 100vh;
            overflow: hidden;
            color: #333;
            transition: all 0.3s ease;
        }

        /* Mode Toggle Control */
        .mode-toggle {
            position: fixed;
            top: 10px;
            right: 20px;
            z-index: 2000;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(10px);
            border-radius: var(--border-radius);
            color: white;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
            transition: all 0.3s ease;
            overflow: hidden;
        }

        .mode-toggle.collapsed {
            width: 50px;
            height: 50px;
        }

        .mode-toggle.collapsed .mode-toggle-content {
            display: none;
        }

        .mode-toggle-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 10px 15px;
            cursor: pointer;
            min-height: 50px;
        }

        .mode-toggle.collapsed .mode-toggle-header {
            justify-content: center;
            padding: 15px;
        }

        .mode-toggle-content {
            padding: 0 15px 15px 15px;
        }

        .toggle-icon {
            font-size: 1.2rem;
            transition: transform 0.3s ease;
        }

        .mode-toggle.collapsed .toggle-icon {
            transform: rotate(180deg);
        }

        .mode-toggle label {
            display: block;
            margin-bottom: 8px;
            font-size: 0.9rem;
            font-weight: 500;
        }

        .mode-selector {
            display: flex;
            gap: 3px;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 20px;
            padding: 3px;
        }

        .mode-option {
            padding: 6px 10px;
            border-radius: 18px;
            cursor: pointer;
            transition: all 0.2s;
            font-size: 0.8rem;
            text-align: center;
            min-width: 55px;
        }

        .mode-option.active {
            background: var(--action-gradient);
            color: white;
            font-weight: 600;
        }

        .mode-option:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .device-info {
            margin-top: 8px;
            font-size: 0.7rem;
            color: rgba(255, 255, 255, 0.7);
            text-align: center;
        }

        /* Layout Container */
        .desktop-container {
            display: grid;
            grid-template-rows: var(--header-height) var(--tab-height) 1fr;
            height: 100vh;
            transition: all 0.3s ease;
        }

        /* Header */
        .app-header {
            background: rgba(0, 0, 0, 0.2);
            backdrop-filter: blur(10px);
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 0 var(--padding-base);
            color: white;
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .app-title {
            display: flex;
            align-items: center;
            gap: calc(var(--padding-base) * 0.5);
            font-size: calc(var(--base-font-size) * 1.4);
            font-weight: 600;
        }

        .app-title i {
            font-size: calc(var(--base-font-size) * 1.6);
        }

        .session-info {
            display: flex;
            align-items: center;
            gap: calc(var(--padding-base) * 0.8);
            font-size: calc(var(--base-font-size) * 0.9);
        }

        .header-controls {
            display: flex;
            gap: calc(var(--padding-base) * 0.5);
        }

        .header-btn {
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 6px;
            transition: background 0.2s;
            font-size: calc(var(--base-font-size) * 0.9);
            min-height: var(--touch-target-min);
        }

        .header-btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .header-btn i {
            font-size: calc(var(--base-font-size) * 1.1);
        }

        /* Tab Bar */
        .tab-bar {
            background: rgba(0, 0, 0, 0.1);
            display: flex;
            align-items: center;
            padding: 0 var(--padding-base);
            gap: var(--grid-gap);
            border-bottom: 1px solid rgba(255, 255, 255, 0.1);
        }

        .tab-selector {
            display: flex;
            align-items: center;
            gap: 6px;
            background: rgba(255, 255, 255, 0.1);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.9);
            transition: all 0.2s;
            min-height: var(--touch-target-min);
        }

        .tab-selector:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .tab-selector.active {
            background: rgba(255, 255, 255, 0.3);
        }

        .tab-selector i {
            font-size: calc(var(--base-font-size) * 1.1);
        }

        /* Main Content Area */
        .content-area {
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: var(--panel-gap);
            background: rgba(0, 0, 0, 0.1);
            height: 100%;
        }

        .panel {
            background: white;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .panel-header {
            background: var(--panel-gradient);
            color: white;
            padding: var(--padding-base);
            display: flex;
            align-items: center;
            justify-content: space-between;
            min-height: calc(var(--touch-target-min) + 20px);
        }

        .panel-title {
            font-weight: 600;
            font-size: calc(var(--base-font-size) * 1.2);
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .panel-title i {
            font-size: calc(var(--base-font-size) * 1.3);
        }

        .panel-controls {
            display: flex;
            gap: 8px;
        }

        .panel-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            color: white;
            padding: 8px 12px;
            border-radius: calc(var(--border-radius) * 0.7);
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.85);
            display: flex;
            align-items: center;
            gap: 4px;
            transition: background 0.2s;
            min-height: calc(var(--touch-target-min) * 0.8);
            min-width: calc(var(--touch-target-min) * 0.8);
        }

        .panel-btn:hover {
            background: rgba(255, 255, 255, 0.3);
        }

        .panel-btn i {
            font-size: calc(var(--base-font-size) * 1);
        }

        .panel-content {
            flex: 1;
            padding: var(--padding-base);
            overflow-y: auto;
        }

        /* Command Interface */
        .command-interface {
            display: grid;
            grid-template-columns: 1fr calc(var(--padding-base) * 12);
            gap: var(--padding-base);
            height: 100%;
        }

        .command-categories {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(calc(var(--padding-base) * 12), 1fr));
            gap: var(--grid-gap);
            grid-auto-rows: max-content;
        }

        .command-category {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
            overflow: hidden;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .category-header {
            background: var(--panel-gradient);
            color: white;
            padding: calc(var(--padding-base) * 0.7);
            font-weight: 600;
            font-size: calc(var(--base-font-size) * 1.05);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .category-header i {
            font-size: calc(var(--base-font-size) * 1.2);
        }

        .category-content {
            padding: var(--grid-gap);
        }

        .command-grid {
            display: grid;
            gap: calc(var(--grid-gap) * 0.7);
            grid-template-columns: repeat(auto-fit, minmax(calc(var(--touch-target-min) * 2.5), 1fr));
        }

        .command-btn {
            background: var(--action-gradient);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-size: calc(var(--base-font-size) * 0.9);
            font-weight: 500;
            transition: all 0.2s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 6px;
            min-height: var(--touch-target-min);
            text-align: center;
        }

        .command-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        .command-btn:active {
            transform: translateY(0);
        }

        .command-btn.danger {
            background: var(--danger-gradient);
        }

        .command-btn.success {
            background: var(--success-gradient);
        }

        .command-btn.warning {
            background: var(--warning-gradient);
        }

        /* Player Selection */
        .player-selector {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            border: 1px solid #e9ecef;
            padding: var(--padding-base);
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
        }

        .player-selector h4 {
            margin-bottom: var(--grid-gap);
            color: #495057;
            font-size: calc(var(--base-font-size) * 1.1);
        }

        .player-list {
            display: flex;
            flex-direction: column;
            gap: var(--grid-gap);
        }

        .player-item {
            background: white;
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            padding: calc(var(--padding-base) * 0.7);
            cursor: pointer;
            transition: all 0.2s;
            font-size: calc(var(--base-font-size) * 0.9);
            min-height: var(--touch-target-min);
            display: flex;
            flex-direction: column;
            justify-content: center;
        }

        .player-item:hover {
            border-color: #74b9ff;
            box-shadow: 0 2px 8px rgba(116, 185, 255, 0.2);
        }

        .player-item.selected {
            border-color: #0984e3;
            background: #e3f2fd;
            box-shadow: 0 2px 12px rgba(9, 132, 227, 0.3);
        }

        .player-name {
            font-weight: 600;
            color: #2d3436;
            font-size: calc(var(--base-font-size) * 1);
        }

        .player-stats {
            font-size: calc(var(--base-font-size) * 0.8);
            color: #636e72;
            margin-top: 4px;
        }

        /* Chat Interface */
        .chat-interface {
            display: grid;
            grid-template-rows: 1fr auto;
            height: 100%;
        }

        .chat-error {
            background: #ffebee;
            border: 1px solid #e57373;
            color: #c62828;
            padding: 12px;
            border-radius: var(--border-radius);
            margin-bottom: var(--grid-gap);
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .chat-error .material-icons {
            color: #e57373;
        }

        .chat-messages {
            background: #f8f9fa;
            border-radius: var(--border-radius);
            margin-bottom: 0; /* Removed margin to prevent overflow */
            padding: var(--padding-base);
            overflow-y: auto;
            border: 1px solid #e9ecef;
            font-size: calc(var(--base-font-size) * 0.95);
            height: 100%;
            min-height: 0; /* Important for grid flex behavior */
        }

        .chat-message {
            margin-bottom: var(--grid-gap);
            padding: calc(var(--padding-base) * 0.6);
            border-radius: var(--border-radius);
            font-size: calc(var(--base-font-size) * 0.9);
            line-height: 1.4;
        }

        .chat-message.system {
            background: #e3f2fd;
            border-left: 4px solid #2196f3;
        }

        .chat-message.player {
            background: #f3e5f5;
            border-left: 4px solid #9c27b0;
        }

        .chat-message.storyteller {
            background: #fff3e0;
            border-left: 4px solid #ff9800;
        }

        .chat-input-area {
            display: flex;
            gap: var(--grid-gap);
            padding: var(--padding-base);
            background: var(--primary-color);
            border-top: 1px solid #e9ecef;
            min-height: calc(var(--input-height) + var(--padding-base) * 2);
        }

        .chat-input {
            flex: 1;
            padding: calc(var(--padding-base) * 0.7);
            border: 2px solid #e9ecef;
            border-radius: var(--border-radius);
            font-size: calc(var(--base-font-size) * 0.95);
            min-height: var(--input-height);
        }

        .chat-input:focus {
            outline: none;
            border-color: #74b9ff;
        }

        .send-btn {
            background: var(--action-gradient);
            border: none;
            color: white;
            padding: var(--button-padding);
            border-radius: var(--border-radius);
            cursor: pointer;
            font-weight: 500;
            font-size: calc(var(--base-font-size) * 0.95);
            transition: all 0.2s;
            min-height: var(--input-height);
            min-width: calc(var(--touch-target-min) * 2);
        }

        .send-btn:hover {
            transform: translateY(-1px);
            box-shadow: 0 4px 12px rgba(116, 185, 255, 0.4);
        }

        /* Dropdown styles */
        .panel-dropdown {
            position: relative;
            display: inline-block;
        }

        .dropdown-content {
            display: none;
            position: absolute;
            background-color: white;
            min-width: calc(var(--padding-base) * 10);
            box-shadow: 0 8px 16px rgba(0,0,0,0.2);
            border-radius: var(--border-radius);
            z-index: 1000;
            top: 100%;
            left: 0;
            border: 1px solid #e9ecef;
        }

        .dropdown-content.show {
            display: block;
        }

        .dropdown-item {
            color: #333;
            padding: var(--button-padding);
            text-decoration: none;
            display: flex;
            align-items: center;
            cursor: pointer;
            transition: background 0.2s;
            font-size: calc(var(--base-font-size) * 0.95);
            min-height: var(--touch-target-min);
        }

        .dropdown-item:hover {
            background-color: #f8f9fa;
        }

        .dropdown-item i {
            margin-right: 10px;
            width: 20px;
            font-size: calc(var(--base-font-size) * 1.1);
        }

        /* Status indicators */
        .status-indicator {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: calc(var(--border-radius) * 0.7);
            font-size: calc(var(--base-font-size) * 0.85);
            font-weight: 500;
        }

        .status-indicator.online {
            background: #d4edda;
            color: #155724;
        }

        .status-indicator.offline {
            background: #f8d7da;
            color: #721c24;
        }

        .status-indicator i {
            font-size: calc(var(--base-font-size) * 1);
        }

        /* Connection Status */
        .connection-status {
            display: inline-flex;
            align-items: center;
            gap: 6px;
            padding: 6px 10px;
            border-radius: calc(var(--border-radius) * 0.7);
            font-size: calc(var(--base-font-size) * 0.85);
            font-weight: 500;
            transition: all 0.3s ease;
        }

        .connection-status.success {
            background: #d4edda;
            color: #155724;
        }

        .connection-status.warning {
            background: #fff3cd;
            color: #856404;
        }

        .connection-status.error {
            background: #f8d7da;
            color: #721c24;
        }

        .connection-status.offline {
            background: #e2e3e5;
            color: #6c757d;
        }

        .connection-status i {
            font-size: calc(var(--base-font-size) * 1);
        }

        /* Responsive Design */
        @media screen and (max-width: 1024px) {
            .content-area {
                grid-template-columns: 1fr;
                grid-template-rows: 1fr 1fr;
            }
            
            .command-interface {
                grid-template-columns: 1fr;
                grid-template-rows: auto 1fr;
            }
            
            .command-categories {
                grid-template-columns: repeat(auto-fit, minmax(calc(var(--padding-base) * 10), 1fr));
            }
        }

        /* Device-specific enhancements */
        .mode-ultra .mode-toggle {
            transform: scale(1.1);
        }

        .mode-highres .command-btn:hover,
        .mode-ultra .command-btn:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 16px rgba(116, 185, 255, 0.5);
        }

        /* Scrollbar styling */
        ::-webkit-scrollbar {
            width: calc(var(--grid-gap) * 0.8);
        }

        ::-webkit-scrollbar-track {
            background: #f1f1f1;
            border-radius: var(--border-radius);
        }

        ::-webkit-scrollbar-thumb {
            background: #c1c1c1;
            border-radius: var(--border-radius);
        }

        ::-webkit-scrollbar-thumb:hover {
            background: #a8a8a8;
        }

        /* Settings Modal */
        .settings-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.8);
            backdrop-filter: blur(5px);
            z-index: 10000;
            justify-content: center;
            align-items: center;
        }

        .settings-modal-content {
            background: black;
            color: white;
            border-radius: 12px;
            width: 90%;
            max-width: 600px;
            max-height: 80vh;
            overflow-y: auto;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
        }

        .settings-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 20px;
            border-bottom: 1px solid var(--border-color);
            background: var(--primary-gradient);
            border-radius: 12px 12px 0 0;
        }

        .settings-header h3 {
            color: white;
            margin: 0;
            font-size: 1.5rem;
        }

        .close-btn {
            background: rgba(255, 255, 255, 0.2);
            border: none;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            color: white;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .close-btn:hover {
            background: rgba(255, 255, 255, 0.3);
            transform: scale(1.1);
        }

        .settings-body {
            padding: 20px;
            background: black;
            color: white;
        }

        .settings-section {
            margin-bottom: 30px;
        }

        .settings-section h4 {
            color: white;
            margin-bottom: 15px;
            font-size: 1.2rem;
            display: flex;
            align-items: center;
        }

        .url-section label {
            display: block;
            color: var(--text-secondary);
            margin-bottom: 8px;
            font-weight: 500;
        }

        .url-display {
            display: flex;
            gap: 8px;
            margin-bottom: 8px;
        }

        .url-input {
            flex: 1;
            padding: 12px;
            border: 1px solid #555;
            border-radius: var(--border-radius);
            background: #333;
            color: white;
            font-family: monospace;
            font-size: 0.9rem;
        }

        .copy-btn {
            background: #667eea;
            border: none;
            border-radius: var(--border-radius);
            color: white;
            padding: 12px;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .copy-btn:hover {
            background: #5a6fd8;
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3);
        }

        .url-help {
            color: var(--text-tertiary);
            font-size: 0.875rem;
            margin: 0;
        }

        .session-controls {
            display: flex;
            flex-direction: column;
            gap: 15px;
        }

        .session-status {
            display: flex;
            align-items: center;
            gap: 8px;
            padding: 12px;
            background: #333;
            border-radius: var(--border-radius);
            border: 1px solid #555;
        }

        .status-dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            background: #ef4444;
        }

        .status-dot.connected {
            background: #10b981;
        }

        .status-dot.offline {
            background: #6b7280;
        }

        .session-form {
            padding: 15px;
            border: 1px solid #555;
            border-radius: var(--border-radius);
            background: #222;
        }

        .form-row {
            display: flex;
            gap: 12px;
            margin-bottom: 15px;
        }

        .form-group {
            flex: 1;
        }

        .form-group label {
            display: block;
            color: #ccc;
            margin-bottom: 5px;
            font-weight: 500;
            font-size: 0.875rem;
        }

        .form-input {
            width: 100%;
            padding: 10px;
            border: 1px solid #555;
            border-radius: var(--border-radius);
            background: #333;
            color: white;
            font-size: 0.9rem;
        }

        .form-input:focus {
            outline: none;
            border-color: #667eea;
            box-shadow: 0 0 0 2px rgba(102, 126, 234, 0.2);
        }

        .local-session-controls {
            display: flex;
            gap: 12px;
            flex-wrap: wrap;
        }

        /* Smooth transitions for mode changes */
        * {
            transition: font-size 0.3s ease, padding 0.3s ease, margin 0.3s ease, 
                       min-height 0.3s ease, min-width 0.3s ease, border-radius 0.3s ease;
        }
    </style>
</head>
<body class="mode-tablet">
    <!-- Settings Modal -->
    <div class="settings-modal" id="settings-modal" style="display: none;">
        <div class="settings-modal-content">
            <div class="settings-header">
                <h3>Settings</h3>
                <button class="close-btn" onclick="hideSettings()">
                    <i class="material-icons">close</i>
                </button>
            </div>
            
            <div class="settings-body">
                <!-- Supabase Configuration Section -->
                <div class="settings-section">
                    <h4>Real-Time Chat Configuration</h4>
                    <div class="config-status-display" id="config-status-display">
                        <span class="status-dot offline"></span>
                        <span class="status-text">Not Configured</span>
                    </div>
                    
                    <!-- Connection Test Status -->
                    <div id="settings-connection-status" class="connection-status offline" style="margin: 10px 0;">
                        <i class="material-icons">wifi_off</i>
                        Connection Status: Not Tested
                    </div>
                    
                    <div class="form-group">
                        <label for="supabase-url">Supabase Project URL:</label>
                        <input type="text" id="supabase-url" placeholder="https://xxxxx.supabase.co" class="form-input">
                    </div>
                    <div class="form-group">
                        <label for="supabase-key">Supabase API Key (anon/public):</label>
                        <input type="password" id="supabase-key" placeholder="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9..." class="form-input">
                    </div>
                    <div class="config-actions">
                        <button class="action-btn success" onclick="saveSupabaseConfig()">
                            <i class="material-icons">save</i>Save Configuration
                        </button>
                        <button class="action-btn primary" onclick="testSupabaseConnection()">
                            <i class="material-icons">wifi</i>Test Connection
                        </button>
                        <button class="action-btn warning" onclick="clearSupabaseConfig()">
                            <i class="material-icons">clear</i>Clear Config
                        </button>
                    </div>
                </div>
                
                <!-- Display Mode Section -->
                <div class="settings-section">
                    <h4>Display Mode</h4>
                    <div class="mode-selector">
                        <div class="mode-option active" data-mode="tablet">Tablet</div>
                        <div class="mode-option" data-mode="highres">High Res</div>
                        <div class="mode-option" data-mode="ultra">Ultra</div>
                    </div>
                    <div class="device-info" id="device-info">
                        Standard Tablet Mode
                    </div>
                </div>
                
                <!-- Player URL Section -->
                <div class="settings-section">
                    <h4>Player Connection</h4>
                    <div class="url-section">
                        <label>Player Interface URL:</label>
                        <div class="url-display">
                            <input type="text" id="player-url" readonly class="url-input">
                            <button class="copy-btn" onclick="copyPlayerURL()">
                                <i class="material-icons">content_copy</i>
                            </button>
                        </div>
                        <p class="url-help">Share this URL with your players to let them join the session</p>
                    </div>
                </div>
                
                <!-- Session Settings -->
                <div class="settings-section">
                    <h4>Game Session</h4>
                    <div class="session-controls">
                        <div class="session-status" id="session-status">
                            <span class="status-dot offline"></span>
                            <span class="status-text">No active session</span>
                        </div>
                        <div class="session-form" id="session-form">
                            <div class="form-row">
                                <div class="form-group">
                                    <label for="storyteller-name">Your Name (Storyteller):</label>
                                    <input type="text" id="storyteller-name" placeholder="Enter your name" class="form-input">
                                    <!-- Hidden input for supabase compatibility -->
                                    <input type="hidden" id="dm-name-input">
                                </div>
                                <div class="form-group">
                                    <label for="new-session-code">Session Code:</label>
                                    <input type="text" id="new-session-code" placeholder="Enter session code" class="form-input">
                                    <!-- Hidden input for supabase compatibility -->
                                    <input type="hidden" id="session-code-input">
                                </div>
                            </div>
                            <button class="action-btn success" onclick="startNewGameSession()">
                                <i class="material-icons">play_arrow</i>Start Game Session
                            </button>
                        </div>
                        <!-- Hidden elements for supabase compatibility -->
                        <div id="chat-session-controls" style="display: none;"></div>
                        <div id="chat-messages-container" style="display: none;"></div>
                        <div id="current-session-code" style="display: none;"></div>
                        <div id="chat-status" style="display: none;"></div>
                        <div class="local-session-controls">
                            <button class="action-btn primary" onclick="showSessionManager()">
                                <i class="material-icons">folder</i>Local Sessions
                            </button>
                            <button class="action-btn warning" onclick="exportSession()">
                                <i class="material-icons">download</i>Export Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="desktop-container">
        <!-- Header -->
        <header class="app-header">
            <div class="app-title">
                <i class="ra ra-crystal-ball"></i>
                <span>Story Teller Tool</span>
            </div>
            
            <div class="session-info">
                <span>Session: <strong id="session-name-display">New Session</strong></span>
                <span>Players: <strong id="player-count">0</strong></span>
                <span>Storyteller: <strong>DM Brad</strong></span>
                <span id="connection-status" class="connection-status offline">
                    <i class="material-icons">wifi_off</i>
                    Offline
                </span>
            </div>
            
            <div class="header-controls">
                <button class="header-btn" onclick="saveSession()">
                    <i class="material-icons">save</i>
                    Save
                </button>
                <button class="header-btn" onclick="toggleTheme()">
                    <i class="material-icons">brightness_6</i>
                    Theme
                </button>
                <button class="header-btn" onclick="showSettings()">
                    <i class="material-icons">settings</i>
                    Settings
                </button>
            </div>
        </header>

        <!-- Tab Bar -->
        <div class="tab-bar">
            <div class="panel-dropdown">
                <button class="tab-selector" onclick="toggleDropdown('left-dropdown')">
                    <i class="material-icons">view_module</i>
                    Left Panel
                    <i class="material-icons">expand_more</i>
                </button>
                <div id="left-dropdown" class="dropdown-content">
                    <a class="dropdown-item" onclick="loadPanel('left', 'commands')">
                        <i class="ra ra-lightning-bolt"></i>Commands
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'npcs')">
                        <i class="ra ra-player"></i>NPCs
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'combat')">
                        <i class="ra ra-sword"></i>Combat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'items')">
                        <i class="ra ra-gem"></i>Items
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'map')">
                        <i class="ra ra-treasure-map"></i>Map
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'chat')">
                        <i class="material-icons">chat</i>Chat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'players')">
                        <i class="ra ra-player"></i>Players
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'quests')">
                        <i class="ra ra-scroll-unfurled"></i>Quests
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'notes')">
                        <i class="material-icons">note</i>Notes
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('left', 'dice')">
                        <i class="ra ra-dice-six"></i>Dice
                    </a>
                </div>
            </div>

            <div class="panel-dropdown">
                <button class="tab-selector" onclick="toggleDropdown('right-dropdown')">
                    <i class="material-icons">view_module</i>
                    Right Panel
                    <i class="material-icons">expand_more</i>
                </button>
                <div id="right-dropdown" class="dropdown-content">
                    <a class="dropdown-item" onclick="loadPanel('right', 'commands')">
                        <i class="ra ra-lightning-bolt"></i>Commands
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'npcs')">
                        <i class="ra ra-player"></i>NPCs
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'combat')">
                        <i class="ra ra-sword"></i>Combat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'items')">
                        <i class="ra ra-gem"></i>Items
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'map')">
                        <i class="ra ra-treasure-map"></i>Map
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'chat')">
                        <i class="material-icons">chat</i>Chat
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'players')">
                        <i class="ra ra-player"></i>Players
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'quests')">
                        <i class="ra ra-scroll-unfurled"></i>Quests
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'notes')">
                        <i class="material-icons">note</i>Notes
                    </a>
                    <a class="dropdown-item" onclick="loadPanel('right', 'dice')">
                        <i class="ra ra-dice-six"></i>Dice
                    </a>
                </div>
            </div>

            <button class="tab-selector" onclick="swapPanels()">
                <i class="material-icons">swap_horiz</i>
                Swap Panels
            </button>

            <button class="tab-selector" onclick="toggleSinglePanel()">
                <i class="material-icons">fullscreen</i>
                Single Panel
            </button>
        </div>

        <!-- Main Content Area -->
        <div class="content-area">
            <!-- Left Panel -->
            <div class="panel" id="left-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="ra ra-lightning-bolt"></i>
                        <span id="left-panel-title">Command Center</span>
                    </div>
                    <div class="panel-controls">
                        <button class="panel-btn" onclick="refreshPanel('left')" title="Refresh">
                            <i class="material-icons">refresh</i>
                        </button>
                        <button class="panel-btn" onclick="pinPanel('left')" title="Pin Panel">
                            <i class="material-icons">push_pin</i>
                        </button>
                    </div>
                </div>
                <div class="panel-content" id="left-panel-content">
                    <!-- Commands Interface -->
                    <div class="command-interface">
                        <div class="command-categories">
                            <!-- Loot Commands -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-gem"></i>
                                    Loot & Rewards
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn success" onclick="executeCommand('loot', 'handful_gold')">
                                            💰 Gold
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('loot', 'treasure_chest')">
                                            📦 Treasure
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('loot', 'magic_item')">
                                            ✨ Magic Item
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('loot', 'weapon')">
                                            ⚔️ Weapon
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Character Commands -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-player-lift"></i>
                                    Character Growth
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn" onclick="executeCommand('levelup')">
                                            ⬆️ Level Up
                                        </button>
                                        <button class="command-btn" onclick="executeCommand('achievement')">
                                            🏆 Achievement
                                        </button>
                                        <button class="command-btn" onclick="executeCommand('skill_train')">
                                            📚 Train Skill
                                        </button>
                                        <button class="command-btn" onclick="executeCommand('experience')">
                                            ⭐ Experience
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Health & Status -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-health"></i>
                                    Health & Status
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn success" onclick="executeCommand('heal')">
                                            🩹 Heal
                                        </button>
                                        <button class="command-btn danger" onclick="executeCommand('damage')">
                                            💥 Damage
                                        </button>
                                        <button class="command-btn warning" onclick="executeCommand('stat_boost')">
                                            📊 Stat Boost
                                        </button>
                                        <button class="command-btn warning" onclick="executeCommand('condition')">
                                            🔮 Condition
                                        </button>
                                    </div>
                                </div>
                            </div>

                            <!-- Quick Actions -->
                            <div class="command-category">
                                <div class="category-header">
                                    <i class="ra ra-lightning-bolt"></i>
                                    Quick Actions
                                </div>
                                <div class="category-content">
                                    <div class="command-grid">
                                        <button class="command-btn" onclick="executeCommand('rest')">
                                            😴 Rest
                                        </button>
                                        <button class="command-btn danger" onclick="executeCommand('murder_hobo')">
                                            💀 Murder Hobo
                                        </button>
                                        <button class="command-btn success" onclick="executeCommand('heroic_deed')">
                                            🦸 Heroic Deed
                                        </button>
                                        <button class="command-btn warning" onclick="executeCommand('catastrophe')">
                                            🌪️ Catastrophe
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Player Selector -->
                        <div class="player-selector">
                            <h4>Connected Players</h4>
                            <div class="player-list" id="player-list">
                                <div class="player-item" id="dm-player">
                                    <div class="player-name">Storyteller (You)</div>
                                    <div class="player-stats">Session Master</div>
                                </div>
                                <!-- Connected players will be populated here dynamically -->
                            </div>
                            <div class="no-players" id="no-players" style="display: none; padding: 15px; text-align: center; color: #666;">
                                No players connected yet. Share the player URL to invite players!
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Right Panel -->
            <div class="panel" id="right-panel">
                <div class="panel-header">
                    <div class="panel-title">
                        <i class="material-icons">chat</i>
                        <span id="right-panel-title">Chat & Communication</span>
                    </div>
                    <div class="panel-controls">
                        <button class="panel-btn" onclick="clearChat()" title="Clear Chat">
                            <i class="material-icons">clear</i>
                        </button>
                        <button class="panel-btn" onclick="exportChat()" title="Export Chat">
                            <i class="material-icons">download</i>
                        </button>
                    </div>
                </div>
                <div class="panel-content" id="right-panel-content">
                    <!-- Chat Interface -->
                    <div class="chat-interface">
                        <!-- Error message container for Supabase -->
                        <div id="chat-error-message" class="chat-error" style="display: none;"></div>
                        
                        <div class="chat-messages" id="chat-messages">
                            <div class="chat-message system">
                                <strong>System:</strong> Chat system ready. Start a session to begin messaging.
                            </div>
                        </div>
                        
                        <div class="chat-input-area">
                            <input type="text" class="chat-input" placeholder="Type your message or command..." id="chat-input">
                            <!-- Hidden input for supabase compatibility -->
                            <input type="hidden" id="chat-message-input">
                            <button class="send-btn" onclick="sendMessage()">Send</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    
    <!-- DCC Module System -->
    <script src="js/modules/dccMechanics.js"></script>
    <script src="js/modules/rollCalculator.js"></script>
    <script src="js/modules/jsonDataLoader.js"></script>
    <script src="js/modules/characterData.js"></script>
    <script src="js/modules/skillsManager.js"></script>
    <script src="js/modules/equipmentBonusSystem.js"></script>
    <script src="js/modules/chatCommandParser.js"></script>
    <script src="js/modules/dccUtilities.js"></script>
    <script src="js/modules/dccChatIntegration.js"></script>
    
    <!-- Chat System Modules -->
    <script src="js/modules/supabaseClient.js"></script>
    <script src="js/modules/chatParser.js"></script>
    <script src="js/modules/combatHandler.js"></script>
    <script src="js/modules/messageFormatter.js"></script>
    <script src="js/modules/chatManager.js"></script>
    <script src="js/modules/chatAdapter.js"></script>
    
    <!-- Command Processing (Non-invasive) -->
    <script src="js/command-interceptor.js"></script>
    
    <!-- Core Application -->
    <script src="js/main.js"></script>
    <script src="js/storage-manager.js"></script>
    <script src="js/npc-generator.js"></script>
    <script src="js/quest-generator.js"></script>
    <script src="js/item-generator.js"></script>
    <script src="js/map-editor.js"></script>
    <script src="js/combat-manager.js"></script>
    <script src="js/supabase-chat.js"></script>
    <script src="js/map-sharing.js"></script>
    <script src="js/player-data-parser.js"></script>
    <script src="js/supabase-config.js"></script>

    <script>
        let selectedPlayer = 'Storyteller'; // Default to storyteller
        let leftPanelContent = 'commands';
        let rightPanelContent = 'chat';
        let currentMode = 'tablet';
        let deviceInfo = {};

        // Device Detection and Mode Management
        function detectDevice() {
            const userAgent = navigator.userAgent;
            const screenWidth = window.screen.width;
            const screenHeight = window.screen.height;
            const pixelRatio = window.devicePixelRatio || 1;
            const dpi = Math.sqrt(screenWidth * screenWidth + screenHeight * screenHeight) / Math.sqrt(screenWidth / pixelRatio * screenWidth / pixelRatio + screenHeight / pixelRatio * screenHeight / pixelRatio) * pixelRatio;
            
            deviceInfo = {
                isOnePlusPad: userAgent.includes('OnePlus') || (screenWidth === 2800 && screenHeight === 2000),
                isHighRes: dpi >= 200 || pixelRatio >= 2,
                screenWidth: screenWidth,
                screenHeight: screenHeight,
                pixelRatio: pixelRatio,
                estimatedDPI: Math.round(dpi),
                userAgent: userAgent
            };

            // Auto-select best mode
            let recommendedMode = 'tablet';
            if (deviceInfo.isOnePlusPad) {
                recommendedMode = 'ultra';
            } else if (deviceInfo.isHighRes) {
                recommendedMode = 'highres';
            }

            // Update device info display
            updateDeviceInfo();
            
            // Auto-switch to recommended mode if it's better than current
            if (recommendedMode !== 'tablet' && currentMode === 'tablet') {
                switchMode(recommendedMode);
            }

            console.log('Device Detection:', deviceInfo);
            console.log('Recommended Mode:', recommendedMode);
        }

        function updateDeviceInfo() {
            const deviceInfoEl = document.getElementById('device-info');
            let infoText = '';
            
            if (deviceInfo.isOnePlusPad) {
                infoText = `OnePlus Pad Detected<br>${deviceInfo.screenWidth}×${deviceInfo.screenHeight}`;
            } else if (deviceInfo.isHighRes) {
                infoText = `High-DPI Display<br>~${deviceInfo.estimatedDPI} DPI`;
            } else {
                infoText = `Standard Display<br>${deviceInfo.screenWidth}×${deviceInfo.screenHeight}`;
            }
            
            deviceInfoEl.innerHTML = infoText;
        }

        function switchMode(mode) {
            if (mode === currentMode) return;
            
            currentMode = mode;
            
            // Remove all mode classes
            document.body.classList.remove('mode-tablet', 'mode-highres', 'mode-ultra');
            
            // Add new mode class
            document.body.classList.add(`mode-${mode}`);
            
            // Update mode selector
            document.querySelectorAll('.mode-option').forEach(option => {
                option.classList.remove('active');
                if (option.dataset.mode === mode) {
                    option.classList.add('active');
                }
            });
            
            // Add feedback message
            const modeNames = {
                'tablet': 'Standard Tablet Mode',
                'highres': 'High Resolution Mode',
                'ultra': 'Ultra Premium Mode'
            };
            
            addChatMessage(`Switched to ${modeNames[mode]}`, 'system');
            
            console.log(`Switched to mode: ${mode}`);
        }

        // Initialize mode selector and DCC systems
        document.addEventListener('DOMContentLoaded', function() {
            // Detect device on load
            detectDevice();
            
            // Initialize connection status
            updateConnectionStatus('Offline', 'offline');
            updateSettingsConnectionStatus('Not tested', 'offline');
            
            // Load Supabase configuration from browser storage
            const supabaseConfig = loadSupabaseConfig();
            
            if (supabaseConfig) {
                // Configuration found - attempt auto-connection
                addChatMessage('🔧 Supabase configuration found, testing connection...', 'system');
                
                // Wait a moment for modules to load, then test connection
                setTimeout(async () => {
                    try {
                        await testSupabaseConnection();
                    } catch (error) {
                        console.error('Auto-connection test failed:', error);
                        updateConnectionStatus('Auto-connect failed', 'error');
                    }
                }, 1000);
                
            } else {
                // No configuration found - open settings modal
                addChatMessage('⚙️ No Supabase configuration found. Opening settings...', 'system');
                setTimeout(() => {
                    showSettings();
                    addChatMessage('📝 Please configure Supabase settings to enable real-time chat', 'system');
                }, 1500);
            }
            
            // Setup mode selector
            document.querySelectorAll('.mode-option').forEach(option => {
                option.addEventListener('click', () => {
                    switchMode(option.dataset.mode);
                });
            });
            
            // Initialize DCC Chat Integration if modules are loaded
            if (typeof DCCChatIntegration !== 'undefined') {
                try {
                    window.dccChatIntegration = new DCCChatIntegration();
                    addChatMessage('DCC systems initialized successfully!', 'system');
                } catch (error) {
                    console.error('DCC initialization error:', error);
                    addChatMessage('DCC systems initialization failed - using fallback mode', 'system');
                }
            } else {
                addChatMessage('DCC modules not loaded - using simulation mode', 'system');
            }
            
            // Initialize panels with default content
            // Only initialize right panel - left panel has rich static content
            loadPanel('right', rightPanelContent);
            
            // Update left panel title to match the content
            document.getElementById('left-panel-title').textContent = getPanelTitle(leftPanelContent);
        });

        // Toggle mode panel
        function toggleModePanel() {
            const toggle = document.getElementById('mode-toggle');
            toggle.classList.toggle('collapsed');
        }

        // Panel and UI Functions
        function toggleDropdown(dropdownId) {
            const dropdown = document.getElementById(dropdownId);
            dropdown.classList.toggle('show');
            
            // Close other dropdowns
            document.querySelectorAll('.dropdown-content').forEach(el => {
                if (el.id !== dropdownId) {
                    el.classList.remove('show');
                }
            });
        }

        function loadPanel(panel, content) {
            console.log(`Loading ${content} in ${panel} panel`);
            
            if (panel === 'left') {
                leftPanelContent = content;
                document.getElementById('left-panel-title').textContent = getPanelTitle(content);
                document.getElementById('left-panel-content').innerHTML = getPanelContent(content);
            } else {
                rightPanelContent = content;
                document.getElementById('right-panel-title').textContent = getPanelTitle(content);
                document.getElementById('right-panel-content').innerHTML = getPanelContent(content);
            }
            
            // Close dropdowns
            document.querySelectorAll('.dropdown-content').forEach(el => {
                el.classList.remove('show');
            });
            
            // Load chat history if chat panel is loaded
            if (content === 'chat') {
                setTimeout(() => {
                    if (window.loadRecentChatHistory) {
                        window.loadRecentChatHistory();
                    } else {
                        // If no chat history function, just reset the container
                        resetChatContainer();
                    }
                }, 100); // Small delay to ensure DOM is ready
            }
            
            addChatMessage(`${getPanelTitle(content)} loaded in ${panel} panel`, 'system');
        }

        function getPanelTitle(content) {
            const titles = {
                'commands': 'Command Center',
                'npcs': 'NPC Manager',
                'combat': 'Combat Tracker',
                'items': 'Item Generator',
                'map': 'Map Editor',
                'chat': 'Chat & Communication',
                'players': 'Player Management',
                'quests': 'Quest Tracker',
                'notes': 'Session Notes',
                'dice': 'Dice Roller'
            };
            return titles[content] || content;
        }

        function getPanelContent(content) {
            switch (content) {
                case 'commands':
                    return `
                        <!-- Commands Interface -->
                        <div class="command-interface">
                            <div class="command-categories">
                                <!-- Loot Commands -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-gem"></i>
                                        Loot & Rewards
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn success" onclick="executeCommand('loot', 'handful_gold')">
                                                💰 Gold
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('loot', 'treasure_chest')">
                                                📦 Treasure
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('loot', 'magic_item')">
                                                ✨ Magic Item
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('loot', 'weapon')">
                                                ⚔️ Weapon
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Character Commands -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-player-lift"></i>
                                        Character Growth
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn" onclick="executeCommand('levelup')">
                                                ⬆️ Level Up
                                            </button>
                                            <button class="command-btn" onclick="executeCommand('achievement')">
                                                🏆 Achievement
                                            </button>
                                            <button class="command-btn" onclick="executeCommand('skill_train')">
                                                📚 Train Skill
                                            </button>
                                            <button class="command-btn" onclick="executeCommand('experience')">
                                                ⭐ Experience
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Health & Status -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-health"></i>
                                        Health & Status
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn success" onclick="executeCommand('heal')">
                                                🩹 Heal
                                            </button>
                                            <button class="command-btn danger" onclick="executeCommand('damage')">
                                                💥 Damage
                                            </button>
                                            <button class="command-btn warning" onclick="executeCommand('stat_boost')">
                                                📊 Stat Boost
                                            </button>
                                            <button class="command-btn warning" onclick="executeCommand('condition')">
                                                🔮 Condition
                                            </button>
                                        </div>
                                    </div>
                                </div>

                                <!-- Quick Actions -->
                                <div class="command-category">
                                    <div class="category-header">
                                        <i class="ra ra-lightning-bolt"></i>
                                        Quick Actions
                                    </div>
                                    <div class="category-content">
                                        <div class="command-grid">
                                            <button class="command-btn" onclick="executeCommand('rest')">
                                                😴 Rest
                                            </button>
                                            <button class="command-btn danger" onclick="executeCommand('murder_hobo')">
                                                💀 Murder Hobo
                                            </button>
                                            <button class="command-btn success" onclick="executeCommand('heroic_deed')">
                                                🦸 Heroic Deed
                                            </button>
                                            <button class="command-btn warning" onclick="executeCommand('catastrophe')">
                                                🌪️ Catastrophe
                                            </button>
                                        </div>
                                    </div>
                                </div>
                            </div>

                            <!-- Player Selector -->
                            <div class="player-selector">
                                <h4>Connected Players</h4>
                                <div class="player-list" id="player-list">
                                    <div class="player-item" id="dm-player">
                                        <div class="player-name">Storyteller (You)</div>
                                        <div class="player-stats">Session Master</div>
                                    </div>
                                    <!-- Connected players will be populated here dynamically -->
                                </div>
                                <div class="no-players" id="no-players" style="display: none; padding: 15px; text-align: center; color: #666;">
                                    No players connected yet. Share the player URL to invite players!
                                </div>
                            </div>
                        </div>
                    `;
                
                case 'npcs':
                    return `
                        <div class="npc-generator">
                            <h4>NPC Generator</h4>
                            <div class="generator-controls">
                                <select id="npc-type" class="form-select">
                                    <option value="friendly">Friendly NPC</option>
                                    <option value="merchant">Merchant</option>
                                    <option value="guard">Guard</option>
                                    <option value="noble">Noble</option>
                                </select>
                                <button class="action-btn primary" onclick="generateNPC()">
                                    <i class="ra ra-dice"></i>Generate NPC
                                </button>
                            </div>
                            <div id="generated-npc-display" class="npc-display">
                                <p class="placeholder-text">Click "Generate NPC" to create a random character</p>
                            </div>
                        </div>
                    `;
                
                case 'combat':
                    return `
                        <div class="combat-tracker">
                            <h4>Combat Management</h4>
                            <div class="combat-controls">
                                <button class="action-btn success" onclick="startCombat()">
                                    <i class="ra ra-sword"></i>Start Combat
                                </button>
                                <button class="action-btn warning" onclick="nextTurn()">
                                    <i class="ra ra-cycle"></i>Next Turn
                                </button>
                                <button class="action-btn danger" onclick="endCombat()">
                                    <i class="ra ra-shield"></i>End Combat
                                </button>
                            </div>
                            <div id="combat-status" class="combat-status">
                                <p>No active combat</p>
                            </div>
                        </div>
                    `;
                
                case 'items':
                    return `
                        <div class="item-generator">
                            <h4>Item Generator</h4>
                            <div class="generator-controls">
                                <select id="item-type" class="form-select">
                                    <option value="weapon">Weapon</option>
                                    <option value="armor">Armor</option>
                                    <option value="treasure">Treasure</option>
                                    <option value="potion">Potion</option>
                                </select>
                                <button class="action-btn primary" onclick="generateItem()">
                                    <i class="ra ra-gem"></i>Generate Item
                                </button>
                            </div>
                            <div id="generated-item-display" class="item-display">
                                <p class="placeholder-text">Click "Generate Item" to create loot</p>
                            </div>
                        </div>
                    `;
                
                case 'map':
                    return `
                        <div class="map-editor">
                            <h4>Map Tools</h4>
                            <div class="map-controls">
                                <select id="map-size" class="form-select">
                                    <option value="small">Small (10x10)</option>
                                    <option value="medium">Medium (15x15)</option>
                                    <option value="large">Large (20x20)</option>
                                </select>
                                <button class="action-btn primary" onclick="createMap()">
                                    <i class="ra ra-map"></i>New Map
                                </button>
                            </div>
                            <div class="map-display">
                                <p class="placeholder-text">Map editor tools</p>
                            </div>
                        </div>
                    `;
                
                case 'chat':
                    return `
                        <div class="chat-interface">
                            <!-- Error message container for Supabase -->
                            <div id="chat-error-message" class="chat-error" style="display: none;"></div>
                            
                            <div class="chat-messages" id="chat-messages">
                                <div class="chat-message system">
                                    <strong>System:</strong> Chat system ready. Start a session to begin messaging.
                                </div>
                            </div>
                            
                            <div class="chat-input-area">
                                <input type="text" class="chat-input" placeholder="Type your message or command..." id="chat-input">
                                <!-- Hidden input for supabase compatibility -->
                                <input type="hidden" id="chat-message-input">
                                <button class="send-btn" onclick="sendMessage()">Send</button>
                            </div>
                        </div>
                    `;
                
                case 'players':
                    return `
                        <div class="player-manager">
                            <h4>Connected Players</h4>
                            <div id="player-list" class="player-list">
                                <div class="player-item">
                                    <div class="player-info">
                                        <span class="player-name">Waiting for players...</span>
                                        <span class="player-status offline">Offline</span>
                                    </div>
                                </div>
                            </div>
                            <div class="player-actions">
                                <button class="action-btn info" onclick="showSettings()">
                                    <i class="material-icons">link</i>Get Player URL
                                </button>
                            </div>
                        </div>
                    `;
                
                case 'quests':
                    return `
                        <div class="quest-tracker">
                            <h4>Active Quests</h4>
                            <div class="quest-controls">
                                <button class="action-btn primary" onclick="addQuest()">
                                    <i class="ra ra-scroll-unfurled"></i>Add Quest
                                </button>
                            </div>
                            <div id="quest-list" class="quest-list">
                                <p class="placeholder-text">No active quests</p>
                            </div>
                        </div>
                    `;
                
                case 'notes':
                    return `
                        <div class="notes-panel">
                            <h4>Session Notes</h4>
                            <div class="notes-controls">
                                <button class="action-btn primary" onclick="saveNotes()">
                                    <i class="material-icons">save</i>Save Notes
                                </button>
                            </div>
                            <textarea id="session-notes" class="session-notes" placeholder="Write your session notes here..."></textarea>
                        </div>
                    `;
                
                case 'dice':
                    return `
                        <div class="dice-roller">
                            <h4>Dice Roller</h4>
                            <div class="dice-controls">
                                <button class="dice-btn" onclick="rollDice('d4')">d4</button>
                                <button class="dice-btn" onclick="rollDice('d6')">d6</button>
                                <button class="dice-btn" onclick="rollDice('d8')">d8</button>
                                <button class="dice-btn" onclick="rollDice('d10')">d10</button>
                                <button class="dice-btn" onclick="rollDice('d12')">d12</button>
                                <button class="dice-btn" onclick="rollDice('d20')">d20</button>
                                <button class="dice-btn" onclick="rollDice('d100')">d100</button>
                            </div>
                            <div id="dice-results" class="dice-results">
                                <p class="placeholder-text">Click a die to roll</p>
                            </div>
                        </div>
                    `;
                
                default:
                    return `<p>Content for ${content} panel coming soon...</p>`;
            }
        }

        function selectPlayer(playerName) {
            selectedPlayer = playerName;
            
            // Update UI
            document.querySelectorAll('.player-item').forEach(el => {
                el.classList.remove('selected');
            });
            event.target.closest('.player-item').classList.add('selected');
            
            addChatMessage(`Selected player: ${playerName}`, 'system');
        }

        function executeCommand(command, parameter = '') {
            if (!selectedPlayer) {
                addChatMessage('Please select a player first!', 'system');
                return;
            }
            
            let commandText = '';
            let emoji = '';
            
            switch(command) {
                case 'loot':
                    commandText = `LOOT:${selectedPlayer}:${parameter}`;
                    emoji = '💰';
                    break;
                case 'levelup':
                    commandText = `LEVELUP:${selectedPlayer}`;
                    emoji = '⬆️';
                    break;
                case 'achievement':
                    commandText = `ACHIEVEMENT:${selectedPlayer}:creative_killer`;
                    emoji = '🏆';
                    break;
                case 'heal':
                    commandText = `HEALTH:${selectedPlayer}:15`;
                    emoji = '🩹';
                    break;
                case 'damage':
                    commandText = `HEALTH:${selectedPlayer}:-10`;
                    emoji = '💥';
                    break;
                case 'murder_hobo':
                    commandText = `ACHIEVEMENT:${selectedPlayer}:murder_hobo`;
                    emoji = '💀';
                    break;
                case 'skill_train':
                    commandText = `SKILL:${selectedPlayer}:Powerful Strike:100`;
                    emoji = '📚';
                    break;
                case 'experience':
                    commandText = `EXP:${selectedPlayer}:50`;
                    emoji = '⭐';
                    break;
                case 'stat_boost':
                    commandText = `STAT:${selectedPlayer}:strength:1`;
                    emoji = '📊';
                    break;
                case 'heroic_deed':
                    commandText = `ACHIEVEMENT:${selectedPlayer}:heroic_deed`;
                    emoji = '🦸';
                    break;
                default:
                    commandText = `${command.toUpperCase()}:${selectedPlayer}`;
                    emoji = '⚡';
            }
            
            // Send command through the chat system (if connected)
            if (typeof sendChatMessageAsync === 'function') {
                try {
                    sendChatMessageAsync(commandText);
                    console.log(`🎮 Command Center executed: ${commandText}`);
                } catch (error) {
                    console.error('Command execution error:', error);
                    addChatMessage(`❌ Command failed: ${error.message}`, 'system');
                }
            } else {
                // Fallback if chat system not ready
                addChatMessage(`⚠️ Chat system not connected. Command would be: ${commandText}`, 'system');
            }
        }

        function addChatMessage(message, type = 'storyteller', playerName = 'Storyteller') {
            const chatMessages = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${type}`;
            
            if (type === 'system') {
                messageEl.innerHTML = `<strong>System:</strong> ${message}`;
            } else if (type === 'player') {
                messageEl.innerHTML = `<strong>${playerName}:</strong> ${message}`;
            } else {
                messageEl.innerHTML = `<strong>${playerName}:</strong> ${message}`;
            }
            
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Debounced reset for rapid message additions
            clearTimeout(window.chatResetTimeout);
            window.chatResetTimeout = setTimeout(() => {
                resetChatContainer();
            }, 500); // Reset after 500ms of no new messages
        }

        // Reset chat container dimensions after dynamic content changes
        function resetChatContainer() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                // Force recalculation of container dimensions
                chatMessages.style.height = '';
                chatMessages.style.minHeight = '';
                
                // Use requestAnimationFrame to ensure DOM updates are complete
                requestAnimationFrame(() => {
                    chatMessages.style.height = '100%';
                    chatMessages.style.minHeight = '0';
                    
                    // Scroll to bottom after reset
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                    
                    console.log('💬 Chat container dimensions reset');
                });
            }
        }

        // Enhanced sendMessage function using real-time chat
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (!message) return;
            
            // Check if we have an active session
            if (!window.currentGameSession) {
                addChatMessage('❌ No active session. Please start a session first.', 'system');
                return;
            }
            
            try {
                // Send via Supabase real-time system ONLY - don't add locally
                if (window.sendChatMessageAsync && typeof window.sendChatMessageAsync === 'function') {
                    await window.sendChatMessageAsync(message);
                    console.log('✅ Message sent via Supabase real-time - waiting for echo');
                    
                    // Clear input only after successful send
                    input.value = '';
                    
                } else if (window.sendChatMessage && typeof window.sendChatMessage === 'function') {
                    // Fallback to sync method
                    window.sendChatMessage(message);
                    input.value = '';
                    console.log('✅ Message sent via Supabase sync - waiting for echo');
                    
                } else {
                    // No Supabase connection available
                    addChatMessage('❌ Real-time chat not available. Please check Supabase connection.', 'system');
                }
                
            } catch (error) {
                console.error('❌ Message send error:', error);
                addChatMessage(`❌ Failed to send message: ${error.message}`, 'system');
            }
        }
        
        // Function to update connected players list
        function updateConnectedPlayers(players = []) {
            const playerList = document.getElementById('player-list');
            const noPlayersDiv = document.getElementById('no-players');
            
            if (!playerList) return;
            
            // Clear existing players (except DM)
            const dmPlayer = document.getElementById('dm-player');
            playerList.innerHTML = '';
            if (dmPlayer) {
                playerList.appendChild(dmPlayer);
            }
            
            // Add connected players
            players.forEach(player => {
                if (player.name && player.name !== 'System' && !player.is_storyteller) {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-item';
                    playerDiv.onclick = () => selectPlayer(player.name);
                    
                    playerDiv.innerHTML = `
                        <div class="player-name">${player.name}</div>
                        <div class="player-stats">Connected Player</div>
                    `;
                    
                    playerList.appendChild(playerDiv);
                }
            });
            
            // Show/hide no players message
            const hasPlayers = players.length > 0;
            if (noPlayersDiv) {
                noPlayersDiv.style.display = hasPlayers ? 'none' : 'block';
            }
        }

        function swapPanels() {
            const temp = leftPanelContent;
            leftPanelContent = rightPanelContent;
            rightPanelContent = temp;
            
            document.getElementById('left-panel-title').textContent = getPanelTitle(leftPanelContent);
            document.getElementById('right-panel-title').textContent = getPanelTitle(rightPanelContent);
            
            addChatMessage('Panels swapped!', 'system');
        }

        function toggleSinglePanel() {
            const contentArea = document.querySelector('.content-area');
            contentArea.style.gridTemplateColumns = 
                contentArea.style.gridTemplateColumns === '1fr' ? '1fr 1fr' : '1fr';
        }

        function clearChat() {
            document.getElementById('chat-messages').innerHTML = '';
            addChatMessage('Chat cleared.', 'system');
        }

        function saveSession() {
            addChatMessage('Session saved!', 'system');
        }

        function showSettings() {
            // Update player URL with proper session information
            let playerURL = 'Not available - Start a session first';
            
            // Check if we have an active game session
            if (window.currentGameSession && window.currentGameSession.session_code) {
                // Generate Supabase URL + session for players to copy/paste
                const config = loadSupabaseConfig();
                if (config && config.url) {
                    playerURL = `${config.url}?session=${window.currentGameSession.session_code}`;
                } else {
                    playerURL = 'Supabase not configured - please set up Supabase settings first';
                }
            } else if (window.currentSession && window.currentSession.name !== 'New Session') {
                // Fallback to local session for testing
                playerURL = 'Local session - no Supabase URL available';
            }
            
            document.getElementById('player-url').value = playerURL;
            
            // Show modal
            document.getElementById('settings-modal').style.display = 'flex';
        }

        function hideSettings() {
            document.getElementById('settings-modal').style.display = 'none';
        }

        // Supabase Configuration Functions
        function loadSupabaseConfig() {
            try {
                const config = localStorage.getItem('storyteller-supabase-config');
                if (config) {
                    const parsedConfig = JSON.parse(config);
                    document.getElementById('supabase-url').value = parsedConfig.url || '';
                    document.getElementById('supabase-key').value = parsedConfig.key || '';
                    
                    // Update status display
                    const statusDisplay = document.getElementById('config-status-display');
                    if (statusDisplay) {
                        statusDisplay.innerHTML = `
                            <span class="status-dot connected"></span>
                            <span class="status-text">Configuration Loaded</span>
                        `;
                    }
                    
                    console.log('✅ Supabase configuration loaded from browser storage');
                    return parsedConfig;
                }
            } catch (error) {
                console.error('Error loading Supabase config:', error);
            }
            return null;
        }

        function saveSupabaseConfig() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                updateSettingsConnectionStatus('Please fill in both URL and API key', 'error');
                return false;
            }
            
            try {
                const config = { url, key, savedAt: new Date().toISOString() };
                localStorage.setItem('storyteller-supabase-config', JSON.stringify(config));
                
                // Update status display
                const statusDisplay = document.getElementById('config-status-display');
                if (statusDisplay) {
                    statusDisplay.innerHTML = `
                        <span class="status-dot connected"></span>
                        <span class="status-text">Configuration Saved</span>
                    `;
                }
                
                updateSettingsConnectionStatus('Configuration saved successfully', 'success');
                addChatMessage('✅ Supabase configuration saved!', 'system');
                console.log('✅ Supabase configuration saved to browser storage');
                return true;
            } catch (error) {
                console.error('Error saving Supabase config:', error);
                updateSettingsConnectionStatus('Failed to save configuration', 'error');
                return false;
            }
        }

        function clearSupabaseConfig() {
            try {
                localStorage.removeItem('storyteller-supabase-config');
                document.getElementById('supabase-url').value = '';
                document.getElementById('supabase-key').value = '';
                
                // Update status displays
                const statusDisplay = document.getElementById('config-status-display');
                if (statusDisplay) {
                    statusDisplay.innerHTML = `
                        <span class="status-dot offline"></span>
                        <span class="status-text">Not Configured</span>
                    `;
                }
                
                updateSettingsConnectionStatus('Configuration cleared', 'warning');
                updateConnectionStatus('Offline', 'offline');
                addChatMessage('🧹 Supabase configuration cleared', 'system');
                console.log('🧹 Supabase configuration cleared');
            } catch (error) {
                console.error('Error clearing Supabase config:', error);
            }
        }

        async function testSupabaseConnection() {
            const url = document.getElementById('supabase-url').value.trim();
            const key = document.getElementById('supabase-key').value.trim();
            
            if (!url || !key) {
                updateSettingsConnectionStatus('Please fill in both URL and API key', 'error');
                return;
            }
            
            updateSettingsConnectionStatus('Testing connection...', 'warning');
            
            try {
                // Test the connection using the same method as fullSupabaseConnect
                if (typeof window.testSupabaseCredentials === 'function') {
                    const result = await window.testSupabaseCredentials(url, key);
                    
                    if (result.success) {
                        updateSettingsConnectionStatus('Connection successful!', 'success');
                        updateConnectionStatus('Connection Test Passed', 'success');
                        addChatMessage('✅ Supabase connection test successful!', 'system');
                    } else {
                        updateSettingsConnectionStatus(`Connection failed: ${result.error}`, 'error');
                        updateConnectionStatus('Connection Test Failed', 'error');
                        addChatMessage(`❌ Supabase connection test failed: ${result.error}`, 'system');
                    }
                } else {
                    // Fallback: basic URL validation and attempt to load Supabase
                    if (!url.includes('supabase.co') && !url.includes('localhost')) {
                        throw new Error('Invalid Supabase URL format');
                    }
                    
                    // Basic test: try to create a Supabase client
                    const testClient = window.supabase.createClient(url, key);
                    
                    // Test a simple auth operation
                    const { data, error } = await testClient.auth.getSession();
                    
                    if (error && error.message.includes('API key')) {
                        throw new Error('Invalid API key');
                    }
                    
                    updateSettingsConnectionStatus('Basic connection test passed', 'success');
                    updateConnectionStatus('Connection Test Passed', 'success');
                    addChatMessage('✅ Basic Supabase connection test passed!', 'system');
                }
                
            } catch (error) {
                console.error('Connection test error:', error);
                updateSettingsConnectionStatus(`Test failed: ${error.message}`, 'error');
                updateConnectionStatus('Connection Test Failed', 'error');
                addChatMessage(`❌ Connection test failed: ${error.message}`, 'system');
            }
        }

        function updateSettingsConnectionStatus(message, type = 'info') {
            const settingsStatus = document.getElementById('settings-connection-status');
            if (settingsStatus) {
                settingsStatus.className = `connection-status ${type}`;
                
                let icon = 'wifi_off';
                switch (type) {
                    case 'success':
                        icon = 'wifi';
                        break;
                    case 'warning':
                        icon = 'sync';
                        break;
                    case 'error':
                        icon = 'wifi_off';
                        break;
                    default:
                        icon = 'help_outline';
                        break;
                }
                
                settingsStatus.innerHTML = `
                    <i class="material-icons">${icon}</i>
                    ${message}
                `;
            }
        }

        function copyPlayerURL() {
            const urlInput = document.getElementById('player-url');
            urlInput.select();
            urlInput.setSelectionRange(0, 99999); // For mobile devices
            navigator.clipboard.writeText(urlInput.value);
            
            addChatMessage('🔗 Player URL copied to clipboard!', 'system');
        }

        // Panel Content Functions
        function generateNPC() {
            const npcTypes = ['friendly merchant', 'gruff guard', 'wise elder', 'mysterious stranger'];
            const randomNPC = npcTypes[Math.floor(Math.random() * npcTypes.length)];
            
            const display = document.getElementById('generated-npc-display');
            if (display) {
                display.innerHTML = `<div class="generated-content">
                    <h5>Generated NPC</h5>
                    <p><strong>Type:</strong> ${randomNPC}</p>
                    <p><strong>Name:</strong> ${generateRandomName()}</p>
                    <p><strong>Mood:</strong> ${generateRandomMood()}</p>
                </div>`;
            }
            addChatMessage(`🎭 Generated NPC: ${randomNPC}`, 'system');
        }

        function generateRandomName() {
            const names = ['Aldric', 'Brenna', 'Caelum', 'Dara', 'Ewan', 'Fiona', 'Gareth', 'Hilda'];
            return names[Math.floor(Math.random() * names.length)];
        }

        function generateRandomMood() {
            const moods = ['friendly', 'suspicious', 'helpful', 'grumpy', 'excited', 'worried'];
            return moods[Math.floor(Math.random() * moods.length)];
        }

        function sendChatMessage() {
            const input = document.getElementById('chat-input');
            if (input && input.value.trim()) {
                addChatMessage(input.value, 'storyteller');
                input.value = '';
            }
        }

        // Additional panel functions
        function generateItem() {
            const itemTypes = ['Magic Sword', 'Health Potion', 'Gold Coins', 'Ancient Scroll'];
            const randomItem = itemTypes[Math.floor(Math.random() * itemTypes.length)];
            
            const display = document.getElementById('generated-item-display');
            if (display) {
                display.innerHTML = `<div class="generated-content">
                    <h5>Generated Item</h5>
                    <p><strong>Item:</strong> ${randomItem}</p>
                    <p><strong>Value:</strong> ${Math.floor(Math.random() * 100) + 10} gold</p>
                </div>`;
            }
            addChatMessage(`💎 Generated Item: ${randomItem}`, 'system');
        }

        function startCombat() {
            addChatMessage('⚔️ Combat started!', 'system');
            const status = document.getElementById('combat-status');
            if (status) {
                status.innerHTML = '<p><strong>Combat Round 1</strong><br>Initiative order determined</p>';
            }
        }

        function nextTurn() {
            addChatMessage('🔄 Next turn...', 'system');
        }

        function endCombat() {
            addChatMessage('🛡️ Combat ended!', 'system');
            const status = document.getElementById('combat-status');
            if (status) {
                status.innerHTML = '<p>No active combat</p>';
            }
        }

        function createMap() {
            addChatMessage('🗺️ New map created!', 'system');
        }

        function addQuest() {
            addChatMessage('📜 New quest added!', 'system');
            const questList = document.getElementById('quest-list');
            if (questList) {
                questList.innerHTML = '<div class="quest-item"><h5>Find the Lost Artifact</h5><p>Status: Active</p></div>';
            }
        }

        function saveNotes() {
            const notes = document.getElementById('session-notes');
            if (notes && notes.value.trim()) {
                addChatMessage('📝 Session notes saved!', 'system');
            }
        }

        function rollDice(diceType) {
            const sides = parseInt(diceType.replace('d', ''));
            const result = Math.floor(Math.random() * sides) + 1;
            
            addChatMessage(`🎲 Rolled ${diceType}: ${result}`, 'system');
            
            const results = document.getElementById('dice-results');
            if (results) {
                results.innerHTML = `<div class="dice-result">
                    <h5>${diceType} Roll</h5>
                    <div class="result-number">${result}</div>
                </div>`;
            }
        }

        // Game Session Functions - Enhanced with fullSupabaseConnect
        async function startNewGameSession() {
            const storytellerName = document.getElementById('storyteller-name').value.trim();
            const sessionCode = document.getElementById('new-session-code').value.trim();
            
            if (!storytellerName) {
                addChatMessage('❌ Please enter your name first', 'system');
                return;
            }
            
            if (!sessionCode) {
                addChatMessage('❌ Please enter a session code', 'system');
                return;
            }
            
            // Load saved Supabase config if available
            const savedConfig = loadSupabaseConfig();
            if (!savedConfig) {
                addChatMessage('❌ No Supabase configuration found. Please configure in Settings first.', 'system');
                showSettings();
                return;
            }
            
            // Show connecting status
            updateConnectionStatus('Connecting to Supabase...', 'warning');
            addChatMessage('🔌 Connecting to real-time chat system...', 'system');
            
            try {
                // Use the new fullSupabaseConnect method with saved configuration
                if (typeof window.fullSupabaseConnect === 'function') {
                    const result = await window.fullSupabaseConnect(storytellerName, sessionCode, true, 'create');
                    
                if (result.success) {
                    // Success! Update UI
                    updateConnectionStatus('Connected & Ready', 'success');
                    
                    // Check if we created or joined the session
                    if (result.sessionInfo && result.sessionInfo.mode === 'create') {
                        addChatMessage(`✅ Session "${sessionCode}" created successfully!`, 'system');
                    } else {
                        addChatMessage(`✅ Joined existing session "${sessionCode}" successfully!`, 'system');
                        addChatMessage(`ℹ️ This session already existed, so you joined it instead`, 'system');
                    }
                    
                    addChatMessage(`🎯 You are the Storyteller for this session`, 'system');
                    addChatMessage(`📡 Real-time chat active - players can now join`, 'system');
                    
                    // Sync with hidden compatibility fields
                    document.getElementById('dm-name-input').value = storytellerName;
                    document.getElementById('session-code-input').value = sessionCode;
                    
                    // Store session information globally with proper structure
                    window.currentGameSession = {
                        session_code: sessionCode,  // Use snake_case for compatibility
                        sessionCode: sessionCode,   // Also keep camelCase from result
                        dm_name: storytellerName,
                        playerName: storytellerName,
                        isStoryteller: true,
                        isStoryTeller: true, // Fix naming inconsistency
                        mode: 'create',
                        ...result.sessionInfo  // Include any additional info from Supabase
                    };
                    
                    // Update player URL immediately with Supabase URL + session
                    const savedConfig = loadSupabaseConfig();
                    let playerURL = 'Supabase not configured';
                    if (savedConfig && savedConfig.url) {
                        playerURL = `${savedConfig.url}?session=${sessionCode}`;
                    }
                    const playerUrlInput = document.getElementById('player-url');
                    if (playerUrlInput) {
                        playerUrlInput.value = playerURL;
                    }
                    addChatMessage(`🔗 Player URL ready - check Settings to share with players`, 'system');
                    
                    // Update session status
                        const statusElement = document.getElementById('session-status');
                        if (statusElement) {
                            statusElement.innerHTML = `
                                <span class="status-dot connected"></span>
                                <span class="status-text">Session: ${sessionCode} (Connected)</span>
                            `;
                        }
                        
                        // Hide form, show session controls
                        const sessionForm = document.getElementById('session-form');
                        if (sessionForm) {
                            sessionForm.style.display = 'none';
                        }
                        
                        // Enable chat input
                        const chatInput = document.getElementById('chat-input');
                        if (chatInput) {
                            chatInput.disabled = false;
                            chatInput.placeholder = 'Type your message...';
                        }
                        
                        // Update session name in header
                        const sessionNameDisplay = document.getElementById('session-name-display');
                        if (sessionNameDisplay) {
                            sessionNameDisplay.textContent = sessionCode;
                        }
                        
                    } else {
                        throw new Error(result.error || 'Connection failed');
                    }
                } else {
                    throw new Error('fullSupabaseConnect function not available');
                }
                
            } catch (error) {
                console.error('Session creation error:', error);
                
                // Check if it's a schema-related error and provide helpful message
                if (error.message.includes('is_active') || error.message.includes('schema cache')) {
                    updateConnectionStatus('Database Schema Error', 'error');
                    addChatMessage(`❌ Database schema issue: ${error.message}`, 'system');
                    addChatMessage(`💡 Please check your Supabase database setup - 'is_active' column may be missing`, 'system');
                } else {
                    updateConnectionStatus('Connection Error', 'error');
                    addChatMessage(`❌ Connection error: ${error.message}`, 'system');
                }
                
                addChatMessage(`🎮 Starting in local mode...`, 'system');
                
                // Start local session as fallback
                startLocalSession(storytellerName, sessionCode);
            }
        }

        // Helper function for local session start
        function startLocalSession(storytellerName, sessionCode) {
            // Hide session form
            const sessionForm = document.getElementById('session-form');
            if (sessionForm) {
                sessionForm.style.display = 'none';
            }
            
            // Set global variables for compatibility
            window.playerName = storytellerName;
            window.isStoryteller = true;
            window.isStoryTeller = true; // Fix naming inconsistency
            
            // Set connection status to offline
            updateConnectionStatus('Offline', 'offline');
            addChatMessage(`🎮 Session "${sessionCode}" started in local mode.`, 'system');
            addChatMessage(`👑 ${storytellerName} is the Storyteller`, 'system');
            addChatMessage('🔗 Player URL updated - check Settings to share', 'system');
            
            // Update player count
            const playerCount = document.getElementById('player-count');
            if (playerCount) {
                playerCount.textContent = '1'; // Storyteller counts as 1
            }
            
            // Update session name display
            const sessionDisplay = document.getElementById('session-name-display');
            if (sessionDisplay) {
                sessionDisplay.textContent = sessionCode;
            }
        }

        // Helper function to update connection status UI
        function updateConnectionStatus(message, type = 'info') {
            const connectionStatus = document.getElementById('connection-status');
            if (connectionStatus) {
                // Update the class to use connection-status with proper type
                connectionStatus.className = `connection-status ${type}`;
                
                // Update the icon based on status
                let icon = 'wifi_off';
                switch (type) {
                    case 'success':
                        icon = 'wifi';
                        break;
                    case 'warning':
                        icon = 'sync';
                        break;
                    case 'error':
                        icon = 'wifi_off';
                        break;
                    case 'offline':
                    default:
                        icon = 'wifi_off';
                        break;
                }
                
                // Update content with icon and message
                connectionStatus.innerHTML = `
                    <i class="material-icons">${icon}</i>
                    ${message}
                `;
            }
            
            console.log(`🔄 Connection Status: ${message}`);
        }

        function toggleTheme() {
            addChatMessage('Theme toggled!', 'system');
        }

        // Event Listeners
        document.getElementById('chat-input').addEventListener('keypress', function(e) {
            if (e.key === 'Enter') {
                sendMessage();
            }
        });

        // Close dropdowns when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.panel-dropdown')) {
                document.querySelectorAll('.dropdown-content').forEach(el => {
                    el.classList.remove('show');
                });
            }
        });

        // Window resize handler
        window.addEventListener('resize', function() {
            detectDevice();
        });

        // Chat functionality: Enter key support
        document.addEventListener('DOMContentLoaded', function() {
            const chatInput = document.getElementById('chat-input');
            if (chatInput) {
                chatInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter' && !e.shiftKey) {
                        e.preventDefault();
                        sendMessage();
                    }
                });
            }
        });

        // Load recent chat messages (last minute) when panel loads
        async function loadRecentChatHistory() {
            if (!window.supabase || !window.currentGameSession) {
                console.log('Chat history: Not connected to session');
                return;
            }

            try {
                const oneMinuteAgo = new Date(Date.now() - 60000).toISOString();
                
                const { data: messages, error } = await window.supabase
                    .from('game_messages')
                    .select('*')
                    .eq('session_code', window.currentGameSession.session_code)
                    .gte('created_at', oneMinuteAgo)
                    .order('created_at', { ascending: true });
                    
                if (error) throw error;
                
                // Clear existing messages and display recent ones
                const chatMessages = document.getElementById('chat-messages');
                if (chatMessages && messages.length > 0) {
                    chatMessages.innerHTML = '';
                    messages.forEach(message => {
                        if (window.displayChatMessage) {
                            window.displayChatMessage(message);
                        }
                    });
                    console.log(`💬 Loaded ${messages.length} recent messages`);
                    
                    // Reset chat container after loading messages
                    setTimeout(() => {
                        resetChatContainer();
                    }, 100);
                }
                
            } catch (error) {
                console.warn('⚠️ Failed to load chat history:', error.message);
            }
        }

        // Make function globally available
        window.loadRecentChatHistory = loadRecentChatHistory;
    </script>

    <!-- Hidden compatibility elements for legacy modules -->
    <div style="display: none;">
        <!-- Tab Navigation Compatibility -->
        <nav class="tab-nav" id="tabNav">
            <div class="tab-container">
                <!-- Content containers that modules expect -->
                <div id="saved-npcs-grid"></div>
                <div id="saved-loot-container"></div>
                <div id="saved-maps-container"></div>
                <div id="map-grid"></div>
                
                <!-- Form elements that modules expect -->
                <select id="npc-filter"></select>
                <select id="loot-filter"></select>
                <select id="loot-type-select"></select>
                <select id="map-size-select"></select>
                <div id="special-items-group"></div>
                
                <!-- Display elements that modules expect -->
                <div id="grid-size-display"></div>
                <div id="tiles-placed"></div>
            </div>
        </nav>
        
        <!-- Session Management -->
        <div id="session-modal" style="display: none;">
            <input type="file" id="import-file" accept=".json">
            <input id="session-name-input">
            <div id="sessions-list"></div>
        </div>
        
        <!-- Map Editor Elements -->
        <div id="tile-selector"></div>
    </div>
</body>
</html>
