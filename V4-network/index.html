<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">

<!-- iOS specific -->
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
<meta name="apple-mobile-web-app-title" content="DCC Sheet">

<!-- Disable unwanted auto-formatting -->
<meta name="format-detection" content="telephone=no">
<meta name="msapplication-tap-highlight" content="no">

<!-- PWA Manifest -->
<link rel="manifest" href="manifest.json">
<meta name="theme-color" content="#ff6b35">

<!-- iOS icons (Apple doesn‚Äôt use manifest.json icons) -->
<link rel="apple-touch-icon" sizes="180x180" href="icon-192.png">
<link rel="apple-touch-icon" sizes="512x512" href="icon-512.png">

<!-- Optional splash screens for iOS (if you want fancy loading) -->
<!-- Example -->
<!-- <link rel="apple-touch-startup-image" href="splash-640x1136.png" media="(device-width: 320px)"> -->

<title>Dungeon Crawler World</title>

    <!-- Fonts - Original Google Fonts setup that was working -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&family=Uncial+Antiqua&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rpg-awesome/0.2.0/css/rpg-awesome.min.css">
    <!-- Add Montserrat font for modern look -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700&display=swap" rel="stylesheet">
    
    <style>
        /* Original working font setup */
        body {
            font-family: 'Cinzel', 'Times New Roman', 'Georgia', serif;
        }
        
        /* Headers get the refined fantasy treatment */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', 'Merriweather', 'Cinzel', serif;
        }
        
        /* Special elements for that ancient manuscript feel */
        .app-title, .hero-name-input, .character-landing h1 {
            font-family: 'Montserrat', Arial, serif;
        }
        
        /* Material Icons - original setup */
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        
        /* RPG Awesome icons work with CSS file colors */

        

        .ra:empty.ra-double-team:after { content: "ÔøΩ"; }
        .ra:empty.ra-muscle-up:after { content: "ÔøΩ"; }
        .ra:empty.ra-hearts:after { content: "‚ù§Ô∏è"; }
        .ra:empty.ra-crystal-wand:after { content: "üîÆ"; }
        .ra:empty.ra-sword:after { content: "‚öîÔ∏è"; }
        .ra:empty.ra-shield:after { content: "üõ°Ô∏è"; }
        .ra:empty.ra-vest:after { content: "üëï"; }
        .ra:empty.ra-gem-pendant:after { content: "üíé"; }
        .ra:empty.ra-backpack:after { content: "üéí"; }
        
        /* Enhanced font loading detection */
        @media screen and (max-width: 768px) {
            /* Mobile-specific font adjustments */
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
        /* Fix any remaining emoji fallback issues */
        .ra:empty:after {
            display: none !important;
        }
        
        .material-icons:empty:after {
            display: none !important;
        }
    </style>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="light.css">
    <link rel="stylesheet" href="dark.css">
    <link rel="stylesheet" href="themes.css">
    <!-- Network Integration CSS -->
    <link rel="stylesheet" href="css/network-chat.css">
    <link rel="stylesheet" href="css/chat-effects.css">
</head>

<body>
    <!-- Main Character Sheet (Initially hidden by JS) -->
    <div class="app-container">
        <!-- Mobile Header -->
        <header class="app-header">
            <button class="header-btn menu-btn" onclick="toggleSidebar()" title="Open Navigation Menu">
                <span class="material-icons">menu</span>
            </button>
            <button class="header-btn theme-btn" onclick="toggleTheme()" title="Toggle Theme">
                <span class="material-icons">brightness_6</span>
            </button>
            <button class="header-btn cache-btn" onclick="clearAllCaches()" title="Clear Cache (Fix Loading Issues)">
                <span class="material-icons">refresh</span>
            </button>
            <h1 class="app-title">
                <span class="character-info-display"></span>
                <div class="status-header-container" id="status-header-container">
                    <!-- Active status effects with timers will appear here -->
                </div>
            </h1>
            <button class="header-btn trophy-btn" onclick="showAchievementsModal()" title="View Achievements">
                <span class="material-icons">emoji_events</span>
            </button>
            <button class="header-btn roll-history-btn" onclick="showRollHistoryModal()" title="View Roll History">
                <i class="ra ra-perspective-dice-six"></i>
            </button>
            <button class="header-btn status-effects-btn" onclick="showStatusEffectsModal()" title="View Status Effects">
                <i class="ra ra-biohazard"></i>
            </button>
            <button class="header-btn save-btn" onclick="saveCharacterToStorage()" title="Save Character">
                <span class="material-icons">save</span>
            </button>
        </header>

        <!-- Sidebar Navigation Drawer -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Navigation</h2>
                <button class="close-sidebar" onclick="toggleSidebar()" title="Close Menu">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="sidebar-content">
                <button class="sidebar-tab" data-tab="creation" style="display: none;">
                    <span class="tab-icon"><i class="ra ra-quill-ink"></i></span>
                    <span class="tab-label">Create Character</span>
                </button>
                <button class="sidebar-tab active" data-tab="character">
                    <span class="tab-icon"><i class="ra ra-player"></i></span>
                    <span class="tab-label">Character Stats</span>
                </button>
                <button class="sidebar-tab" data-tab="inventory">
                    <span class="tab-icon"><i class="ra ra-book"></i></span>
                    <span class="tab-label">Inventory & Gear</span>
                </button>
                <button class="sidebar-tab" data-tab="magic">
                    <span class="tab-icon"><i class="ra ra-fairy-wand"></i></span>
                    <span class="tab-label">Magic & Spells</span>
                </button>
                <button class="sidebar-tab" data-tab="chat">
                    <span class="tab-icon"><i class="ra ra-conversation"></i></span>
                    <span class="tab-label">Game Chat</span>
                </button>
                <!-- <button class="sidebar-tab" data-tab="combat">
                    <span class="tab-icon"><i class="ra ra-crossed-swords"></i></span>
                    <span class="tab-label">Combat & Dice</span>
                </button> -->
                <button class="sidebar-tab" data-tab="notes">
                    <span class="tab-icon"><i class="ra ra-scroll-unfurled"></i></span>
                    <span class="tab-label">Notes & Backstory</span>
                </button>
                <button class="sidebar-tab" data-tab="storage">
                    <span class="tab-icon">üóÑÔ∏è</span>
                    <span class="tab-label">Storage Manager</span>
                </button>
                <button class="sidebar-tab" data-tab="reference">
                    <span class="tab-icon"><i class="material-icons">help_outline</i></span>
                    <span class="tab-label">How the Game Works</span>
                </button>
            </div>
            
            <!-- Theme Selector -->
            <div class="theme-selector">
                <h4>Accent Colors</h4>
                <div class="theme-colors-grid">
                    <button class="theme-color-btn theme-btn-default active" data-theme="default" title="Default (Purple)"></button>
                    <button class="theme-color-btn theme-btn-red" data-theme="red" title="Red"></button>
                    <button class="theme-color-btn theme-btn-orange" data-theme="orange" title="Orange"></button>
                    <button class="theme-color-btn theme-btn-yellow" data-theme="yellow" title="Yellow"></button>
                    <button class="theme-color-btn theme-btn-green" data-theme="green" title="Green"></button>
                    <button class="theme-color-btn theme-btn-blue" data-theme="blue" title="Blue"></button>
                    <button class="theme-color-btn theme-btn-indigo" data-theme="indigo" title="Indigo"></button>
                    <button class="theme-color-btn theme-btn-violet" data-theme="violet" title="Violet"></button>
                </div>
                
                <div class="holiday-themes">
                    <h5>Special Themes</h5>
                    <div class="theme-colors-grid">
                        <button class="theme-color-btn theme-btn-christmas" data-theme="christmas" title="Christmas"></button>
                        <button class="theme-color-btn theme-btn-halloween" data-theme="halloween" title="Halloween"></button>
                        <button class="theme-color-btn theme-btn-valentine" data-theme="valentine" title="Valentine's Day"></button>
                        <button class="theme-color-btn theme-btn-ocean" data-theme="ocean" title="Ocean"></button>
                        <button class="theme-color-btn theme-btn-forest" data-theme="forest" title="Forest"></button>
                        <button class="theme-color-btn theme-btn-sunset" data-theme="sunset" title="Sunset"></button>
                    </div>
                </div>
            </div>
        </nav>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Tab Contents -->
        <main class="tab-container">
            <!-- Character Creation Tab -->
            <section class="tab-content active" id="creation">
                <div class="content-wrapper">
                    <!-- Hero Section -->
                    <div class="hero-card">
                        <div class="portrait-section">
                            <div id="portrait-display" class="portrait-container">
                                <div class="portrait-placeholder">
                                    <i class="ra ra-hood"></i>
                                    <span>Tap to Upload</span>
                                </div>
                            </div>
                            <input type="file" id="portrait-upload" accept="image/*" style="display: none;">
                        </div>

                        <div class="hero-info">
                            <input type="text" id="char-name" class="hero-name-input" placeholder="Character Name"
                                autocomplete="off">
                            <div class="hero-meta">
                                <div class="meta-item">
                                    <label>Level</label>
                                    <input type="number" id="char-level" class="compact-input" value="1" min="1"
                                        max="20">
                                </div>
                                <div class="meta-item">
                                    <label>Age</label>
                                    <input type="number" id="char-age" class="compact-input" placeholder="25" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Identity Cards -->
                    <div class="card-grid">
                        <!-- Race Card -->
                        <div class="card race-card">
                            <div class="card-header">
                                <i class="ra ra-double-team"></i>
                                <h3>Heritage</h3>
                            </div>
                            <select id="race-select" class="fancy-select">
                                <option value="">Choose your heritage...</option>
                                <optgroup label="Dungeon Crawler">
                                    <option value="bopca">üõ∏ Bopca</option>
                                    <option value="skyfowl">ü¶Ö Skyfowl</option>
                                    <option value="rat_kin">üêÄ Rat-kin</option>
                                    <option value="hellspawn_familiar">üëπ Hellspawn Familiar</option>
                                    <option value="primal">‚ú® Primal</option>
                                    <option value="were_creature">üê∫ Were-creature</option>
                                </optgroup>
                                <optgroup label="Classic Fantasy">
                                    <option value="human">üë§ Human</option>
                                    <option value="elf">üßù Elf</option>
                                    <option value="dwarf">‚õèÔ∏è Dwarf</option>
                                    <option value="orc">üí™ Orc</option>
                                    <option value="halfling">üçÑ Halfling</option>
                                    <option value="dragonborn">üê≤ Dragonborn</option>
                                    <option value="tiefling">üòà Tiefling</option>
                                    <option value="gnome">üßô Gnome</option>
                                    <option value="goblin">üë∫ Goblin</option>
                                    <option value="slime">üíß Slime</option>
                                </optgroup>
                                <optgroup label="Sci-Fi">
                                    <option value="cyborg">ü§ñ Cyborg</option>
                                    <option value="mutant">‚ò¢Ô∏è Mutant</option>
                                    <option value="android">ü¶æ Android</option>
                                    <option value="clone">üß¨ Clone</option>
                                </optgroup>
                                <optgroup label="Post-Apocalyptic">
                                    <option value="ghoul">‚ò†Ô∏è Ghoul</option>
                                    <option value="raider">‚öîÔ∏è Raider</option>
                                    <option value="vault_dweller">üè† Vault Dweller</option>
                                    <option value="synth">üîß Synth</option>
                                    <option value="beast_kin">üê∫ Beast-kin</option>
                                    <option value="plant_hybrid">üåø Plant Hybrid</option>
                                </optgroup>
                                <option value="custom">‚ú® Custom Heritage</option>
                            </select>

                            <input type="text" id="custom-race" class="fancy-input" placeholder="Enter custom heritage"
                                style="display: none;">

                            <!-- Custom Race Builder -->
                            <div id="custom-race-bonuses" class="custom-builder" style="display: none;">
                                <h4>Custom Heritage Builder</h4>

                                <div class="builder-section">
                                    <label>Attribute Bonuses (Pick 1-2)</label>
                                    <div class="checkbox-grid">
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-str"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>STR</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-dex"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>DEX</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-con"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>CON</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-int"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>INT</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-wis"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>WIS</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-cha"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>CHA</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="builder-section">
                                    <label>Attribute Limits</label>
                                    <div class="stat-limit-grid">
                                        <div class="limit-input">
                                            <label>STR</label>
                                            <input type="number" id="custom-race-max-str" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>DEX</label>
                                            <input type="number" id="custom-race-max-dex" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>CON</label>
                                            <input type="number" id="custom-race-max-con" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>INT</label>
                                            <input type="number" id="custom-race-max-int" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>WIS</label>
                                            <input type="number" id="custom-race-max-wis" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>CHA</label>
                                            <input type="number" id="custom-race-max-cha" value="15" min="5" max="25">
                                        </div>
                                    </div>
                                </div>

                                <div class="builder-section">
                                    <label>Racial Abilities</label>
                                    <div class="skill-builder">
                                        <select id="custom-race-skill1" class="skill-select">
                                            <option value="">First ability...</option>
                                            <option value="custom">‚úèÔ∏è Custom</option>
                                            <option value="Darkvision">üëÅÔ∏è Darkvision</option>
                                            <option value="Flight">ü¶Ö Flight</option>
                                            <option value="Telepathy">üß† Telepathy</option>
                                            <option value="Regeneration">‚ù§Ô∏è‚Äçü©π Regeneration</option>
                                            <option value="Natural Armor">üõ°Ô∏è Natural Armor</option>
                                            <option value="Keen Senses">üëÇ Keen Senses</option>
                                            <option value="Camouflage">üåø Camouflage</option>
                                            <option value="Aquatic">üåä Aquatic</option>
                                        </select>
                                        <select id="custom-race-skill1-stat" class="stat-select">
                                            <option value="strength">STR</option>
                                            <option value="dexterity">DEX</option>
                                            <option value="constitution">CON</option>
                                            <option value="intelligence">INT</option>
                                            <option value="wisdom">WIS</option>
                                            <option value="charisma">CHA</option>
                                        </select>
                                        <input type="text" id="custom-race-skill1-name" class="custom-skill-name"
                                            placeholder="Ability name" style="display: none;">
                                    </div>

                                    <div class="skill-builder">
                                        <select id="custom-race-skill2" class="skill-select">
                                            <option value="">Second ability...</option>
                                            <option value="custom">‚úèÔ∏è Custom</option>
                                            <option value="Darkvision">üëÅÔ∏è Darkvision</option>
                                            <option value="Flight">ü¶Ö Flight</option>
                                            <option value="Telepathy">üß† Telepathy</option>
                                            <option value="Regeneration">‚ù§Ô∏è‚Äçü©π Regeneration</option>
                                            <option value="Natural Armor">üõ°Ô∏è Natural Armor</option>
                                            <option value="Keen Senses">üëÇ Keen Senses</option>
                                            <option value="Camouflage">üåø Camouflage</option>
                                            <option value="Aquatic">üåä Aquatic</option>
                                        </select>
                                        <select id="custom-race-skill2-stat" class="stat-select">
                                            <option value="strength">STR</option>
                                            <option value="dexterity">DEX</option>
                                            <option value="constitution">CON</option>
                                            <option value="intelligence">INT</option>
                                            <option value="wisdom">WIS</option>
                                            <option value="charisma">CHA</option>
                                        </select>
                                        <input type="text" id="custom-race-skill2-name" class="custom-skill-name"
                                            placeholder="Ability name" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Background Card -->
                        <div class="card background-card">
                            <div class="card-header">
                                <i class="ra ra-scroll-unfurled"></i>
                                <h3>Background</h3>
                            </div>
                            <select id="job-select" class="fancy-select">
                                <option value="">Choose your past...</option>
                                <optgroup label="Academic">
                                    <option value="teacher">üìö Teacher</option>
                                    <option value="scientist">üî¨ Scientist</option>
                                    <option value="doctor">‚öïÔ∏è Doctor</option>
                                    <option value="lawyer">‚öñÔ∏è Lawyer</option>
                                </optgroup>
                                <optgroup label="Technical">
                                    <option value="engineer">‚öôÔ∏è Engineer</option>
                                    <option value="mechanic">üîß Mechanic</option>
                                    <option value="programmer">üíª Programmer</option>
                                </optgroup>
                                <optgroup label="Service">
                                    <option value="soldier">üéñÔ∏è Soldier</option>
                                    <option value="police">üëÆ Police Officer</option>
                                    <option value="firefighter">üöí Firefighter</option>
                                </optgroup>
                                <optgroup label="Creative">
                                    <option value="artist">üé® Artist</option>
                                    <option value="musician">üéµ Musician</option>
                                    <option value="writer">‚úçÔ∏è Writer</option>
                                    <option value="chef">üë®‚Äçüç≥ Chef</option>
                                </optgroup>
                                <optgroup label="Physical">
                                    <option value="athlete">üèÉ Athlete</option>
                                </optgroup>
                                <option value="custom">‚ú® Custom Background</option>
                            </select>

                            <input type="text" id="custom-job" class="fancy-input" placeholder="Enter custom background"
                                style="display: none;">

                            <!-- Custom Job Builder (similar structure) -->
                            <div id="custom-job-bonuses" class="custom-builder" style="display: none;">
                                <!-- Similar to race builder but for jobs -->
                            </div>
                        </div>

                        <!-- Class Card -->
                        <div class="card class-card">
                            <div class="card-header">
                                <i class="ra ra-crossed-swords"></i>
                                <h3>Class</h3>
                            </div>
                            <select id="class-select" class="fancy-select">
                                <option value="">Choose your path...</option>
                                <optgroup label="Dungeon Crawler">
                                    <option value="compensated_anarchist">üí• Compensated Anarchist</option>
                                    <option value="bomb_squad_tech">üí£ Bomb Squad Tech</option>
                                    <option value="prizefighter">üëä Prizefighter</option>
                                    <option value="artist_alley_mogul">üé® Artist Alley Mogul</option>
                                    <option value="former_child_actor">üé≠ Former Child Actor</option>
                                    <option value="roller_derby_jammer">üõº Roller Derby Jammer</option>
                                    <option value="football_hooligan">‚öΩ Football Hooligan</option>
                                    <option value="kabaddi_raider">ü§º Kabaddi Raider</option>
                                    <option value="monster_truck_driver">üöö Monster Truck Driver</option>
                                    <option value="vape_shop_counter_jockey">üí® Vape Shop Counter Jockey</option>
                                    <option value="freelance_psychiatrist">üß† Freelance Psychiatrist</option>
                                    <option value="banana_farmer">üçå Banana Farmer</option>
                                    <option value="necrobard">üíÄ NecroBard</option>
                                    <option value="feral_cat_berserker">üê± Feral Cat Berserker</option>
                                    <option value="animal_test_subject">üß™ Animal Test Subject</option>
                                    <option value="glass_cannon">üîÆ Glass Cannon</option>
                                    <option value="legendary_diva">üëë Legendary Diva</option>
                                    <option value="viper_queen">üêç Viper Queen</option>
                                </optgroup>
                                <optgroup label="Warriors">
                                    <option value="fighter">‚öîÔ∏è Fighter</option>
                                    <option value="barbarian">ü™ì Barbarian</option>
                                    <option value="paladin">üõ°Ô∏è Paladin</option>
                                    <option value="monk">ü•ã Monk</option>
                                </optgroup>
                                <optgroup label="Rogues">
                                    <option value="rogue">üó°Ô∏è Rogue</option>
                                    <option value="ranger">üèπ Ranger</option>
                                    <option value="gunslinger">üî´ Gunslinger</option>
                                </optgroup>
                                <optgroup label="Mages">
                                    <option value="wizard">üßô Wizard</option>
                                    <option value="sorcerer">‚ú® Sorcerer</option>
                                    <option value="warlock">üëπ Warlock</option>
                                    <option value="druid">üå≥ Druid</option>
                                </optgroup>
                                <optgroup label="Support">
                                    <option value="cleric">‚õ™ Cleric</option>
                                    <option value="bard">üé≠ Bard</option>
                                    <option value="medic">üè• Field Medic</option>
                                </optgroup>
                                <optgroup label="Tech">
                                    <option value="hacker">üíæ Data Runner</option>
                                    <option value="engineer_class">üî® Engineer</option>
                                    <option value="pilot">‚úàÔ∏è Pilot</option>
                                </optgroup>
                                <optgroup label="Survival">
                                    <option value="survivalist">üèïÔ∏è Survivalist</option>
                                </optgroup>
                                <option value="custom_class">‚ú® Custom Class</option>
                            </select>

                            <input type="text" id="custom-class" class="fancy-input" placeholder="Enter custom class"
                                style="display: none;">

                            <!-- Custom Class Builder (similar structure) -->
                            <div id="custom-class-bonuses" class="custom-builder" style="display: none;">
                                <!-- Similar to race builder but for classes -->
                            </div>
                        </div>
                    </div>

                    <!-- Active Bonuses -->
                    <div class="card bonuses-card" id="bonuses-display" style="display: none;">
                        <div class="card-header">
                            <i class="ra ra-trophy"></i>
                            <h3>Active Bonuses</h3>
                        </div>
                        <div id="bonuses-content" class="bonuses-list">
                            <!-- Bonuses will be rendered here -->
                        </div>
                    </div>

                    <!-- Attributes Section -->
                    <div class="card attributes-card">
                        <div class="card-header">
                            <i class="ra ra-muscle-up"></i>
                            <h3>Attributes</h3>
                            <div class="points-display">
                                <span class="points-label">Points</span>
                                <span class="points-value" id="available-points">3</span>
                            </div>
                        </div>

                        <div class="attributes-grid" id="stats-grid">
                            <!-- Stats will be rendered here -->
                        </div>

                        <div class="vital-stats">
                            <div class="vital-stat hp-stat">
                                <i class="ra ra-hearts"></i>
                                <div class="vital-info">
                                    <span class="vital-label">Health</span>
                                    <span class="vital-value" id="health-points">3</span>
                                </div>
                            </div>
                            <div class="vital-stat mp-stat">
                                <i class="ra ra-crystal-wand"></i>
                                <div class="vital-info">
                                    <span class="vital-label">Magic</span>
                                    <span class="vital-value" id="magic-points">4</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Story Section -->
                    <div class="card story-card">
                        <div class="card-header">
                            <i class="ra ra-book"></i>
                            <h3>Character Story</h3>
                        </div>
                        <textarea id="char-backstory" class="story-textarea"
                            placeholder="Tell your character's story..." rows="6"></textarea>
                    </div>

                    <!-- Skills Selection Section -->
                    <div class="card skills-selection-card">
                        <div class="card-header">
                            <i class="ra ra-gears"></i>
                            <h3>Starting Skills</h3>
                            <div class="skills-counter">
                                <span class="skills-label">Selected</span>
                                <span class="skills-value" id="selected-skills-count">0</span>
                                <span class="skills-max">/5</span>
                            </div>
                        </div>
                        <p class="hint-text">Choose up to 5 skills from the list below, or create your own custom skills. Skills based on your class and job attributes get bonus dice!</p>
                        
                        <div class="skills-tabs">
                            <button class="skills-tab-btn active" data-skills-tab="existing">
                                <i class="ra ra-book"></i>
                                Existing Skills
                            </button>
                            <button class="skills-tab-btn" data-skills-tab="custom">
                                <i class="ra ra-quill-ink"></i>
                                Custom Skills
                            </button>
                        </div>

                        <!-- Existing Skills Tab -->
                        <div class="skills-tab-content active" id="existing-skills-tab">
                            <div class="skills-filter">
                                <select id="skills-filter-stat" class="filter-select">
                                    <option value="">Filter by attribute...</option>
                                    <option value="strength">Strength</option>
                                    <option value="dexterity">Dexterity</option>
                                    <option value="constitution">Constitution</option>
                                    <option value="intelligence">Intelligence</option>
                                    <option value="wisdom">Wisdom</option>
                                    <option value="charisma">Charisma</option>
                                </select>
                                <input type="text" id="skills-search" class="search-input" placeholder="Search skills...">
                            </div>
                            <div class="skills-selection-grid" id="skills-selection-grid">
                                <!-- Available skills will be rendered here -->
                            </div>
                        </div>

                        <!-- Custom Skills Tab -->
                        <div class="skills-tab-content" id="custom-skills-tab">
                            <div class="custom-skills-creator">
                                <h4>Create Custom Skills</h4>
                                <div class="custom-skill-form">
                                    <input type="text" id="custom-skill-name" class="skill-name-input" 
                                           placeholder="Skill name (e.g., 'Spaceship Piloting')">
                                    <select id="custom-skill-stat" class="skill-stat-select">
                                        <option value="strength">Strength</option>
                                        <option value="dexterity">Dexterity</option>
                                        <option value="constitution">Constitution</option>
                                        <option value="intelligence">Intelligence</option>
                                        <option value="wisdom">Wisdom</option>
                                        <option value="charisma">Charisma</option>
                                    </select>
                                    <button class="add-custom-skill-btn" onclick="addCustomSkillToSelection()">
                                        <span class="material-icons">add</span>
                                        Add Skill
                                    </button>
                                </div>
                                <div class="custom-skills-list" id="custom-skills-list">
                                    <!-- Custom skills will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Selected Skills Display -->
                        <div class="selected-skills-section">
                            <h4>Your Selected Skills</h4>
                            <div class="selected-skills-grid" id="selected-skills-grid">
                                <div class="no-skills-message">
                                    <i class="ra ra-help"></i>
                                    <p>No skills selected yet. Choose up to 5 skills above!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-bar">
                        <button class="action-btn new-char-btn" onclick="createNewCharacter()">
                            <span class="material-icons">person_add</span>
                            New Character
                        </button>
                        <button class="action-btn primary-btn" onclick="saveCharacterToStorage()">
                            <span class="material-icons">save</span>
                            Save Character
                        </button>
                        <button class="action-btn secondary-btn" onclick="loadCharacterFromStorage()">
                            <span class="material-icons">folder_open</span>
                            Load
                        </button>
                        <button class="action-btn secondary-btn" onclick="exportCharacterToJSON()">
                            <span class="material-icons">download</span>
                            Export
                        </button>
                        <button class="action-btn qr-btn" onclick="shareCharacterAsCard()">
                            <span class="material-icons">photo</span>
                            Share Card
                        </button>
                        <button class="action-btn scan-btn" onclick="loadCharacterFromCard()">
                            <span class="material-icons">upload</span>
                            Load Card
                        </button>
                    </div>
                </div>
            </section>

            <!-- Character Stats Tab -->
            <section class="tab-content" id="character">
                <div class="content-wrapper">
                    <!-- Character Overview with Optimized Layout -->
                    <div class="character-overview">
                        <div class="overview-combined">
                            <!-- Main Content with Character Info Header -->
                            <div class="overview-main">
                                <!-- Character Info Row: Full Width -->
                                <div class="character-info-row">
                                    <h2 id="char-display-name">Character Overview</h2>
                                    <div class="level-info">
                                        <span id="char-level-display">Level 1</span>
                                        <button id="level-up-btn" class="level-up-pill-btn" onclick="handleLevelUp()" style="display: none;">
                                            <i class="ra ra-star"></i>
                                            Level Up!
                                        </button>
                                    </div>
                                </div>
                                
                                <!-- Two Columns: Avatar & Vitals -->
                                <div class="overview-columns">
                                    <!-- Column 1: Avatar -->
                                    <div class="overview-avatar">
                                        <div class="overview-portrait" id="overview-portrait">
                                            <div class="portrait-placeholder">
                                                <i class="ra ra-hood"></i>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Column 2: HP, MP, Damage System -->
                                    <div class="overview-vitals">
                                        <!-- HP System -->
                                        <div class="vital-item">
                                            <i class="ra ra-hearts"></i>
                                            <span class="vital-label">HP</span>
                                            <span class="vital-value">
                                                <span id="char-current-hp">3</span>/<span id="char-total-hp">3</span>
                                            </span>
                                        </div>
                                        
                                        <!-- MP System -->
                                        <div class="vital-item">
                                            <i class="ra ra-crystal-wand"></i>
                                            <span class="vital-label">MP</span>
                                            <span class="vital-value">
                                                <span id="char-current-mp">4</span>/<span id="char-total-mp">4</span>
                                            </span>
                                        </div>
                                        
                                        <!-- Damage System -->
                                        <div class="vital-item damage-tester-inline">
                                            <i class="ra ra-sword"></i>
                                            <span class="vital-label">DMG</span>
                                            <div class="damage-controls">
                                                <input type="number" id="damage-input" class="damage-input" placeholder="5"
                                                    value="5" min="1">
                                                <button class="damage-btn" onclick="testDamage()">
                                                    Take
                                                </button>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                            
                            <!-- Bottom Row: Heritage/Background/Class Info -->
                            <div class="overview-footer">
                                <div id="char-summary" class="character-summary">
                                    <!-- Summary will be rendered here -->
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rest Options -->
                    <div class="rest-options">
                        <button class="rest-btn quick-rest" onclick="quickRest()">
                            <i class="ra ra-campfire"></i>
                            <span>Quick Rest</span>
                            <small>4 hours ‚Ä¢ +Half HP/MP</small>
                        </button>
                        <button class="rest-btn long-rest" onclick="longRest()">
                            <i class="ra ra-moon-sun"></i>
                            <span>Long Rest</span>
                            <small>8 hours ‚Ä¢ Full Recovery</small>
                        </button>
                    </div>

                    <!-- Attributes Display -->
                    <div class="card">
                        <div class="card-header">
                            <div class="header-left">
                                <i class="ra ra-muscle-up"></i>
                                <h3>Attributes</h3>
                            </div>
                            <span class="header-hint">Tap any attribute to roll!</span>
                        </div>
                        <div class="attributes-display" id="char-stats-display">
                            <!-- Stats will be rendered here -->
                        </div>
                        <div class="bonus-sources-display" id="bonus-sources-display">
                            <!-- Bonus source info will be rendered here -->
                        </div>
                    </div>

                    <!-- Abilities Navigation -->
                    <div class="abilities-nav">
                        <button class="ability-nav-btn active" data-ability="skills">
                            <i class="ra ra-gears"></i>
                            Skills
                        </button>
                        <button class="ability-nav-btn" data-ability="weapons">
                            <i class="ra ra-crossed-swords"></i>
                            Weapons
                        </button>
                        <button class="ability-nav-btn" data-ability="spells">
                            <i class="ra ra-fairy-wand"></i>
                            Spells
                        </button>
                    </div>

                    <!-- Abilities Content -->
                    <div class="abilities-content">
                        <!-- Skills -->
                        <div class="ability-panel active" id="skills-content">
                            <div class="ability-grid" id="char-skills-grid">
                                <!-- Skills will be rendered here -->
                            </div>

                            <div class="add-ability-section">
                                <h4><i class="ra ra-plus-sword"></i> Add Custom Skill</h4>
                                <div class="add-ability-form">
                                    <input type="text" id="char-custom-skill-name" class="ability-name-input"
                                        placeholder="Skill name">
                                    <select id="char-custom-skill-stat" class="ability-stat-select">
                                        <option value="strength">STR</option>
                                        <option value="dexterity">DEX</option>
                                        <option value="constitution">CON</option>
                                        <option value="intelligence">INT</option>
                                        <option value="wisdom">WIS</option>
                                        <option value="charisma">CHA</option>
                                    </select>
                                    <button class="add-ability-btn" onclick="addCustomSkillFromCharTab()">
                                        <span class="material-icons">add</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Weapons -->
                        <div class="ability-panel" id="weapons-content">
                            <div id="char-weapons-container" class="weapons-container">
                                <!-- Weapons will be rendered here -->
                            </div>
                        </div>

                        <!-- Spells -->
                        <div class="ability-panel" id="spells-content">
                            <div id="char-spells-container" class="spells-container">
                                <!-- Spells will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inventory Tab -->
            <section class="tab-content" id="inventory">
                <div class="content-wrapper">
                    <!-- Equipment Slots -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-vest"></i>
                            <h3>Equipment</h3>
                        </div>
                        <div class="equipment-grid">
                            <div class="equipment-slot" data-slot="mainHand" onclick="showEquipMenu('mainHand')">
                                <div class="slot-icon"><i class="ra ra-sword"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Main Hand</div>
                                    <div class="slot-item" id="mainHand-item">Empty</div>
                                    <div class="slot-stats" id="mainHand-stats"></div>
                                </div>
                            </div>
                            <div class="equipment-slot" data-slot="offHand" onclick="showEquipMenu('offHand')">
                                <div class="slot-icon"><i class="ra ra-shield"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Off Hand</div>
                                    <div class="slot-item" id="offHand-item">Empty</div>
                                    <div class="slot-stats" id="offHand-stats"></div>
                                </div>
                            </div>
                            <div class="equipment-slot" data-slot="armor" onclick="showEquipMenu('armor')">
                                <div class="slot-icon"><i class="ra ra-vest"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Armor</div>
                                    <div class="slot-item" id="armor-item">Empty</div>
                                    <div class="slot-stats" id="armor-stats"></div>
                                </div>
                            </div>
                            <div class="equipment-slot" data-slot="accessory" onclick="showEquipMenu('accessory')">
                                <div class="slot-icon"><i class="ra ra-gem-pendant"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Accessory</div>
                                    <div class="slot-item" id="accessory-item">Empty</div>
                                    <div class="slot-stats" id="accessory-stats"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Grid -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-backpack"></i>
                            <h3>Inventory</h3>
                        </div>
                        <div class="inventory-grid" id="inventory-grid">
                            <!-- Items will be rendered here -->
                        </div>

                        <!-- Add Item Form -->
                        <div class="add-item-section">
                            <h4><i class="ra ra-anvil"></i> Create New Item</h4>
                            <div class="item-creator">
                                <input type="text" id="item-name" class="item-input" placeholder="Item name">

                                <div class="item-options">
                                    <select id="item-type" class="item-select">
                                        <option value="weapon">‚öîÔ∏è Weapon</option>
                                        <option value="armor">üõ°Ô∏è Armor</option>
                                        <option value="accessory">üíç Accessory</option>
                                        <option value="consumable">üß™ Consumable</option>
                                        <option value="misc">üì¶ Miscellaneous</option>
                                    </select>

                                    <select id="weapon-size" class="item-select">
                                        <option value="light">Light (d4)</option>
                                        <option value="medium">Medium (d6)</option>
                                        <option value="heavy">Heavy (d8)</option>
                                    </select>

                                    <input type="number" id="item-defense" class="item-input" placeholder="Defense"
                                        min="0">
                                </div>

                                <div class="item-properties">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="item-twohanded">
                                        <span>Two-Handed</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="item-ranged">
                                        <span>Ranged</span>
                                    </label>
                                    <label class="checkbox-label" id="healing-consumable-container"
                                        style="display: none;">
                                        <input type="checkbox" id="item-healing">
                                        <span>Healing</span>
                                    </label>
                                </div>

                                <button class="create-item-btn" onclick="addItem()">
                                    <i class="ra ra-hammer"></i>
                                    Create Item
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Magic Tab -->
            <section class="tab-content" id="magic">
                <div class="content-wrapper">
                    <!-- Magic Points Display -->
                    <div class="magic-header">
                        <div class="magic-pool">
                            <i class="ra ra-crystal-wand"></i>
                            <div class="magic-counter">
                                <button class="counter-btn" onclick="adjustMagicPointsInTab(-1)">-</button>
                                <div class="magic-display">
                                    <span id="magic-current-mp">4</span>
                                    <span>/</span>
                                    <span id="magic-total-mp">4</span>
                                </div>
                                <button class="counter-btn" onclick="adjustMagicPointsInTab(1)">+</button>
                            </div>
                            <span class="magic-label">Magic Points</span>
                        </div>
                    </div>

                    <!-- Known Spells -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-scroll-unfurled"></i>
                            <h3>Spell Book</h3>
                        </div>
                        <div id="spells-grid" class="spells-grid">
                            <!-- Spells will be rendered here -->
                        </div>
                    </div>

                    <!-- Spell Creator -->
                    <div class="card spell-creator-card">
                        <div class="card-header">
                            <i class="ra ra-cauldron"></i>
                            <h3>Craft New Spell</h3>
                        </div>

                        <div class="spell-creator">
                            <input type="text" id="spell-name" class="spell-name-input" placeholder="Spell name">

                            <div class="spell-element-select">
                                <label>Element</label>
                                <select id="spell-element" class="element-select">
                                    <option value="fire">üî• Fire</option>
                                    <option value="ice">‚ùÑÔ∏è Ice</option>
                                    <option value="lightning">‚ö° Lightning</option>
                                    <option value="earth">üåç Earth</option>
                                    <option value="air">üí® Air</option>
                                    <option value="water">üíß Water</option>
                                    <option value="light">‚òÄÔ∏è Light</option>
                                    <option value="dark">üåë Dark</option>
                                    <option value="arcane">üîÆ Arcane</option>
                                    <option value="divine">‚ú® Divine</option>
                                    <option value="nature">üåø Nature</option>
                                    <option value="psychic">üß† Psychic</option>
                                    <option value="shadow">üë§ Shadow</option>
                                    <option value="force">üí• Force</option>
                                </select>
                            </div>

                            <div class="spell-effects">
                                <div class="effect-row">
                                    <label>Damage</label>
                                    <select id="damage-type" class="effect-select">
                                        <option value="">None</option>
                                        <option value="fixed">Fixed (2pts = 1MP)</option>
                                        <option value="d6">D6 Roll (3MP)</option>
                                    </select>
                                    <input type="number" id="damage-amount" class="effect-amount" min="0" max="10"
                                        value="0" disabled>
                                </div>

                                <div class="effect-row">
                                    <label>Healing</label>
                                    <select id="healing-type" class="effect-select">
                                        <option value="">None</option>
                                        <option value="fixed">Fixed (2pts = 1MP)</option>
                                        <option value="d6">D6 Roll (3MP)</option>
                                    </select>
                                    <input type="number" id="healing-amount" class="effect-amount" min="0" max="10"
                                        value="0" disabled>
                                </div>

                                <div class="effect-row">
                                    <label>Primary Effect</label>
                                    <select id="primary-effect" class="effect-select">
                                        <option value="">None</option>
                                        <option value="stun">‚ö° Stun</option>
                                        <option value="slow">üêå Slow</option>
                                        <option value="blind">üëÅÔ∏è Blind</option>
                                        <option value="fear">üò± Fear</option>
                                        <option value="charm">üíï Charm</option>
                                        <option value="sleep">üò¥ Sleep</option>
                                        <option value="paralyze">ü•∂ Paralyze</option>
                                        <option value="confusion">üåÄ Confuse</option>
                                        <option value="weakness">üí™ Weakness</option>
                                        <option value="poison">ü§¢ Poison</option>
                                    </select>
                                </div>

                                <div class="effect-row">
                                    <label>Secondary Effect</label>
                                    <select id="secondary-effect" class="effect-select">
                                        <option value="">None</option>
                                        <option value="invisibility">üëª Invisibility</option>
                                        <option value="flight">ü¶Ö Flight</option>
                                        <option value="teleport">üåÄ Teleport</option>
                                        <option value="shield">üõ°Ô∏è Shield</option>
                                        <option value="haste">‚ö° Haste</option>
                                        <option value="strength">üí™ Strength</option>
                                        <option value="detect">üîç Detect Magic</option>
                                        <option value="dispel">‚ùå Dispel</option>
                                        <option value="light_source">üí° Light</option>
                                        <option value="darkness">üåë Darkness</option>
                                    </select>
                                </div>
                            </div>

                            <div id="spell-cost-display" class="spell-cost-display">
                                <h4>Spell Cost</h4>
                                <div id="cost-breakdown" class="cost-breakdown">
                                    Base Cost: 1 MP
                                </div>
                                <div class="total-cost">
                                    Total: <span id="total-cost">1</span> MP
                                </div>
                            </div>

                            <button class="create-spell-btn" onclick="createSpell()" id="create-spell-btn">
                                <i class="ra ra-sparkles"></i>
                                Create Spell
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Combat Tab (Merged Status + Rolling) -->
            <section class="tab-content" id="combat">
                <div class="content-wrapper">
                    <!-- Dice System Info -->
                    <div class="card dice-info-card">
                        <div class="card-header">
                            <i class="ra ra-perspective-dice-six"></i>
                            <h3>Dice System</h3>
                        </div>
                        <div id="dice-system-info" class="dice-info">
                            <div id="dice-explanation">
                                <!-- Dice system will be explained here -->
                            </div>
                        </div>
                    </div>

                    <!-- Roll History -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-scroll-unfurled"></i>
                            <h3>Roll History</h3>
                            <button class="clear-btn" onclick="clearRollHistory()">
                                <span class="material-icons">clear_all</span>
                            </button>
                        </div>
                        <div id="roll-history" class="roll-history">
                            <!-- Roll history will be rendered here -->
                        </div>
                    </div>

                    <!-- Status Effects -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-biohazard"></i>
                            <h3>Status Effects</h3>
                        </div>
                        <div id="status-effects-grid" class="status-grid">
                            <!-- Status effects will be rendered here -->
                        </div>

                        <!-- Add Status Effect -->
                        <!-- OLD DROPDOWN SYSTEM - COMMENTED OUT FOR NEW BUTTON SYSTEM IN MODAL
                        <div class="add-status-section">
                            <h4>Apply Status Effect</h4>
                            <div class="status-form">
                                <select id="status-effect-type" class="status-select">
                                    <option value="bleeding">ü©∏ Bleeding</option>
                                    <option value="poisoned">ü§¢ Poisoned</option>
                                    <option value="radiation">‚ò¢Ô∏è Radiation</option>
                                    <option value="exhausted">üò¥ Exhausted</option>
                                    <option value="dehydrated">üíß Dehydrated</option>
                                    <option value="hypothermia">üßä Hypothermia</option>
                                    <option value="heatstroke">üî• Heat Exhaustion</option>
                                    <option value="broken_bone">ü¶¥ Broken Bone</option>
                                    <option value="stunned">‚ö° Stunned</option>
                                    <option value="feared">üò± Feared</option>
                                    <option value="inspired">‚ú® Inspired</option>
                                    <option value="custom">‚öôÔ∏è Custom</option>
                                </select>

                                <input type="text" id="custom-status-name" class="status-input"
                                    placeholder="Custom effect name" style="display: none;">

                                <div class="status-options">
                                    <input type="number" id="status-duration" class="duration-input" value="10" min="1"
                                        max="1440">
                                    <span class="duration-label">minutes</span>
                                </div>

                                <input type="text" id="status-notes" class="status-notes"
                                    placeholder="Additional notes...">

                                <button class="add-status-btn" onclick="addStatusEffect()">
                                    <i class="ra ra-flask"></i>
                                    Apply Effect
                                </button>
                            </div>
                        </div>
                        -->
                    </div>
                </div>
            </section>

            <!-- Chat Tab -->
            <section class="tab-content" id="chat">
                <div class="content-wrapper">
                    <!-- Session Connection -->
                    <div class="session-connection">
                        <div class="session-controls">
                            <input type="text" id="session-code-input" placeholder="Paste connection URL from storyteller">
                            <button class="join-session-btn" onclick="joinGameSession()">Join Game</button>
                        </div>
                        <div class="connection-status">
                            <span class="status-dot" id="connection-status-dot"></span>
                            <span class="status-text" id="connection-status-text">Not connected</span>
                        </div>
                    </div>

                    <!-- Chat Messages Area -->
                    <div class="chat-messages-area">
                        <!-- Connection toggle button (shown when connected) -->
                        <div class="connection-toggle" id="connection-toggle" style="display: none;">
                            <div class="toggle-controls">
                                <button class="toggle-connection-btn" onclick="toggleConnectionArea()" title="Show connection settings">
                                    <span class="material-icons">settings</span>
                                    Connection
                                </button>
                                
                                <!-- Notification icons (future features) -->
                                <div class="notification-icons">
                                    <button class="notification-btn" id="notes-notification" style="display: none;" title="New direct message/note">
                                        <span class="material-icons">mail</span>
                                        <span class="notification-dot"></span>
                                    </button>
                                    <button class="notification-btn" id="dice-notification" style="display: none;" title="Dice roll request">
                                        <span class="material-icons">casino</span>
                                        <span class="notification-dot"></span>
                                    </button>
                                    <button class="notification-btn" id="map-notification" style="display: none;" title="Map update">
                                        <span class="material-icons">map</span>
                                        <span class="notification-dot"></span>
                                    </button>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Layout: Messages + Command Center -->
                        <div class="chat-layout">
                            <div id="chat-messages">
                                <div class="chat-message system">
                                    <span class="message-author">System:</span>
                                    Welcome to DCC! Enter a session code above to join your game.
                                </div>
                            </div>
                            
                            <!-- Command Center Panel -->
                            <div class="command-center" id="command-center">
                                <div class="command-center-header">
                                    <h4>Command Center</h4>
                                    <button class="minimize-btn" onclick="toggleCommandCenter()" title="Toggle Command Center">
                                        <span class="material-icons">keyboard_arrow_right</span>
                                    </button>
                                </div>
                                
                                <div class="command-center-content">
                                    <!-- Connected Players -->
                                    <div class="player-selector">
                                        <h5>Connected Players</h5>
                                        <div class="player-list" id="connected-players">
                                            <div class="player-item self">
                                                <div class="player-avatar">
                                                    <div class="avatar-placeholder">üë§</div>
                                                </div>
                                                <div class="player-info">
                                                    <div class="player-name" id="self-player-name">You</div>
                                                    <div class="player-details">Lvl: 1<br>Unknown - Unknown</div>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                    
                                    <!-- Collapsible Quick Tools -->
                                    <div class="quick-tools">
                                        <div class="tools-header" onclick="toggleQuickTools()">
                                            <h5>Quick Tools</h5>
                                            <span class="chevron" id="tools-chevron">‚ñº</span>
                                        </div>
                                        <div class="tools-content" id="tools-content">
                                            <!-- Image Upload Tool -->
                                            <div class="quick-actions">
                                                <h6>Image Upload</h6>
                                                <div class="action-buttons">
                                                    <button id="v4-image-upload-btn" class="action-btn" title="Upload Image">
                                                        <span>üì∑</span>
                                                        <span>Upload Image</span>
                                                    </button>
                                                </div>
                                            </div>
                                            
                                            <!-- Temporarily commented out - Quick Actions
                                            <div class="quick-actions">
                                                <h6>Actions</h6>
                                                <div class="action-buttons">
                                                    <button class="action-btn" onclick="quickDiceRoll()" title="Roll d20">
                                                        <span class="material-icons">casino</span>
                                                        <span>d20</span>
                                                    </button>
                                                    <button class="action-btn" onclick="showChatEffects()" title="Chat Effects">
                                                        <span>‚ú®</span>
                                                        <span>Effects</span>
                                                    </button>
                                                    <button class="action-btn" onclick="sendEmoji('üëç')" title="Thumbs Up">
                                                        <span>üëç</span>
                                                    </button>
                                                    <button class="action-btn" onclick="sendEmoji('‚ù§Ô∏è')" title="Heart">
                                                        <span>‚ù§Ô∏è</span>
                                                    </button>
                                                </div>
                                            </div>
                                            -->
                                            
                                            <!-- Chat Effects Quick Access -->
                                            <div class="effects-quick">
                                                <h6>Quick Effects</h6>
                                                <div class="effects-buttons">
                                                    <button class="effect-btn" onclick="insertChatEffect(':crit:')" title="Critical Hit">
                                                        ‚öîÔ∏è Crit
                                                    </button>
                                                    <button class="effect-btn" onclick="insertChatEffect(':magic:')" title="Magic Sparkle">
                                                        ‚ú® Magic
                                                    </button>
                                                    <button class="effect-btn" onclick="insertChatEffect(':doom:')" title="Doom">
                                                        üíÄ Doom
                                                    </button>
                                                    <button class="effect-btn" onclick="insertChatEffect(':dice:')" title="Dice Roll">
                                                        üé≤ Dice
                                                    </button>
                                                </div>
                                            </div>
                                        </div>
                                    </div>
                                </div>
                            </div>
                        </div>
                        
                        <!-- Chat Input -->
                        <div class="chat-input-container">
                            <div class="chat-tools">
                                <button class="chat-tool-btn" onclick="showChatPicker()" title="Chat Effects & Emojis">
                                    <span>üí¨</span>
                                    <span>Effects</span>
                                </button>
                            </div>
                            <div class="chat-input-area">
                                <input type="text" id="chat-input" placeholder="Type your message..." onkeypress="handleChatKeyPress(event)">
                            </div>
                            <button class="send-chat-btn" onclick="sendMessage()" id="send-chat-btn" disabled>Send</button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notes Tab -->
            <section class="tab-content" id="notes">
                <div class="content-wrapper">
                    <div class="notes-header">
                        <h2><i class="ra ra-journal"></i> Campaign Notes</h2>
                        <button class="save-notes-btn" onclick="saveNotesToCharacter()">
                            <span class="material-icons">save</span>
                            Save Notes
                        </button>
                    </div>

                    <div class="notes-grid">
                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-hood"></i>
                                <h3>Personal</h3>
                            </div>
                            <textarea id="personal-notes" class="note-textarea"
                                placeholder="Character thoughts, development, personal goals..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-key"></i>
                                <h3>Party</h3>
                            </div>
                            <textarea id="party-notes" class="note-textarea"
                                placeholder="Party members, relationships, group dynamics..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-quill-ink"></i>
                                <h3>Session</h3>
                            </div>
                            <textarea id="session-notes" class="note-textarea"
                                placeholder="What happened this session..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-gold-bar"></i>
                                <h3>Trade</h3>
                            </div>
                            <textarea id="barter-notes" class="note-textarea"
                                placeholder="Merchants, deals, debts, opportunities..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-compass"></i>
                                <h3>World</h3>
                            </div>
                            <textarea id="world-notes" class="note-textarea"
                                placeholder="Locations, lore, important places..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-crossed-swords"></i>
                                <h3>Combat</h3>
                            </div>
                            <textarea id="combat-notes" class="note-textarea"
                                placeholder="Enemy tactics, weaknesses, strategies..."></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Storage Manager Tab -->
            <section class="tab-content" id="storage">
                <div class="content-wrapper">
                    <div class="notes-header">
                        <h2>üóÑÔ∏è Storage Manager</h2>
                        <button class="save-notes-btn" onclick="refreshStorageStats()">
                            <span class="material-icons">refresh</span>
                            Refresh Stats
                        </button>
                    </div>

                    <div class="notes-grid">
                        <div class="note-card">
                            <div class="note-header">
                                <span>üìä</span>
                                <h3>Storage Usage</h3>
                            </div>
                            <div id="storage-stats-display" style="padding: 15px; font-family: monospace; background: var(--bg-secondary); border-radius: 4px; margin: 10px 0;">
                                <div style="color: var(--text-secondary);">Loading storage statistics...</div>
                            </div>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <span>üõ†Ô∏è</span>
                                <h3>Storage Actions</h3>
                            </div>
                            <div style="padding: 15px;">
                                <button class="save-notes-btn" onclick="migratePlayerStorage()" style="width: 100%; margin-bottom: 10px;">
                                    üì¶ Migrate to IndexedDB
                                </button>
                                <button class="save-notes-btn" onclick="cleanupPlayerStorage()" style="width: 100%; margin-bottom: 10px; background: var(--warning-gradient);">
                                    üßπ Cleanup Old Data
                                </button>
                                <button class="save-notes-btn" onclick="exportPlayerData()" style="width: 100%; background: var(--success-gradient);">
                                    üíæ Export Character Data
                                </button>
                            </div>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <span>üìã</span>
                                <h3>Data Items</h3>
                            </div>
                            <div id="storage-items-display" style="padding: 15px; max-height: 300px; overflow-y: auto; font-family: monospace; font-size: 0.85em; background: var(--bg-secondary); border-radius: 4px; margin: 10px 0;">
                                <div style="color: var(--text-secondary);">Loading data items...</div>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reference/How the Game Works Tab -->
            <section class="tab-content" id="reference">
                <div class="content-wrapper">
                    <div class="card">
                        <div class="card-header">
                            <i class="material-icons">help_outline</i>
                            <h3>How the Game Works</h3>
                        </div>
                        <div class="reference-loading">
                            <div class="loading-spinner"></div>
                            <p>Loading game reference...</p>
                        </div>
                        <div class="reference-content" id="reference-content" style="display: none;">
                            <!-- Markdown content will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Character Landing Screen (Initially visible, managed by JS) -->
    <div id="character-landing" class="character-landing" style="display: none;">
        <div class="landing-header">
            <h1><i class="ra ra-knight-helmet"></i> Dungeon Crawler</h1>
            <p>Choose your character or create a new one</p>
        </div>

        <div class="landing-actions">
            <button class="landing-btn primary-btn" onclick="createNewCharacter()">
                <span class="material-icons">person_add</span>
                New Character
            </button>
            <button class="landing-btn secondary-btn" onclick="importCharacterToManager()">
                <span class="material-icons">upload</span>
                Import Character
            </button>
            <button class="landing-btn secondary-btn" onclick="exportAllCharacters()">
                <span class="material-icons">download</span>
                Export All
            </button>
        </div>

        <div class="characters-grid" id="characters-grid">
            <!-- Character cards will be populated here -->
        </div>

        <div class="landing-footer">
            <p>Characters are saved locally in your browser. Use Export to backup your characters.</p>
        </div>
    </div>

    <!-- Layout Selection Modal -->
    <div id="layout-selection-modal" class="modal" style="display: none;">
        <div class="modal-content layout-modal-content">
            <div class="modal-header">
                <h3>Choose Card Layout</h3>
                <button class="close-modal" onclick="closeLayoutSelectionModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <p class="layout-instructions">Select the type of character card you'd like to generate:</p>
                
                <div class="layout-grid">
                    <div class="layout-option" onclick="generateSelectedLayout('portrait')">
                        <div class="layout-preview portrait-preview">
                            <div class="preview-avatar"></div>
                            <div class="preview-name">Character Name</div>
                            <div class="preview-stats">
                                <div class="preview-stat-line"></div>
                                <div class="preview-stat-line"></div>
                                <div class="preview-stat-line"></div>
                            </div>
                            <div class="preview-decorative"></div>
                        </div>
                        <h4>Portrait Card</h4>
                        <p>Character portrait with key stats. Perfect for sharing on social media.</p>
                    </div>

                    <div class="layout-option" onclick="generateSelectedLayout('stat-sheet')">
                        <div class="layout-preview stat-sheet-preview">
                            <div class="preview-mini-avatar"></div>
                            <div class="preview-title">Character Sheet</div>
                            <div class="preview-stats-grid">
                                <div class="preview-stat-block"></div>
                                <div class="preview-stat-block"></div>
                                <div class="preview-stat-block"></div>
                                <div class="preview-stat-block"></div>
                            </div>
                        </div>
                        <h4>Stat Sheet</h4>
                        <p>Compact format showing detailed character statistics and abilities.</p>
                    </div>

                    <div class="layout-option" onclick="generateSelectedLayout('full-sheet')">
                        <div class="layout-preview full-sheet-preview">
                            <div class="preview-graph-paper">
                                <div class="preview-header-section"></div>
                                <div class="preview-content-grid">
                                    <div class="preview-section"></div>
                                    <div class="preview-section"></div>
                                    <div class="preview-section"></div>
                                    <div class="preview-section"></div>
                                </div>
                            </div>
                        </div>
                        <h4>Full Character Sheet</h4>
                        <p>Complete character sheet with classic graphing paper background - nostalgic D&D style!</p>
                    </div>

                    <div class="layout-option" onclick="generateSelectedLayout('combat-card')">
                        <div class="layout-preview combat-preview">
                            <div class="preview-combat-header"></div>
                            <div class="preview-hp-section">
                                <div class="preview-hp-bar"></div>
                                <div class="preview-mp-bar"></div>
                            </div>
                            <div class="preview-equipment">
                                <div class="preview-weapon"></div>
                                <div class="preview-armor"></div>
                            </div>
                        </div>
                        <h4>Combat Card</h4>
                        <p>Quick reference for combat - HP, weapons, spells, and key stats.</p>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Card Modal -->
    <div id="card-modal" class="modal" style="display: none;">
        <div class="modal-content card-modal-content">
            <div class="modal-header">
                <h3>Character Card</h3>
                <button class="close-modal" onclick="closeCardModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-display">
                    <canvas id="card-canvas"></canvas>
                </div>
                <p class="card-instructions">
                    <i class="material-icons">info</i>
                    Beautiful character card with embedded data for easy sharing!
                </p>
                <div class="card-actions">
                    <button class="action-btn secondary-btn" onclick="downloadCharacterCard()">
                        <span class="material-icons">download</span>
                        Save Card
                    </button>
                    <button class="action-btn primary-btn" onclick="shareCharacterCard()">
                        <span class="material-icons">share</span>
                        Share
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Character Card Load Modal -->
    <div id="card-scanner-modal" class="modal" style="display: none;">
        <div class="modal-content card-scanner-modal-content">
            <div class="modal-header">
                <h3>Load Character Card</h3>
                <button class="close-modal" onclick="closeCardScannerModal()">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div class="card-upload-area">
                    <div class="upload-instructions">
                        <i class="material-icons">upload_file</i>
                        <h4>Select Character Card</h4>
                        <p>Choose a PNG character card file to load the embedded character data.</p>
                    </div>
                    <input type="file" id="card-upload" accept="image/*" onchange="handleCardUpload(event)" style="display: none;">
                    <button class="upload-btn" onclick="document.getElementById('card-upload').click()">
                        <span class="material-icons">folder_open</span>
                        Choose File
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Roll History Modal -->
    <div id="roll-history-modal" class="modal level-up-modal-overlay" style="display: none;">
        <div class="modal-content level-up-modal-content">
            <div class="modal-header">
                <h3><i class="ra ra-perspective-dice-six"></i> Roll History</h3>
                <button class="close-modal" onclick="closeRollHistoryModal()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer;">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="max-height: 400px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #ffd700 rgba(255,255,255,0.1);">
                    <div id="roll-history-modal-content" class="roll-history">
                        <div style="text-align: center; color: #8a8a8a; padding: 40px;">
                            <i class="ra ra-perspective-dice-six" style="font-size: 3em; margin-bottom: 15px; display: block;"></i>
                            No rolls yet! Click attributes, skills, weapons, or spells in the Character tab to start rolling.
                        </div>
                    </div>
                </div>
                <div style="margin-top: 15px; text-align: center;">
                    <button class="action-btn" onclick="clearRollHistory()" style="background: rgba(139, 69, 19, 0.8); color: white; border: none; padding: 8px 16px; border-radius: 4px; cursor: pointer;">
                        <span class="material-icons" style="vertical-align: middle; margin-right: 5px;">clear_all</span>
                        Clear History
                    </button>
                </div>
            </div>
        </div>
    </div>

    <!-- Status Effects Modal -->
    <div id="status-effects-modal" class="modal level-up-modal-overlay" style="display: none;">
        <div class="modal-content level-up-modal-content">
            <div class="modal-header">
                <h3><i class="ra ra-heart"></i> Status Effects</h3>
                <button class="close-modal" onclick="closeStatusEffectsModal()" style="background: transparent; border: none; color: white; font-size: 24px; cursor: pointer;">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="modal-body">
                <div style="max-height: 300px; overflow-y: auto; scrollbar-width: thin; scrollbar-color: #ffd700 rgba(255,255,255,0.1); margin-bottom: 20px;">
                    <div id="status-effects-modal-content">
                        <div style="grid-column: 1 / -1; text-align: center; color: #8a8a8a; padding: 40px;">
                            <i class="ra ra-heart" style="font-size: 3em; margin-bottom: 15px; display: block;"></i>
                            No active status effects. You're feeling healthy!
                        </div>
                    </div>
                </div>
                <div id="status-effects-form-modal-content">
                    <div class="modal-status-form-controls">
                        <h4><i class="ra ra-lightning-bolt"></i> Apply Status Effect</h4>
                        
                        <!-- Status Effect Button Grid -->
                        <div class="modal-status-effects-grid">
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('bleeding', 'Bleeding', 'ü©∏')">
                                <div class="icon">ü©∏</div>
                                <div class="name">Bleeding</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('poisoned', 'Poisoned', 'ü§¢')">
                                <div class="icon">ü§¢</div>
                                <div class="name">Poisoned</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('radiation', 'Radiation', '‚ò¢Ô∏è')">
                                <div class="icon">‚ò¢Ô∏è</div>
                                <div class="name">Radiation</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('exhausted', 'Exhausted', 'üò¥')">
                                <div class="icon">üò¥</div>
                                <div class="name">Exhausted</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('dehydrated', 'Dehydrated', 'üíß')">
                                <div class="icon">üíß</div>
                                <div class="name">Dehydrated</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('hypothermia', 'Hypothermia', 'üßä')">
                                <div class="icon">üßä</div>
                                <div class="name">Hypothermia</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('heatstroke', 'Heat Exhaustion', 'üî•')">
                                <div class="icon">üî•</div>
                                <div class="name">Heat Exhaustion</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('broken_bone', 'Broken Bone', 'ü¶¥')">
                                <div class="icon">ü¶¥</div>
                                <div class="name">Broken Bone</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('stunned', 'Stunned', '‚ö°')">
                                <div class="icon">‚ö°</div>
                                <div class="name">Stunned</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('feared', 'Feared', 'üò±')">
                                <div class="icon">üò±</div>
                                <div class="name">Feared</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('inspired', 'Inspired', '‚ú®')">
                                <div class="icon">‚ú®</div>
                                <div class="name">Inspired</div>
                            </button>
                            <button type="button" class="modal-status-btn" onclick="selectModalStatusEffect('custom', 'Custom', '‚öôÔ∏è')">
                                <div class="icon">‚öôÔ∏è</div>
                                <div class="name">Custom</div>
                            </button>
                        </div>

                        <!-- Custom Name Input (hidden by default) -->
                        <input type="text" id="modal-custom-status-name" class="status-input" placeholder="Custom effect name" style="display: none; background: rgba(40, 40, 60, 0.8); color: white; border: 1px solid rgba(255, 215, 0, 0.5); border-radius: 4px; padding: 8px; width: calc(100% - 18px); margin-bottom: 10px;">

                        <!-- Duration and Notes -->
                        <div class="status-options" style="display: flex; align-items: center; gap: 10px; margin-bottom: 10px;">
                            <input type="number" id="modal-status-duration" class="duration-input" value="10" min="1" max="1440" style="background: rgba(40, 40, 60, 0.8); color: white; border: 1px solid rgba(255, 215, 0, 0.5); border-radius: 4px; padding: 8px; width: 80px;">
                            <span class="duration-label" style="color: #c0c0c0; font-size: 14px;">minutes</span>
                        </div>

                        <input type="text" id="modal-status-notes" class="status-notes" placeholder="Additional notes..." style="background: rgba(40, 40, 60, 0.8); color: white; border: 1px solid rgba(255, 215, 0, 0.5); border-radius: 4px; padding: 8px; width: calc(100% - 18px); margin-bottom: 15px;">

                        <button class="add-status-btn" onclick="applyModalStatusEffect()" style="background: linear-gradient(135deg, #ffd700, #ffed4a); color: #1a1a2e; border: none; padding: 10px 20px; border-radius: 6px; cursor: pointer; font-weight: bold; width: 100%; transition: all 0.3s ease;">
                            <i class="ra ra-flask" style="margin-right: 8px;"></i>
                            Apply Effect
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Scripts -->
    <script src="advancedStorageManager.js"></script>
    <script src="storageMigration.js"></script>
    <script src="main.js"></script>
    <script src="character-manager.js"></script>
    <script src="cache-manager.js"></script>
    <script src="qr.js"></script>
    
    <script>
        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark-theme');
        }

        // Storage Management Functions for Player Apps
        async function refreshStorageStats() {
            try {
                let stats;
                if (window.advancedStorageManager) {
                    stats = await window.advancedStorageManager.getStorageStats();
                } else {
                    // Fallback for basic localStorage stats
                    let used = 0;
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            used += localStorage[key].length + key.length;
                        }
                    }
                    stats = {
                        localStorage: {
                            used: used,
                            usedMB: (used / (1024 * 1024)).toFixed(2),
                            percentage: Math.round((used / (5 * 1024 * 1024)) * 100)
                        }
                    };
                }

                const statsDisplay = document.getElementById('storage-stats-display');
                if (statsDisplay) {
                    statsDisplay.innerHTML = `
                        <div style="margin-bottom: 10px;">
                            <strong>localStorage:</strong> ${stats.localStorage.usedMB}MB (${stats.localStorage.percentage}%)
                        </div>
                        <div style="margin-bottom: 10px;">
                            <strong>IndexedDB:</strong> ${stats.indexedDB?.supported ? '‚úÖ Available' : '‚ùå Not Available'}
                        </div>
                        <div>
                            <strong>Platform:</strong> ${stats.cordova?.detected ? 'üì± Cordova App' : 'üåê Web Browser'}
                        </div>
                    `;
                }

                // Update items list
                const itemsDisplay = document.getElementById('storage-items-display');
                if (itemsDisplay) {
                    let itemsHtml = '<div style="display: grid; grid-template-columns: 1fr auto; gap: 10px; align-items: center;">';
                    for (let key in localStorage) {
                        if (localStorage.hasOwnProperty(key)) {
                            const size = localStorage[key].length;
                            const sizeMB = (size / (1024 * 1024)).toFixed(3);
                            const isLarge = size > 50000;
                            
                            itemsHtml += `
                                <span style="color: var(--text-primary);">${key}</span>
                                <span style="color: ${isLarge ? 'var(--warning)' : 'var(--text-secondary)'};">${sizeMB}MB ${isLarge ? '‚ö†Ô∏è' : ''}</span>
                            `;
                        }
                    }
                    itemsHtml += '</div>';
                    itemsDisplay.innerHTML = itemsHtml;
                }
            } catch (error) {
                console.error('Storage stats error:', error);
                const statsDisplay = document.getElementById('storage-stats-display');
                if (statsDisplay) {
                    statsDisplay.innerHTML = '<div style="color: var(--error);">‚ùå Failed to load storage statistics</div>';
                }
            }
        }

        async function migratePlayerStorage() {
            try {
                if (!window.advancedStorageManager) {
                    alert('‚ùå Advanced storage manager not available');
                    return;
                }

                if (!window.storageMigration) {
                    alert('‚ùå Storage migration not available');
                    return;
                }

                const confirmMsg = 'üì¶ This will move large data to IndexedDB to free up localStorage space. Continue?';
                if (!confirm(confirmMsg)) return;

                await window.storageMigration.runMigration();
                alert('‚úÖ Migration completed successfully!');
                refreshStorageStats();
            } catch (error) {
                console.error('Migration error:', error);
                alert('‚ùå Migration failed: ' + error.message);
            }
        }

        async function cleanupPlayerStorage() {
            if (!confirm('üßπ This will migrate large data to IndexedDB and remove old cache items. Continue?')) {
                return;
            }

            try {
                if (window.storageMigration) {
                    const itemsProcessed = await window.storageMigration.emergencyCleanup();
                    alert(`üßπ Cleanup completed! Processed ${itemsProcessed} items. Characters should now load from IndexedDB.`);
                    refreshStorageStats();
                    
                    // Reload character manager to use new storage
                    if (typeof initializeCharacterManager === 'function') {
                        await initializeCharacterManager();
                    }
                } else {
                    alert('‚ùå Storage migration not available');
                }
            } catch (error) {
                console.error('Cleanup error:', error);
                alert('‚ùå Cleanup failed: ' + error.message);
            }
        }

        async function exportPlayerData() {
            try {
                const data = {};
                
                // Export localStorage data
                for (let key in localStorage) {
                    if (localStorage.hasOwnProperty(key)) {
                        try {
                            data[key] = JSON.parse(localStorage[key]);
                        } catch (e) {
                            data[key] = localStorage[key];
                        }
                    }
                }

                // Create download
                const dataStr = JSON.stringify(data, null, 2);
                const dataBlob = new Blob([dataStr], { type: 'application/json' });
                const url = URL.createObjectURL(dataBlob);
                
                const link = document.createElement('a');
                link.href = url;
                link.download = `dcc-player-backup-${new Date().toISOString().split('T')[0]}.json`;
                link.click();
                
                URL.revokeObjectURL(url);
                alert('üíæ Character data exported successfully!');
            } catch (error) {
                console.error('Export failed:', error);
                alert('‚ùå Export failed: ' + error.message);
            }
        }

        // Auto-load storage stats when storage tab is opened
        document.addEventListener('DOMContentLoaded', () => {
            // Monitor tab changes to load storage stats
            const storageTab = document.querySelector('[data-tab="storage"]');
            if (storageTab) {
                storageTab.addEventListener('click', () => {
                    setTimeout(refreshStorageStats, 100);
                });
            }
        });

        // Accent Theme System
        function setAccentTheme(themeName) {
            // Remove existing theme from both html and body
            document.documentElement.removeAttribute('data-accent-theme');
            document.body.removeAttribute('data-accent-theme');
            document.querySelectorAll('.theme-color-btn').forEach(btn => btn.classList.remove('active'));
            
            // Set new theme on both html and body
            if (themeName !== 'default') {
                document.documentElement.setAttribute('data-accent-theme', themeName);
                document.body.setAttribute('data-accent-theme', themeName);
            }
            
            // Update active button
            const activeBtn = document.querySelector(`[data-theme="${themeName}"]`);
            if (activeBtn) {
                activeBtn.classList.add('active');
            }
            
            // Save to localStorage
            localStorage.setItem('accentTheme', themeName);
        }

        // Load saved accent theme
        const savedAccentTheme = localStorage.getItem('accentTheme') || 'default';
        setAccentTheme(savedAccentTheme);

        // Initialize accent theme selectors
        document.addEventListener('DOMContentLoaded', () => {
            // Add click handlers to theme buttons
            document.querySelectorAll('.theme-color-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const themeName = btn.dataset.theme;
                    setAccentTheme(themeName);
                });
            });
        });

        // Mobile optimizations
        document.addEventListener('DOMContentLoaded', () => {
            // Prevent zoom on input focus (iOS)
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    document.querySelector('meta[name="viewport"]').setAttribute('content',
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                });
                input.addEventListener('blur', () => {
                    document.querySelector('meta[name="viewport"]').setAttribute('content',
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                });
            });

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    switchTab(tabName);

                    // Update active states
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Ability navigation
            document.querySelectorAll('.ability-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const abilityName = btn.dataset.ability;

                    // Update active states
                    document.querySelectorAll('.ability-nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.ability-panel').forEach(p => p.classList.remove('active'));

                    btn.classList.add('active');
                    document.getElementById(`${abilityName}-content`).classList.add('active');
                });
            });

            // Portrait upload
            document.getElementById('portrait-display').addEventListener('click', () => {
                document.getElementById('portrait-upload').click();
            });
        });
    </script>

    <script src="skills.js"></script>
    <script src="improvements.js"></script>
    <script src="achievements.js"></script>
    <script src="levelSystem.js"></script>
    <!-- <script src="debug-dcc.js"></script> -->
    <script>
        // PWA Service Worker Registration - DISABLED TO PREVENT CACHING ISSUES
        /* 
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (registration) {
                        console.log('DCC Character Sheet: Service Worker registered successfully:', registration.scope);
                    })
                    .catch(function (error) {
                        console.log('DCC Character Sheet: Service Worker registration failed:', error);
                    });
            });
        }
        */
        console.log('üö´ Service Worker disabled - using browser cache only for better development experience');

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button
            const installBtn = document.createElement('button');
            installBtn.textContent = 'üì± Install App';
            installBtn.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        `;
            installBtn.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                });
            };
            document.body.appendChild(installBtn);
        });
    </script>

    <!-- Network Integration Scripts -->
    <script src="https://unpkg.com/@supabase/supabase-js@2"></script>
    <script src="supabaseUrlEncoder.js"></script>
    <script src="supabase-config.js"></script>
    
    <!-- Essential modules for chat system -->
    <script src="js/modules/dccMechanics.js"></script>
    <script src="js/modules/rollCalculator.js"></script>
    <script src="js/modules/jsonDataLoader.js"></script>
    <script src="js/modules/dccUtilities.js"></script>
    <script src="js/modules/chatCommandParser.js"></script>
    
    <!-- Image Hosting System -->
    <script src="js/githubTokenStorage.js"></script>
    <script src="js/githubImageHost.js"></script>
    <script src="js/multiImageHost.js"></script>
    <script src="js/chatImageSystem.js"></script>
    <script src="js/githubImageTesting.js"></script>
    <script src="js/githubImageAutoInit.js"></script>
    
    <script src="js/command-interceptor.js"></script>
    <script src="js/modules/chatEffectsManager.js"></script>
    <script src="js/modules/emojiProcessor.js"></script>
    
    <script src="supabase-chat.js"></script>
    
    <!-- Network Integration Functions -->
    <script>
        // Network integration variables
        let isNetworkConnected = false;
        let currentSessionCode = '';
        let networkPlayerName = '';

        // Set network player name (called by character manager)
        function setNetworkPlayerName(playerName) {
            networkPlayerName = playerName;
            console.log('üé≠ Network player name set to:', playerName);
        }
        window.setNetworkPlayerName = setNetworkPlayerName;

        // Show creation tab (called by New Character button)
        function showCreationTab() {
            const creationTab = document.querySelector('[data-tab="creation"]');
            if (creationTab) {
                creationTab.style.display = 'flex';
                // Switch to creation tab
                switchTab('creation');
            }
        }
        window.showCreationTab = showCreationTab;

        // Initialize network integration when page loads
        document.addEventListener('DOMContentLoaded', function() {
            console.log('üåê V4-Network: Initializing network features...');
            
            // Check for session code in URL first
            const urlParams = new URLSearchParams(window.location.search);
            const sessionFromUrl = urlParams.get('session');
            
            if (sessionFromUrl) {
                document.getElementById('session-code-input').value = sessionFromUrl;
                console.log('üìé Session code found in URL:', sessionFromUrl);
            } else {
                // Load last saved connection URL
                const lastUrl = localStorage.getItem('lastConnectionUrl');
                if (lastUrl) {
                    document.getElementById('session-code-input').value = lastUrl;
                    console.log('üìé Loaded saved connection URL:', lastUrl);
                }
            }
            
            // Show session connection area by default (not connected on load)
            document.querySelector('.session-connection').style.display = 'block';
            
            // Hide connection toggle button on load
            document.getElementById('connection-toggle').style.display = 'none';
            
            // Set up player click handlers for NOTE functionality
            setupPlayerClickHandlers();
            
            // Set up notification button click handler
            const notesBtn = document.getElementById('notes-notification');
            if (notesBtn) {
                notesBtn.addEventListener('click', showNotesDropdown);
            }
            
            // Test notification system
            console.log('üß™ Testing notification system...');
            const testContainer = document.getElementById('notification-container');
            console.log('üß™ Notification container found:', !!testContainer);
            if (typeof showNotification === 'function') {
                console.log('üß™ showNotification function available');
                // Test attribute roll notification - DISABLED
                /*
                setTimeout(() => {
                    console.log('üß™ Testing notification display...');
                    showNotification('roll', 'Test Notification', 'This is a test', 'Testing notification system');
                }, 2000);
                */
            } else {
                console.error('üß™ showNotification function not found');
            }
            
            // Test click handlers after a delay to ensure player list is populated
            setTimeout(() => {
                console.log('üß™ Testing clickable player names...');
                const clickableNames = document.querySelectorAll('.clickable-player-name');
                console.log('üß™ Found clickable names:', clickableNames.length);
                clickableNames.forEach((name, index) => {
                    console.log(`üß™ Clickable name ${index}:`, name.textContent, 'data-player-name:', name.getAttribute('data-player-name'));
                });
            }, 5000);
        });

        // Toggle connection area visibility
        function toggleConnectionArea() {
            const connectionArea = document.querySelector('.session-connection');
            const toggleBtn = document.getElementById('connection-toggle');
            
            if (connectionArea.style.display === 'none') {
                connectionArea.style.display = 'block';
                toggleBtn.style.display = 'none';
            } else {
                connectionArea.style.display = 'none';
                if (isNetworkConnected) {
                    toggleBtn.style.display = 'block';
                }
            }
        }

        // Notification system helpers (for future features)
        function showNotificationIcon(type) {
            const notificationBtn = document.getElementById(`${type}-notification`);
            if (notificationBtn) {
                notificationBtn.style.display = 'flex';
                console.log(`üì¢ ${type} notification icon shown`);
            }
        }

        function hideNotificationIcon(type) {
            const notificationBtn = document.getElementById(`${type}-notification`);
            if (notificationBtn) {
                notificationBtn.style.display = 'none';
                console.log(`üì¢ ${type} notification icon hidden`);
            }
        }

        // Example usage for testing notifications (can be called from console)
        function testNotifications() {
            setTimeout(() => showNotificationIcon('notes'), 2000);
            setTimeout(() => showNotificationIcon('dice'), 4000);
            setTimeout(() => showNotificationIcon('map'), 6000);
            console.log('üß™ Test notification icons will appear in 2, 4, and 6 seconds');
        }

        // Make test function globally available
        window.testNotifications = testNotifications;

        // Command Center functions
        function toggleCommandCenter() {
            const commandCenter = document.getElementById('command-center');
            const minimizeBtn = commandCenter.querySelector('.minimize-btn .material-icons');
            
            commandCenter.classList.toggle('minimized');
            
            if (commandCenter.classList.contains('minimized')) {
                minimizeBtn.textContent = 'keyboard_arrow_left';
            } else {
                minimizeBtn.textContent = 'keyboard_arrow_right';
            }
        }

        function quickDiceRoll() {
            const roll = Math.floor(Math.random() * 20) + 1;
            const message = `üé≤ Quick d20 roll: **${roll}** :dice:`;
            
            if (isNetworkConnected) {
                sendChatMessageDirect(message);
            } else {
                addChatMessage(message, 'system', 'Dice');
            }
        }

        function showChatEffects() {
            // This will be implemented when we add the effects picker
            console.log('Chat effects picker would open here');
            alert('Chat effects picker coming soon! For now, try typing :crit:, :magic:, :doom:, or :dice: in your messages.');
        }

        function sendEmoji(emoji) {
            if (isNetworkConnected) {
                sendChatMessageDirect(emoji);
            } else {
                addChatMessage(emoji, 'player', networkPlayerName || 'You');
            }
        }

        function insertChatEffect(effect) {
            const chatInput = document.getElementById('chat-input');
            const currentText = chatInput.value;
            
            // Insert effect at cursor position or append to end
            const cursorPos = chatInput.selectionStart;
            const before = currentText.substring(0, cursorPos);
            const after = currentText.substring(cursorPos);
            
            // Add space before effect if needed
            const prefix = (before && !before.endsWith(' ')) ? ' ' : '';
            const suffix = (after && !after.startsWith(' ')) ? ' ' : '';
            
            chatInput.value = before + prefix + effect + suffix + after;
            chatInput.focus();
            
            // Position cursor after the inserted effect
            const newPos = cursorPos + prefix.length + effect.length + suffix.length;
            chatInput.setSelectionRange(newPos, newPos);
        }

        // Helper function to send chat messages directly
        async function sendChatMessageDirect(message) {
            try {
                if (typeof window.sendChatMessageAsync === 'function') {
                    await window.sendChatMessageAsync(message);
                } else if (typeof window.sendChatMessage === 'function') {
                    await window.sendChatMessage(message);
                } else {
                    console.warn('Chat functions not available');
                }
            } catch (error) {
                console.error('Failed to send message:', error);
            }
        }

        // Update player name in command center when network player name changes
        function updateCommandCenterPlayerName() {
            const selfPlayerName = document.getElementById('self-player-name');
            const selfPlayerDetails = document.querySelector('.player-item.self .player-details');
            const selfPlayerAvatar = document.querySelector('.player-item.self .avatar-placeholder');
            
            if (selfPlayerName && networkPlayerName) {
                selfPlayerName.textContent = networkPlayerName;
            }
            
            // Get real character data
            const characterData = getCurrentCharacterData();
            
            // Update self player details with real data
            if (selfPlayerDetails) {
                selfPlayerDetails.innerHTML = `Lvl: ${characterData.level}<br>${characterData.heritage} - ${characterData.class}`;
            }
            
            // Update avatar if available
            if (selfPlayerAvatar && characterData.avatar) {
                const avatarImg = document.createElement('img');
                avatarImg.src = characterData.avatar;
                avatarImg.style.width = '100%';
                avatarImg.style.height = '100%';
                avatarImg.style.objectFit = 'cover';
                selfPlayerAvatar.parentNode.innerHTML = '';
                selfPlayerAvatar.parentNode.appendChild(avatarImg);
            }
        }

        // Extract current character data from V4 character tab
        function getCurrentCharacterData() {
            const levelElement = document.getElementById('char-level-display');
            const summaryElement = document.getElementById('char-summary');
            const portraitElement = document.getElementById('overview-portrait');
            
            // Extract level (e.g., "Level 1" -> "1")
            let level = '1';
            if (levelElement && levelElement.textContent) {
                const levelMatch = levelElement.textContent.match(/Level (\d+)/);
                if (levelMatch) {
                    level = levelMatch[1];
                }
            }
            
            // Extract heritage, background, and class from character summary
            let heritage = 'Unknown';
            let background = 'Unknown'; 
            let characterClass = 'Unknown';
            
            if (summaryElement && summaryElement.textContent) {
                const summaryText = summaryElement.textContent;
                // The summary typically contains: "Heritage Background Class" format
                const parts = summaryText.trim().split(' ');
                if (parts.length >= 3) {
                    heritage = parts[0];
                    background = parts[1];
                    characterClass = parts[2];
                } else if (parts.length === 2) {
                    heritage = parts[0];
                    characterClass = parts[1];
                } else if (parts.length === 1) {
                    characterClass = parts[0];
                }
            }
            
            // Extract avatar from overview-portrait
            let avatar = null;
            if (portraitElement) {
                const imgElement = portraitElement.querySelector('img');
                if (imgElement && imgElement.src && imgElement.src.startsWith('data:')) {
                    avatar = imgElement.src;
                }
            }
            
            return {
                level,
                heritage,
                background,
                class: characterClass,
                avatar
            };
        }

        // Function to update connected players list (called by supabase-chat.js)
        function updateConnectedPlayers(players = []) {
            const playerList = document.getElementById('connected-players');
            if (!playerList) return;
            
            console.log('üîç Updating connected players:', players);
            
            // Clear existing players except self
            const selfPlayer = playerList.querySelector('.player-item.self');
            playerList.innerHTML = '';
            
            // Add self back
            if (selfPlayer) {
                playerList.appendChild(selfPlayer);
            }
            
            // Add connected players
            players.forEach(player => {
                if (player.name && player.name !== networkPlayerName && player.name !== 'System' && player.name !== 'Heartbeat') {
                    const playerDiv = document.createElement('div');
                    playerDiv.className = 'player-item';
                    
                    // Add storyteller class if they are the storyteller
                    if (player.is_storyteller) {
                        playerDiv.classList.add('storyteller');
                    }
                    
                    // For now, use placeholder data - this can be enhanced later with real character data
                    const level = 'Unknown';
                    const heritage = player.is_storyteller ? 'Storyteller' : 'Player';
                    const playerClass = player.is_storyteller ? 'Master' : 'Adventurer';
                    
                    playerDiv.innerHTML = `
                        <div class="player-avatar">
                            <div class="avatar-placeholder">${player.is_storyteller ? 'üëë' : '‚öîÔ∏è'}</div>
                        </div>
                        <div class="player-info">
                            <div class="player-name clickable-player-name" data-player-name="${player.name}">${player.name}</div>
                            <div class="player-details">Level: ${level}<br>${heritage} - ${playerClass}</div>
                        </div>
                    `;
                    
                    playerList.appendChild(playerDiv);
                }
            });
            
            console.log(`‚úÖ Player list updated: ${players.length} players found`);
        }

        // Make updateConnectedPlayers globally available for supabase-chat.js
        window.updateConnectedPlayers = updateConnectedPlayers;

        // Handle player name clicks for sending notes
        function setupPlayerClickHandlers() {
            const playerList = document.getElementById('connected-players');
            if (!playerList) {
                console.error('üêõ Player list not found for click handlers');
                return;
            }
            
            console.log('üêõ Setting up player click handlers on:', playerList);
            
            // Use event delegation to handle clicks on dynamically added player names
            playerList.addEventListener('click', function(event) {
                console.log('üêõ Player list clicked:', event.target);
                const clickedName = event.target.closest('.clickable-player-name');
                console.log('üêõ Closest clickable name:', clickedName);
                if (!clickedName) return;
                
                const targetPlayerName = clickedName.getAttribute('data-player-name');
                console.log('üêõ Target player name:', targetPlayerName);
                if (targetPlayerName) {
                    promptForNote(targetPlayerName);
                }
            });
        }

        // Prompt user for note content and send NOTE command
        function promptForNote(targetPlayerName) {
            console.log('üêõ promptForNote called for:', targetPlayerName);
            const noteText = prompt(`Send a note to ${targetPlayerName}:`);
            console.log('üêõ User entered note text:', noteText);
            if (noteText && noteText.trim()) {
                sendNoteCommand(targetPlayerName, noteText.trim());
            } else {
                console.log('üêõ Note cancelled or empty');
            }
        }

        // Send NOTE command through chat
        function sendNoteCommand(targetPlayerName, noteText) {
            console.log('üêõ sendNoteCommand called with:', targetPlayerName, noteText);
            
            const noteCommand = `NOTE:${targetPlayerName}:${noteText}`;
            console.log('üêõ Sending command:', noteCommand);
            
            // Method 1: Use chat input and sendMessage()
            const chatInput = document.getElementById('chat-input');
            if (chatInput && typeof sendMessage === 'function') {
                chatInput.value = noteCommand;
                sendMessage();
                console.log(`üìù Sent note to ${targetPlayerName}: ${noteText}`);
            }
            // Method 2: Try Supabase functions directly
            else if (typeof window.sendChatMessageAsync === 'function') {
                window.sendChatMessageAsync(noteCommand);
                console.log(`üìù Sent note via sendChatMessageAsync to ${targetPlayerName}: ${noteText}`);
            }
            else if (typeof window.sendChatMessage === 'function') {
                window.sendChatMessage(noteCommand);
                console.log(`üìù Sent note via sendChatMessage to ${targetPlayerName}: ${noteText}`);
            }
            else {
                console.error('‚ùå Chat send functions not available');
            }
        }

        // Note notification management
        let receivedNotes = [];
        
        function addReceivedNote(fromPlayer, noteText, timestamp) {
            console.log('üêõ addReceivedNote called:', fromPlayer, noteText, timestamp);
            const note = {
                from: fromPlayer,
                message: noteText,
                timestamp: timestamp || new Date().toISOString(),
                id: Date.now() + Math.random().toString(36).substr(2, 9)
            };
            
            receivedNotes.push(note);
            console.log('üêõ Note added to receivedNotes array. Total notes:', receivedNotes.length);
            updateNotificationIcon();
            
            // Show popup notification for received note
            if (typeof showNotification === 'function') {
                showNotification('notes', `üìù Note from ${fromPlayer}`, 
                    noteText.length > 50 ? noteText.substring(0, 50) + '...' : noteText, 
                    `Check the Notes panel to view all messages.`);
            }
            
            console.log(`üìù Received note from ${fromPlayer}: ${noteText}`);
        }

        function updateNotificationIcon() {
            const notificationBtn = document.getElementById('notes-notification');
            if (!notificationBtn) return;
            
            if (receivedNotes.length > 0) {
                notificationBtn.style.display = 'block';
                notificationBtn.title = `${receivedNotes.length} new note(s)`;
            } else {
                notificationBtn.style.display = 'none';
            }
        }

        function showNotesDropdown() {
            if (receivedNotes.length === 0) {
                alert('No notes received this session.');
                return;
            }
            
            let notesText = "üìù Notes received this session:\n\n";
            receivedNotes.forEach(note => {
                const time = new Date(note.timestamp).toLocaleTimeString();
                notesText += `From ${note.from} (${time}):\n${note.message}\n\n`;
            });
            
            alert(notesText);
        }

        // Make note functions globally available
        window.addReceivedNote = addReceivedNote;
        window.showNotesDropdown = showNotesDropdown;

        // Set up periodic player list updates
        function startPlayerListUpdates() {
            if (window.playerListInterval) {
                clearInterval(window.playerListInterval);
            }
            
            // Update player list every 30 seconds when connected
            window.playerListInterval = setInterval(() => {
                if (isNetworkConnected && typeof window.updateConnectedPlayersList === 'function') {
                    window.updateConnectedPlayersList();
                }
            }, 30000);
        }

        function stopPlayerListUpdates() {
            if (window.playerListInterval) {
                clearInterval(window.playerListInterval);
                window.playerListInterval = null;
            }
        }

        // Toggle Quick Tools section
        function toggleQuickTools() {
            const toolsContent = document.getElementById('tools-content');
            const chevron = document.getElementById('tools-chevron');
            
            toolsContent.classList.toggle('collapsed');
            chevron.classList.toggle('collapsed');
            
            if (toolsContent.classList.contains('collapsed')) {
                chevron.textContent = '‚ñ∂';
            } else {
                chevron.textContent = '‚ñº';
            }
        }

        // Send "user has joined" announcement with random effect and emoji
        async function sendJoinAnnouncement(playerName) {
            const joinEmojis = ['üéâ', '‚ú®', 'üåü', 'üéä', 'üî•', '‚ö°', 'üí´', 'üåà', 'üéØ', 'üöÄ'];
            const joinEffects = ['sparkle', 'flame', 'ice', 'pulse', 'glow'];
            const joinMessages = [
                'has joined the adventure!',
                'enters the realm!',
                'has arrived!',
                'joins the party!',
                'steps into the world!',
                'has connected!',
                'is ready for adventure!'
            ];
            
            // Pick random elements
            const randomEmoji = joinEmojis[Math.floor(Math.random() * joinEmojis.length)];
            const randomEffect = joinEffects[Math.floor(Math.random() * joinEffects.length)];
            const randomMessage = joinMessages[Math.floor(Math.random() * joinMessages.length)];
            
            // Create the announcement message with effect syntax
            const announcement = `${randomEmoji} ${playerName} ${randomMessage} [effect:${randomEffect}]`;
            
            try {
                // Send via Supabase real-time system (like regular messages)
                if (typeof window.sendChatMessageAsync === 'function') {
                    await window.sendChatMessageAsync(announcement);
                    console.log('üéâ Join announcement sent:', announcement);
                } else if (typeof window.sendChatMessage === 'function') {
                    await window.sendChatMessage(announcement);
                    console.log('üéâ Join announcement sent:', announcement);
                } else {
                    console.warn('‚ö†Ô∏è Chat functions not available for join announcement');
                    // Fallback to local display
                    addChatMessage(announcement, 'system', 'System');
                }
            } catch (error) {
                console.error('‚ùå Failed to send join announcement:', error);
                // Fallback to local display
                addChatMessage(announcement, 'system', 'System');
            }
        }

        // Join game session - works exactly like player-test.html
        async function joinGameSession() {
            const connectionUrl = document.getElementById('session-code-input').value.trim();
            if (!connectionUrl) {
                alert('Please paste the connection URL from the storyteller');
                return;
            }

            // Use network player name if set, otherwise prompt
            let playerName = networkPlayerName;
            if (!playerName) {
                playerName = prompt('Enter your player name:');
                if (!playerName) return;
            }

            updateConnectionStatus('connecting', 'Connecting...');
            
            try {
                let processedUrl = connectionUrl;
                
                // Decode URL if it's in shortened format (exactly like player-test.html)
                if (window.supabaseUrlEncoder) {
                    processedUrl = window.supabaseUrlEncoder.ensureFullUrl(connectionUrl);
                    console.log('Processed connection URL:', processedUrl);
                }
                
                // Parse the Supabase URL: https://xxx.supabase.co?session=1234
                const urlParts = processedUrl.split('?');
                const supabaseUrl = urlParts[0];
                
                if (urlParts.length < 2) {
                    throw new Error('Invalid URL format. Expected: https://xxx.supabase.co?session=1234 or shortened format');
                }
                
                // Extract session code from URL parameters
                const params = new URLSearchParams(urlParts[1]);
                const sessionCode = params.get('session');
                
                if (!sessionCode) {
                    throw new Error('No session code found in URL. Make sure the URL includes ?session=YOUR_SESSION_CODE');
                }
                
                console.log(`üîó Extracted: Supabase URL=${supabaseUrl}, Session=${sessionCode}`);
                
                // Initialize Supabase with extracted URL and default API key
                const defaultApiKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNrZGR2Ym14emVwcnZ4ZnNsaGxrIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTU5NTMxMjEsImV4cCI6MjA3MTUyOTEyMX0.b3mv50bCw5Yq5SrY8-Sagdl4WoC592nQNdfTQciuf0M';
                
                // Initialize Supabase connection
                if (typeof window.initializeSupabase === 'function') {
                    const initResult = window.initializeSupabase(supabaseUrl, defaultApiKey);
                    if (!initResult) {
                        throw new Error('Failed to initialize Supabase connection');
                    }
                } else {
                    throw new Error('Supabase initialization function not available');
                }
                
                console.log('üîå Attempting to join session:', sessionCode, 'as', playerName);
                
                // Join the session using the real Supabase system (exactly like player-test.html)
                if (typeof window.fullSupabaseConnect === 'function') {
                    const result = await window.fullSupabaseConnect(playerName, sessionCode, false, 'join');
                    
                    if (result.success) {
                        isNetworkConnected = true;
                        currentSessionCode = sessionCode;
                        
                        // Store the original connection URL for future reference
                        localStorage.setItem('lastConnectionUrl', connectionUrl);
                        
                        // Keep the original URL in the input field for easy reconnection
                        document.getElementById('session-code-input').value = connectionUrl;
                        
                        // Hide session connection area to give more room for chat
                        document.querySelector('.session-connection').style.display = 'none';
                        
                        // Show connection toggle button when connected
                        document.getElementById('connection-toggle').style.display = 'block';
                        
                        updateConnectionStatus('connected', `Connected as ${playerName}`);
                        
                        addChatMessage('system', 'Successfully connected to game session!');
                        
                        // Send "user has joined" message with random effect and emoji
                        sendJoinAnnouncement(playerName);
                        
                        // Update command center with player name
                        updateCommandCenterPlayerName();
                        
                        // Update connected players list
                        if (typeof window.updateConnectedPlayersList === 'function') {
                            setTimeout(() => {
                                window.updateConnectedPlayersList();
                            }, 2000); // Wait a bit for our join message to register
                        }
                        
                        // Start periodic player list updates
                        startPlayerListUpdates();
                        
                        document.getElementById('send-chat-btn').disabled = false;
                        
                        console.log('‚úÖ Successfully connected to session');
                    } else {
                        throw new Error(result.error || 'Failed to connect');
                    }
                } else {
                    throw new Error('fullSupabaseConnect function not available');
                }
                
            } catch (error) {
                console.error('‚ùå Connection failed:', error);
                updateConnectionStatus('disconnected', 'Connection failed');
                addChatMessage('system', `Connection failed: ${error.message}`);
                
                // Show session connection area again on connection failure
                document.querySelector('.session-connection').style.display = 'block';
                
                // Hide connection toggle button when disconnected
                document.getElementById('connection-toggle').style.display = 'none';
                
                // Stop player list updates
                stopPlayerListUpdates();
            }
        }

        // Send chat message - copied from player-test.html
        async function sendMessage() {
            const input = document.getElementById('chat-input');
            const message = input.value.trim();
            
            if (message && isNetworkConnected) {
                try {
                    // Send via Supabase real-time system - don't add locally (copied from player-test.html)
                    if (typeof window.sendChatMessageAsync === 'function') {
                        await window.sendChatMessageAsync(message);
                        console.log('‚úÖ Message sent via Supabase - waiting for echo');
                        input.value = '';
                    } else if (typeof window.sendChatMessage === 'function') {
                        await window.sendChatMessage(message);
                        console.log('‚úÖ Message sent via Supabase sync - waiting for echo');
                        input.value = '';
                    } else {
                        throw new Error('Supabase chat functions not available');
                    }
                } catch (error) {
                    console.error('‚ùå Failed to send message:', error);
                    addChatMessage('system', `‚ùå Failed to send: ${error.message}`);
                }
            }
        }

        // Handle enter key in chat input
        function handleChatKeyPress(event) {
            if (event.key === 'Enter') {
                sendMessage();
            }
        }

        // Update connection status UI
        function updateConnectionStatus(status, text) {
            const dot = document.getElementById('connection-status-dot');
            const statusText = document.getElementById('connection-status-text');
            
            dot.className = `status-dot ${status}`;
            statusText.textContent = text;
        }

        // Add message to chat - copied exactly from player-test.html
        function addChatMessage(message, type = 'player', sender = '') {
            // Filter out heartbeat messages
            if (type === 'heartbeat' || sender === 'Heartbeat' || 
                (typeof message === 'object' && (message.message_type === 'heartbeat' || message.player_name === 'Heartbeat'))) {
                console.log('üì° Heartbeat filtered from display');
                return;
            }
            
            const chatMessages = document.getElementById('chat-messages');
            const messageEl = document.createElement('div');
            messageEl.className = `chat-message ${type}`;
            
            // Extract message text
            const messageText = typeof message === 'object' ? message.message_text : message;
            
            // Process message for emojis first
            let processedMessage = messageText;
            if (window.emojiProcessor) {
                processedMessage = window.emojiProcessor.processMessage(processedMessage);
                if (processedMessage !== messageText) {
                    console.log(`üé≠ Emoji converted: "${messageText}" ‚Üí "${processedMessage}"`);
                }
            }
            
            // Then process message for chat effects
            if (window.chatEffectsManager) {
                const effectResult = window.chatEffectsManager.processMessage(processedMessage);
                if (effectResult.hasEffects) {
                    processedMessage = effectResult.html;
                    console.log('üé® Applied chat effects to message:', effectResult.effects);
                }
            }
            
            let prefix = '';
            if (type === 'system') {
                prefix = '<strong>System:</strong> ';
            } else if (type === 'storyteller') {
                prefix = '<strong>Storyteller:</strong> ';
            } else if (type === 'player') {
                prefix = `<strong>${sender || networkPlayerName}:</strong> `;
            }
            
            messageEl.innerHTML = prefix + processedMessage;
            chatMessages.appendChild(messageEl);
            chatMessages.scrollTop = chatMessages.scrollHeight;
            
            // Debounced reset for rapid message additions
            clearTimeout(window.chatResetTimeout);
            window.chatResetTimeout = setTimeout(() => {
                resetChatContainer();
            }, 500); // Reset after 500ms of no new messages
        }

        // Reset chat container dimensions after dynamic content changes
        function resetChatContainer() {
            const chatMessages = document.getElementById('chat-messages');
            if (chatMessages) {
                // Force recalculation of container dimensions
                chatMessages.style.height = '';
                chatMessages.style.minHeight = '';
                
                // Use requestAnimationFrame to ensure DOM updates are complete
                requestAnimationFrame(() => {
                    chatMessages.style.height = '100%';
                    chatMessages.style.minHeight = '0';
                    chatMessages.scrollTop = chatMessages.scrollHeight;
                });
            }
        }

        // Placeholder for chat picker (can be enhanced later)
        function showChatPicker() {
            alert('Chat effects coming soon! For now, just type your message normally.');
        }

        // Hook into existing character save to potentially sync to network
        // This will be expanded in Phase 2 for character synchronization
        const originalSaveCharacter = window.saveCurrentCharacterToStorage;
        if (originalSaveCharacter) {
            window.saveCurrentCharacterToStorage = function() {
                const result = originalSaveCharacter.apply(this, arguments);
                
                // Future: Add character sync to network here
                if (isNetworkConnected && character) {
                    console.log('üîÑ Character saved locally, network sync pending...');
                    // TODO: Implement character sync in Phase 2
                }
                
                return result;
            };
        }
    </script>
    
    <!-- Image Upload Integration -->
    <script src="js/chatImageUploadIntegration.js"></script>
</body>

</html>
