<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">

    <!-- Add after existing meta tags -->
    <meta name="format-detection" content="telephone=no">
    <meta name="msapplication-tap-highlight" content="no">

    <!-- PWA Manifest -->
    <link rel="manifest" href="manifest.json">
    <meta name="theme-color" content="#ff6b35">
    <meta name="apple-mobile-web-app-title" content="DCC Sheet">
    <link rel="apple-touch-icon" href="icon-192.png">
    <title>Dungeon Crawler World</title>

    <!-- Fonts - Original Google Fonts setup that was working -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;500;600;700&family=Playfair+Display:wght@400;500;600;700&family=Uncial+Antiqua&family=Merriweather:wght@400;700&display=swap" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons" rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/rpg-awesome/0.2.0/css/rpg-awesome.min.css">
    <!-- Add Montserrat font for modern look -->
    <link href="https://fonts.googleapis.com/css?family=Montserrat:400,500,700&display=swap" rel="stylesheet">
    
    <style>
        /* Original working font setup */
        body {
            font-family: 'Cinzel', 'Times New Roman', 'Georgia', serif;
        }
        
        /* Headers get the refined fantasy treatment */
        h1, h2, h3, h4, h5, h6 {
            font-family: 'Montserrat', 'Merriweather', 'Cinzel', serif;
        }
        
        /* Special elements for that ancient manuscript feel */
        .app-title, .hero-name-input, .character-landing h1 {
            font-family: 'Montserrat', Arial, serif;
        }
        
        /* Material Icons - original setup */
        .material-icons {
            font-family: 'Material Icons';
            font-weight: normal;
            font-style: normal;
            font-size: 24px;
            line-height: 1;
            letter-spacing: normal;
            text-transform: none;
            display: inline-block;
            white-space: nowrap;
            word-wrap: normal;
            direction: ltr;
            -webkit-font-feature-settings: 'liga';
            font-feature-settings: 'liga';
            -webkit-font-smoothing: antialiased;
        }
        
        /* RPG Awesome icons work with CSS file colors */

        

        .ra:empty.ra-double-team:after { content: "ÔøΩ"; }
        .ra:empty.ra-muscle-up:after { content: "ÔøΩ"; }
        .ra:empty.ra-hearts:after { content: "‚ù§Ô∏è"; }
        .ra:empty.ra-crystal-wand:after { content: "üîÆ"; }
        .ra:empty.ra-sword:after { content: "‚öîÔ∏è"; }
        .ra:empty.ra-shield:after { content: "üõ°Ô∏è"; }
        .ra:empty.ra-vest:after { content: "üëï"; }
        .ra:empty.ra-gem-pendant:after { content: "üíé"; }
        .ra:empty.ra-backpack:after { content: "üéí"; }
        
        /* Enhanced font loading detection */
        @media screen and (max-width: 768px) {
            /* Mobile-specific font adjustments */
            body {
                -webkit-font-smoothing: antialiased;
                -moz-osx-font-smoothing: grayscale;
            }
        }
        
        /* Dark mode improvements for icons and text */
        body.dark-theme .rest-btn,
        body.dark-theme .rest-btn span,
        body.dark-theme .rest-btn small,
        body.dark-theme .vital-item,
        body.dark-theme .vital-label,
        body.dark-theme .equipment-slot,
        body.dark-theme .slot-label,
        body.dark-theme .card-header h3 {
            color: #e0e0e0 !important;
        }
        
        /* Preserve icon colors in dark mode, but use slightly darker shades for contrast */
        body.dark-theme .material-icons,
        body.dark-theme .ra {
            color: inherit !important;
            filter: brightness(0.85) contrast(1.1);
        }
        
        /* Ensure buttons have proper dark mode styling */
        body.dark-theme .rest-btn {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
        }
        
        body.dark-theme .rest-btn:hover {
            background: rgba(255, 255, 255, 0.15);
        }
        
        /* Fix any remaining emoji fallback issues */
        .ra:empty:after {
            display: none !important;
        }
        
        .material-icons:empty:after {
            display: none !important;
        }
    </style>

    <!-- Custom CSS -->
    <link rel="stylesheet" href="style.css">
    <link rel="stylesheet" href="dark.css">
</head>

<body>
    <!-- Main Character Sheet (Initially hidden by JS) -->
    <div class="app-container">
        <!-- Mobile Header -->
        <header class="app-header">
            <button class="header-btn menu-btn" onclick="toggleSidebar()" title="Open Navigation Menu">
                <span class="material-icons">menu</span>
            </button>
            <button class="header-btn theme-btn" onclick="toggleTheme()" title="Toggle Theme">
                <span class="material-icons">brightness_6</span>
            </button>
            <button class="header-btn cache-btn" onclick="clearAllCaches()" title="Clear Cache (Fix Loading Issues)">
                <span class="material-icons">refresh</span>
            </button>
            <h1 class="app-title">
                <span class="character-info-display"></span>
                <div class="status-header-container" id="status-header-container">
                    <!-- Active status effects with timers will appear here -->
                </div>
            </h1>
            <button class="header-btn trophy-btn" onclick="showAchievementsModal()" title="View Achievements">
                <span class="material-icons">emoji_events</span>
            </button>
            <button class="header-btn save-btn" onclick="saveCharacterToStorage()" title="Save Character">
                <span class="material-icons">save</span>
            </button>
        </header>

        <!-- Sidebar Navigation Drawer -->
        <nav class="sidebar" id="sidebar">
            <div class="sidebar-header">
                <h2>Navigation</h2>
                <button class="close-sidebar" onclick="toggleSidebar()" title="Close Menu">
                    <span class="material-icons">close</span>
                </button>
            </div>
            <div class="sidebar-content">
                <button class="sidebar-tab active" data-tab="creation">
                    <span class="tab-icon"><i class="ra ra-quill-ink"></i></span>
                    <span class="tab-label">Create Character</span>
                </button>
                <button class="sidebar-tab" data-tab="character">
                    <span class="tab-icon"><i class="ra ra-player"></i></span>
                    <span class="tab-label">Character Stats</span>
                </button>
                <button class="sidebar-tab" data-tab="inventory">
                    <span class="tab-icon"><i class="ra ra-book"></i></span>
                    <span class="tab-label">Inventory & Gear</span>
                </button>
                <button class="sidebar-tab" data-tab="magic">
                    <span class="tab-icon"><i class="ra ra-fairy-wand"></i></span>
                    <span class="tab-label">Magic & Spells</span>
                </button>
                <button class="sidebar-tab" data-tab="combat">
                    <span class="tab-icon"><i class="ra ra-crossed-swords"></i></span>
                    <span class="tab-label">Combat & Dice</span>
                </button>
                <button class="sidebar-tab" data-tab="notes">
                    <span class="tab-icon"><i class="ra ra-scroll-unfurled"></i></span>
                    <span class="tab-label">Notes & Backstory</span>
                </button>
                <button class="sidebar-tab" data-tab="reference">
                    <span class="tab-icon"><i class="material-icons">help_outline</i></span>
                    <span class="tab-label">How the Game Works</span>
                </button>
            </div>
        </nav>

        <!-- Sidebar Overlay for Mobile -->
        <div class="sidebar-overlay" id="sidebar-overlay" onclick="toggleSidebar()"></div>

        <!-- Tab Contents -->
        <main class="tab-container">
            <!-- Character Creation Tab -->
            <section class="tab-content active" id="creation">
                <div class="content-wrapper">
                    <!-- Hero Section -->
                    <div class="hero-card">
                        <div class="portrait-section">
                            <div id="portrait-display" class="portrait-container">
                                <div class="portrait-placeholder">
                                    <i class="ra ra-hood"></i>
                                    <span>Tap to Upload</span>
                                </div>
                            </div>
                            <input type="file" id="portrait-upload" accept="image/*" style="display: none;">
                        </div>

                        <div class="hero-info">
                            <input type="text" id="char-name" class="hero-name-input" placeholder="Character Name"
                                autocomplete="off">
                            <div class="hero-meta">
                                <div class="meta-item">
                                    <label>Level</label>
                                    <input type="number" id="char-level" class="compact-input" value="1" min="1"
                                        max="20">
                                </div>
                                <div class="meta-item">
                                    <label>Age</label>
                                    <input type="number" id="char-age" class="compact-input" placeholder="25" min="0">
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Identity Cards -->
                    <div class="card-grid">
                        <!-- Race Card -->
                        <div class="card race-card">
                            <div class="card-header">
                                <i class="ra ra-double-team"></i>
                                <h3>Heritage</h3>
                            </div>
                            <select id="race-select" class="fancy-select">
                                <option value="">Choose your heritage...</option>
                                <optgroup label="Dungeon Crawler">
                                    <option value="bopca">üõ∏ Bopca</option>
                                    <option value="skyfowl">ü¶Ö Skyfowl</option>
                                    <option value="rat_kin">üêÄ Rat-kin</option>
                                    <option value="hellspawn_familiar">üëπ Hellspawn Familiar</option>
                                    <option value="primal">‚ú® Primal</option>
                                    <option value="were_creature">üê∫ Were-creature</option>
                                </optgroup>
                                <optgroup label="Classic Fantasy">
                                    <option value="human">üë§ Human</option>
                                    <option value="elf">üßù Elf</option>
                                    <option value="dwarf">‚õèÔ∏è Dwarf</option>
                                    <option value="orc">üí™ Orc</option>
                                    <option value="halfling">üçÑ Halfling</option>
                                    <option value="dragonborn">üê≤ Dragonborn</option>
                                    <option value="tiefling">üòà Tiefling</option>
                                    <option value="gnome">üßô Gnome</option>
                                    <option value="goblin">üë∫ Goblin</option>
                                    <option value="slime">üíß Slime</option>
                                </optgroup>
                                <optgroup label="Sci-Fi">
                                    <option value="cyborg">ü§ñ Cyborg</option>
                                    <option value="mutant">‚ò¢Ô∏è Mutant</option>
                                    <option value="android">ü¶æ Android</option>
                                    <option value="clone">üß¨ Clone</option>
                                </optgroup>
                                <optgroup label="Post-Apocalyptic">
                                    <option value="ghoul">‚ò†Ô∏è Ghoul</option>
                                    <option value="raider">‚öîÔ∏è Raider</option>
                                    <option value="vault_dweller">üè† Vault Dweller</option>
                                    <option value="synth">üîß Synth</option>
                                    <option value="beast_kin">üê∫ Beast-kin</option>
                                    <option value="plant_hybrid">üåø Plant Hybrid</option>
                                </optgroup>
                                <option value="custom">‚ú® Custom Heritage</option>
                            </select>

                            <input type="text" id="custom-race" class="fancy-input" placeholder="Enter custom heritage"
                                style="display: none;">

                            <!-- Custom Race Builder -->
                            <div id="custom-race-bonuses" class="custom-builder" style="display: none;">
                                <h4>Custom Heritage Builder</h4>

                                <div class="builder-section">
                                    <label>Attribute Bonuses (Pick 1-2)</label>
                                    <div class="checkbox-grid">
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-str"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>STR</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-dex"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>DEX</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-con"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>CON</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-int"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>INT</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-wis"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>WIS</span>
                                        </label>
                                        <label class="checkbox-pill">
                                            <input type="checkbox" id="custom-race-cha"
                                                onchange="updateCustomRaceBonuses()">
                                            <span>CHA</span>
                                        </label>
                                    </div>
                                </div>

                                <div class="builder-section">
                                    <label>Attribute Limits</label>
                                    <div class="stat-limit-grid">
                                        <div class="limit-input">
                                            <label>STR</label>
                                            <input type="number" id="custom-race-max-str" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>DEX</label>
                                            <input type="number" id="custom-race-max-dex" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>CON</label>
                                            <input type="number" id="custom-race-max-con" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>INT</label>
                                            <input type="number" id="custom-race-max-int" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>WIS</label>
                                            <input type="number" id="custom-race-max-wis" value="15" min="5" max="25">
                                        </div>
                                        <div class="limit-input">
                                            <label>CHA</label>
                                            <input type="number" id="custom-race-max-cha" value="15" min="5" max="25">
                                        </div>
                                    </div>
                                </div>

                                <div class="builder-section">
                                    <label>Racial Abilities</label>
                                    <div class="skill-builder">
                                        <select id="custom-race-skill1" class="skill-select">
                                            <option value="">First ability...</option>
                                            <option value="custom">‚úèÔ∏è Custom</option>
                                            <option value="Darkvision">üëÅÔ∏è Darkvision</option>
                                            <option value="Flight">ü¶Ö Flight</option>
                                            <option value="Telepathy">üß† Telepathy</option>
                                            <option value="Regeneration">‚ù§Ô∏è‚Äçü©π Regeneration</option>
                                            <option value="Natural Armor">üõ°Ô∏è Natural Armor</option>
                                            <option value="Keen Senses">üëÇ Keen Senses</option>
                                            <option value="Camouflage">üåø Camouflage</option>
                                            <option value="Aquatic">üåä Aquatic</option>
                                        </select>
                                        <select id="custom-race-skill1-stat" class="stat-select">
                                            <option value="strength">STR</option>
                                            <option value="dexterity">DEX</option>
                                            <option value="constitution">CON</option>
                                            <option value="intelligence">INT</option>
                                            <option value="wisdom">WIS</option>
                                            <option value="charisma">CHA</option>
                                        </select>
                                        <input type="text" id="custom-race-skill1-name" class="custom-skill-name"
                                            placeholder="Ability name" style="display: none;">
                                    </div>

                                    <div class="skill-builder">
                                        <select id="custom-race-skill2" class="skill-select">
                                            <option value="">Second ability...</option>
                                            <option value="custom">‚úèÔ∏è Custom</option>
                                            <option value="Darkvision">üëÅÔ∏è Darkvision</option>
                                            <option value="Flight">ü¶Ö Flight</option>
                                            <option value="Telepathy">üß† Telepathy</option>
                                            <option value="Regeneration">‚ù§Ô∏è‚Äçü©π Regeneration</option>
                                            <option value="Natural Armor">üõ°Ô∏è Natural Armor</option>
                                            <option value="Keen Senses">üëÇ Keen Senses</option>
                                            <option value="Camouflage">üåø Camouflage</option>
                                            <option value="Aquatic">üåä Aquatic</option>
                                        </select>
                                        <select id="custom-race-skill2-stat" class="stat-select">
                                            <option value="strength">STR</option>
                                            <option value="dexterity">DEX</option>
                                            <option value="constitution">CON</option>
                                            <option value="intelligence">INT</option>
                                            <option value="wisdom">WIS</option>
                                            <option value="charisma">CHA</option>
                                        </select>
                                        <input type="text" id="custom-race-skill2-name" class="custom-skill-name"
                                            placeholder="Ability name" style="display: none;">
                                    </div>
                                </div>
                            </div>
                        </div>

                        <!-- Background Card -->
                        <div class="card background-card">
                            <div class="card-header">
                                <i class="ra ra-scroll-unfurled"></i>
                                <h3>Background</h3>
                            </div>
                            <select id="job-select" class="fancy-select">
                                <option value="">Choose your past...</option>
                                <optgroup label="Academic">
                                    <option value="teacher">üìö Teacher</option>
                                    <option value="scientist">üî¨ Scientist</option>
                                    <option value="doctor">‚öïÔ∏è Doctor</option>
                                    <option value="lawyer">‚öñÔ∏è Lawyer</option>
                                </optgroup>
                                <optgroup label="Technical">
                                    <option value="engineer">‚öôÔ∏è Engineer</option>
                                    <option value="mechanic">üîß Mechanic</option>
                                    <option value="programmer">üíª Programmer</option>
                                </optgroup>
                                <optgroup label="Service">
                                    <option value="soldier">üéñÔ∏è Soldier</option>
                                    <option value="police">üëÆ Police Officer</option>
                                    <option value="firefighter">üöí Firefighter</option>
                                </optgroup>
                                <optgroup label="Creative">
                                    <option value="artist">üé® Artist</option>
                                    <option value="musician">üéµ Musician</option>
                                    <option value="writer">‚úçÔ∏è Writer</option>
                                    <option value="chef">üë®‚Äçüç≥ Chef</option>
                                </optgroup>
                                <optgroup label="Physical">
                                    <option value="athlete">üèÉ Athlete</option>
                                </optgroup>
                                <option value="custom">‚ú® Custom Background</option>
                            </select>

                            <input type="text" id="custom-job" class="fancy-input" placeholder="Enter custom background"
                                style="display: none;">

                            <!-- Custom Job Builder (similar structure) -->
                            <div id="custom-job-bonuses" class="custom-builder" style="display: none;">
                                <!-- Similar to race builder but for jobs -->
                            </div>
                        </div>

                        <!-- Class Card -->
                        <div class="card class-card">
                            <div class="card-header">
                                <i class="ra ra-crossed-swords"></i>
                                <h3>Class</h3>
                            </div>
                            <select id="class-select" class="fancy-select">
                                <option value="">Choose your path...</option>
                                <optgroup label="Dungeon Crawler">
                                    <option value="compensated_anarchist">üí• Compensated Anarchist</option>
                                    <option value="bomb_squad_tech">üí£ Bomb Squad Tech</option>
                                    <option value="prizefighter">üëä Prizefighter</option>
                                    <option value="artist_alley_mogul">üé® Artist Alley Mogul</option>
                                    <option value="former_child_actor">üé≠ Former Child Actor</option>
                                    <option value="roller_derby_jammer">üõº Roller Derby Jammer</option>
                                    <option value="football_hooligan">‚öΩ Football Hooligan</option>
                                    <option value="kabaddi_raider">ü§º Kabaddi Raider</option>
                                    <option value="monster_truck_driver">üöö Monster Truck Driver</option>
                                    <option value="vape_shop_counter_jockey">üí® Vape Shop Counter Jockey</option>
                                    <option value="freelance_psychiatrist">üß† Freelance Psychiatrist</option>
                                    <option value="banana_farmer">üçå Banana Farmer</option>
                                    <option value="necrobard">üíÄ NecroBard</option>
                                    <option value="feral_cat_berserker">üê± Feral Cat Berserker</option>
                                    <option value="animal_test_subject">üß™ Animal Test Subject</option>
                                    <option value="glass_cannon">üîÆ Glass Cannon</option>
                                    <option value="legendary_diva">üëë Legendary Diva</option>
                                    <option value="viper_queen">üêç Viper Queen</option>
                                </optgroup>
                                <optgroup label="Warriors">
                                    <option value="fighter">‚öîÔ∏è Fighter</option>
                                    <option value="barbarian">ü™ì Barbarian</option>
                                    <option value="paladin">üõ°Ô∏è Paladin</option>
                                    <option value="monk">ü•ã Monk</option>
                                </optgroup>
                                <optgroup label="Rogues">
                                    <option value="rogue">üó°Ô∏è Rogue</option>
                                    <option value="ranger">üèπ Ranger</option>
                                    <option value="gunslinger">üî´ Gunslinger</option>
                                </optgroup>
                                <optgroup label="Mages">
                                    <option value="wizard">üßô Wizard</option>
                                    <option value="sorcerer">‚ú® Sorcerer</option>
                                    <option value="warlock">üëπ Warlock</option>
                                    <option value="druid">üå≥ Druid</option>
                                </optgroup>
                                <optgroup label="Support">
                                    <option value="cleric">‚õ™ Cleric</option>
                                    <option value="bard">üé≠ Bard</option>
                                    <option value="medic">üè• Field Medic</option>
                                </optgroup>
                                <optgroup label="Tech">
                                    <option value="hacker">üíæ Data Runner</option>
                                    <option value="engineer_class">üî® Engineer</option>
                                    <option value="pilot">‚úàÔ∏è Pilot</option>
                                </optgroup>
                                <optgroup label="Survival">
                                    <option value="survivalist">üèïÔ∏è Survivalist</option>
                                </optgroup>
                                <option value="custom_class">‚ú® Custom Class</option>
                            </select>

                            <input type="text" id="custom-class" class="fancy-input" placeholder="Enter custom class"
                                style="display: none;">

                            <!-- Custom Class Builder (similar structure) -->
                            <div id="custom-class-bonuses" class="custom-builder" style="display: none;">
                                <!-- Similar to race builder but for classes -->
                            </div>
                        </div>
                    </div>

                    <!-- Active Bonuses -->
                    <div class="card bonuses-card" id="bonuses-display" style="display: none;">
                        <div class="card-header">
                            <i class="ra ra-trophy"></i>
                            <h3>Active Bonuses</h3>
                        </div>
                        <div id="bonuses-content" class="bonuses-list">
                            <!-- Bonuses will be rendered here -->
                        </div>
                    </div>

                    <!-- Attributes Section -->
                    <div class="card attributes-card">
                        <div class="card-header">
                            <i class="ra ra-muscle-up"></i>
                            <h3>Attributes</h3>
                            <div class="points-display">
                                <span class="points-label">Points</span>
                                <span class="points-value" id="available-points">3</span>
                            </div>
                        </div>

                        <div class="attributes-grid" id="stats-grid">
                            <!-- Stats will be rendered here -->
                        </div>

                        <div class="vital-stats">
                            <div class="vital-stat hp-stat">
                                <i class="ra ra-hearts"></i>
                                <div class="vital-info">
                                    <span class="vital-label">Health</span>
                                    <span class="vital-value" id="health-points">3</span>
                                </div>
                            </div>
                            <div class="vital-stat mp-stat">
                                <i class="ra ra-crystal-wand"></i>
                                <div class="vital-info">
                                    <span class="vital-label">Magic</span>
                                    <span class="vital-value" id="magic-points">4</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Story Section -->
                    <div class="card story-card">
                        <div class="card-header">
                            <i class="ra ra-book"></i>
                            <h3>Character Story</h3>
                        </div>
                        <textarea id="char-backstory" class="story-textarea"
                            placeholder="Tell your character's story..." rows="6"></textarea>
                    </div>

                    <!-- Skills Selection Section -->
                    <div class="card skills-selection-card">
                        <div class="card-header">
                            <i class="ra ra-gears"></i>
                            <h3>Starting Skills</h3>
                            <div class="skills-counter">
                                <span class="skills-label">Selected</span>
                                <span class="skills-value" id="selected-skills-count">0</span>
                                <span class="skills-max">/5</span>
                            </div>
                        </div>
                        <p class="hint-text">Choose up to 5 skills from the list below, or create your own custom skills. Skills based on your class and job attributes get bonus dice!</p>
                        
                        <div class="skills-tabs">
                            <button class="skills-tab-btn active" data-skills-tab="existing">
                                <i class="ra ra-book"></i>
                                Existing Skills
                            </button>
                            <button class="skills-tab-btn" data-skills-tab="custom">
                                <i class="ra ra-quill-ink"></i>
                                Custom Skills
                            </button>
                        </div>

                        <!-- Existing Skills Tab -->
                        <div class="skills-tab-content active" id="existing-skills-tab">
                            <div class="skills-filter">
                                <select id="skills-filter-stat" class="filter-select">
                                    <option value="">Filter by attribute...</option>
                                    <option value="strength">Strength</option>
                                    <option value="dexterity">Dexterity</option>
                                    <option value="constitution">Constitution</option>
                                    <option value="intelligence">Intelligence</option>
                                    <option value="wisdom">Wisdom</option>
                                    <option value="charisma">Charisma</option>
                                </select>
                                <input type="text" id="skills-search" class="search-input" placeholder="Search skills...">
                            </div>
                            <div class="skills-selection-grid" id="skills-selection-grid">
                                <!-- Available skills will be rendered here -->
                            </div>
                        </div>

                        <!-- Custom Skills Tab -->
                        <div class="skills-tab-content" id="custom-skills-tab">
                            <div class="custom-skills-creator">
                                <h4>Create Custom Skills</h4>
                                <div class="custom-skill-form">
                                    <input type="text" id="custom-skill-name" class="skill-name-input" 
                                           placeholder="Skill name (e.g., 'Spaceship Piloting')">
                                    <select id="custom-skill-stat" class="skill-stat-select">
                                        <option value="strength">Strength</option>
                                        <option value="dexterity">Dexterity</option>
                                        <option value="constitution">Constitution</option>
                                        <option value="intelligence">Intelligence</option>
                                        <option value="wisdom">Wisdom</option>
                                        <option value="charisma">Charisma</option>
                                    </select>
                                    <button class="add-custom-skill-btn" onclick="addCustomSkillToSelection()">
                                        <span class="material-icons">add</span>
                                        Add Skill
                                    </button>
                                </div>
                                <div class="custom-skills-list" id="custom-skills-list">
                                    <!-- Custom skills will appear here -->
                                </div>
                            </div>
                        </div>

                        <!-- Selected Skills Display -->
                        <div class="selected-skills-section">
                            <h4>Your Selected Skills</h4>
                            <div class="selected-skills-grid" id="selected-skills-grid">
                                <div class="no-skills-message">
                                    <i class="ra ra-help"></i>
                                    <p>No skills selected yet. Choose up to 5 skills above!</p>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Action Buttons -->
                    <div class="action-bar">
                        <button class="action-btn new-char-btn" onclick="createNewCharacter()">
                            <span class="material-icons">person_add</span>
                            New Character
                        </button>
                        <button class="action-btn primary-btn" onclick="saveCharacterToStorage()">
                            <span class="material-icons">save</span>
                            Save Character
                        </button>
                        <button class="action-btn secondary-btn" onclick="loadCharacterFromStorage()">
                            <span class="material-icons">folder_open</span>
                            Load
                        </button>
                        <button class="action-btn secondary-btn" onclick="exportCharacterToJSON()">
                            <span class="material-icons">download</span>
                            Export
                        </button>
                    </div>
                </div>
            </section>

            <!-- Character Stats Tab -->
            <section class="tab-content" id="character">
                <div class="content-wrapper">
                    <!-- Character Overview with Merged Vitals -->
                    <div class="character-overview">
                        <div class="overview-combined">
                            <div class="overview-portrait" id="overview-portrait">
                                <div class="portrait-placeholder">
                                    <i class="ra ra-hood"></i>
                                </div>
                            </div>
                            <div class="overview-content">
                                <h2 id="char-display-name">Character Overview</h2>
                                <div id="char-summary" class="character-summary">
                                    <!-- Summary will be rendered here -->
                                </div>

                                <!-- Vitals Display -->
                                <div class="vitals-inline">
                                    <div class="vital-item">
                                        <i class="ra ra-hearts"></i>
                                        <span class="vital-label">HP</span>
                                        <span class="vital-value">
                                            <span id="char-current-hp">3</span>/<span id="char-total-hp">3</span>
                                        </span>
                                    </div>
                                    <div class="vital-item">
                                        <i class="ra ra-crystal-wand"></i>
                                        <span class="vital-label">MP</span>
                                        <span class="vital-value">
                                            <span id="char-current-mp">4</span>/<span id="char-total-mp">4</span>
                                        </span>
                                    </div>
                                    <div class="damage-tester-inline">
                                        <input type="number" id="damage-input" class="damage-input" placeholder="DMG"
                                            value="5" min="1">
                                        <button class="damage-btn" onclick="testDamage()">
                                            <i class="ra ra-sword"></i>
                                            Take
                                        </button>
                                    </div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Rest Options -->
                    <div class="rest-options">
                        <button class="rest-btn quick-rest" onclick="quickRest()">
                            <i class="ra ra-campfire"></i>
                            <span>Quick Rest</span>
                            <small>+Half HP/MP</small>
                        </button>
                        <button class="rest-btn long-rest" onclick="longRest()">
                            <i class="ra ra-moon-sun"></i>
                            <span>Long Rest</span>
                            <small>Full Recovery</small>
                        </button>
                    </div>

                    <!-- Attributes Display -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-muscle-up"></i>
                            <h3>Attributes</h3>
                        </div>
                        <p class="hint-text">Tap any attribute to roll!</p>
                        <div class="attributes-display" id="char-stats-display">
                            <!-- Stats will be rendered here -->
                        </div>
                        <div class="bonus-sources-display" id="bonus-sources-display">
                            <!-- Bonus source info will be rendered here -->
                        </div>
                    </div>

                    <!-- Abilities Navigation -->
                    <div class="abilities-nav">
                        <button class="ability-nav-btn active" data-ability="skills">
                            <i class="ra ra-gears"></i>
                            Skills
                        </button>
                        <button class="ability-nav-btn" data-ability="weapons">
                            <i class="ra ra-crossed-swords"></i>
                            Weapons
                        </button>
                        <button class="ability-nav-btn" data-ability="spells">
                            <i class="ra ra-fairy-wand"></i>
                            Spells
                        </button>
                    </div>

                    <!-- Abilities Content -->
                    <div class="abilities-content">
                        <!-- Skills -->
                        <div class="ability-panel active" id="skills-content">
                            <div class="ability-grid" id="char-skills-grid">
                                <!-- Skills will be rendered here -->
                            </div>

                            <div class="add-ability-section">
                                <h4><i class="ra ra-plus-sword"></i> Add Custom Skill</h4>
                                <div class="add-ability-form">
                                    <input type="text" id="char-custom-skill-name" class="ability-name-input"
                                        placeholder="Skill name">
                                    <select id="char-custom-skill-stat" class="ability-stat-select">
                                        <option value="strength">STR</option>
                                        <option value="dexterity">DEX</option>
                                        <option value="constitution">CON</option>
                                        <option value="intelligence">INT</option>
                                        <option value="wisdom">WIS</option>
                                        <option value="charisma">CHA</option>
                                    </select>
                                    <button class="add-ability-btn" onclick="addCustomSkillFromCharTab()">
                                        <span class="material-icons">add</span>
                                    </button>
                                </div>
                            </div>
                        </div>

                        <!-- Weapons -->
                        <div class="ability-panel" id="weapons-content">
                            <div id="char-weapons-container" class="weapons-container">
                                <!-- Weapons will be rendered here -->
                            </div>
                        </div>

                        <!-- Spells -->
                        <div class="ability-panel" id="spells-content">
                            <div id="char-spells-container" class="spells-container">
                                <!-- Spells will be rendered here -->
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Inventory Tab -->
            <section class="tab-content" id="inventory">
                <div class="content-wrapper">
                    <!-- Equipment Slots -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-vest"></i>
                            <h3>Equipment</h3>
                        </div>
                        <div class="equipment-grid">
                            <div class="equipment-slot" data-slot="mainHand" onclick="showEquipMenu('mainHand')">
                                <div class="slot-icon"><i class="ra ra-sword"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Main Hand</div>
                                    <div class="slot-item" id="mainHand-item">Empty</div>
                                    <div class="slot-stats" id="mainHand-stats"></div>
                                </div>
                            </div>
                            <div class="equipment-slot" data-slot="offHand" onclick="showEquipMenu('offHand')">
                                <div class="slot-icon"><i class="ra ra-shield"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Off Hand</div>
                                    <div class="slot-item" id="offHand-item">Empty</div>
                                    <div class="slot-stats" id="offHand-stats"></div>
                                </div>
                            </div>
                            <div class="equipment-slot" data-slot="armor" onclick="showEquipMenu('armor')">
                                <div class="slot-icon"><i class="ra ra-vest"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Armor</div>
                                    <div class="slot-item" id="armor-item">Empty</div>
                                    <div class="slot-stats" id="armor-stats"></div>
                                </div>
                            </div>
                            <div class="equipment-slot" data-slot="accessory" onclick="showEquipMenu('accessory')">
                                <div class="slot-icon"><i class="ra ra-gem-pendant"></i></div>
                                <div class="slot-info">
                                    <div class="slot-label">Accessory</div>
                                    <div class="slot-item" id="accessory-item">Empty</div>
                                    <div class="slot-stats" id="accessory-stats"></div>
                                </div>
                            </div>
                        </div>
                    </div>

                    <!-- Inventory Grid -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-backpack"></i>
                            <h3>Inventory</h3>
                        </div>
                        <div class="inventory-grid" id="inventory-grid">
                            <!-- Items will be rendered here -->
                        </div>

                        <!-- Add Item Form -->
                        <div class="add-item-section">
                            <h4><i class="ra ra-anvil"></i> Create New Item</h4>
                            <div class="item-creator">
                                <input type="text" id="item-name" class="item-input" placeholder="Item name">

                                <div class="item-options">
                                    <select id="item-type" class="item-select">
                                        <option value="weapon">‚öîÔ∏è Weapon</option>
                                        <option value="armor">üõ°Ô∏è Armor</option>
                                        <option value="accessory">üíç Accessory</option>
                                        <option value="consumable">üß™ Consumable</option>
                                        <option value="misc">üì¶ Miscellaneous</option>
                                    </select>

                                    <select id="weapon-size" class="item-select">
                                        <option value="light">Light (d4)</option>
                                        <option value="medium">Medium (d6)</option>
                                        <option value="heavy">Heavy (d8)</option>
                                    </select>

                                    <input type="number" id="item-defense" class="item-input" placeholder="Defense"
                                        min="0">
                                </div>

                                <div class="item-properties">
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="item-twohanded">
                                        <span>Two-Handed</span>
                                    </label>
                                    <label class="checkbox-label">
                                        <input type="checkbox" id="item-ranged">
                                        <span>Ranged</span>
                                    </label>
                                    <label class="checkbox-label" id="healing-consumable-container"
                                        style="display: none;">
                                        <input type="checkbox" id="item-healing">
                                        <span>Healing</span>
                                    </label>
                                </div>

                                <button class="create-item-btn" onclick="addItem()">
                                    <i class="ra ra-hammer"></i>
                                    Create Item
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Magic Tab -->
            <section class="tab-content" id="magic">
                <div class="content-wrapper">
                    <!-- Magic Points Display -->
                    <div class="magic-header">
                        <div class="magic-pool">
                            <i class="ra ra-crystal-wand"></i>
                            <div class="magic-counter">
                                <button class="counter-btn" onclick="adjustMagicPointsInTab(-1)">-</button>
                                <div class="magic-display">
                                    <span id="magic-current-mp">4</span>
                                    <span>/</span>
                                    <span id="magic-total-mp">4</span>
                                </div>
                                <button class="counter-btn" onclick="adjustMagicPointsInTab(1)">+</button>
                            </div>
                            <span class="magic-label">Magic Points</span>
                        </div>
                    </div>

                    <!-- Known Spells -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-scroll-unfurled"></i>
                            <h3>Spell Book</h3>
                        </div>
                        <div id="spells-grid" class="spells-grid">
                            <!-- Spells will be rendered here -->
                        </div>
                    </div>

                    <!-- Spell Creator -->
                    <div class="card spell-creator-card">
                        <div class="card-header">
                            <i class="ra ra-cauldron"></i>
                            <h3>Craft New Spell</h3>
                        </div>

                        <div class="spell-creator">
                            <input type="text" id="spell-name" class="spell-name-input" placeholder="Spell name">

                            <div class="spell-element-select">
                                <label>Element</label>
                                <select id="spell-element" class="element-select">
                                    <option value="fire">üî• Fire</option>
                                    <option value="ice">‚ùÑÔ∏è Ice</option>
                                    <option value="lightning">‚ö° Lightning</option>
                                    <option value="earth">üåç Earth</option>
                                    <option value="air">üí® Air</option>
                                    <option value="water">üíß Water</option>
                                    <option value="light">‚òÄÔ∏è Light</option>
                                    <option value="dark">üåë Dark</option>
                                    <option value="arcane">üîÆ Arcane</option>
                                    <option value="divine">‚ú® Divine</option>
                                    <option value="nature">üåø Nature</option>
                                    <option value="psychic">üß† Psychic</option>
                                    <option value="shadow">üë§ Shadow</option>
                                    <option value="force">üí• Force</option>
                                </select>
                            </div>

                            <div class="spell-effects">
                                <div class="effect-row">
                                    <label>Damage</label>
                                    <select id="damage-type" class="effect-select">
                                        <option value="">None</option>
                                        <option value="fixed">Fixed (2pts = 1MP)</option>
                                        <option value="d6">D6 Roll (3MP)</option>
                                    </select>
                                    <input type="number" id="damage-amount" class="effect-amount" min="0" max="10"
                                        value="0" disabled>
                                </div>

                                <div class="effect-row">
                                    <label>Healing</label>
                                    <select id="healing-type" class="effect-select">
                                        <option value="">None</option>
                                        <option value="fixed">Fixed (2pts = 1MP)</option>
                                        <option value="d6">D6 Roll (3MP)</option>
                                    </select>
                                    <input type="number" id="healing-amount" class="effect-amount" min="0" max="10"
                                        value="0" disabled>
                                </div>

                                <div class="effect-row">
                                    <label>Primary Effect</label>
                                    <select id="primary-effect" class="effect-select">
                                        <option value="">None</option>
                                        <option value="stun">‚ö° Stun</option>
                                        <option value="slow">üêå Slow</option>
                                        <option value="blind">üëÅÔ∏è Blind</option>
                                        <option value="fear">üò± Fear</option>
                                        <option value="charm">üíï Charm</option>
                                        <option value="sleep">üò¥ Sleep</option>
                                        <option value="paralyze">ü•∂ Paralyze</option>
                                        <option value="confusion">üåÄ Confuse</option>
                                        <option value="weakness">üí™ Weakness</option>
                                        <option value="poison">ü§¢ Poison</option>
                                    </select>
                                </div>

                                <div class="effect-row">
                                    <label>Secondary Effect</label>
                                    <select id="secondary-effect" class="effect-select">
                                        <option value="">None</option>
                                        <option value="invisibility">üëª Invisibility</option>
                                        <option value="flight">ü¶Ö Flight</option>
                                        <option value="teleport">üåÄ Teleport</option>
                                        <option value="shield">üõ°Ô∏è Shield</option>
                                        <option value="haste">‚ö° Haste</option>
                                        <option value="strength">üí™ Strength</option>
                                        <option value="detect">üîç Detect Magic</option>
                                        <option value="dispel">‚ùå Dispel</option>
                                        <option value="light_source">üí° Light</option>
                                        <option value="darkness">üåë Darkness</option>
                                    </select>
                                </div>
                            </div>

                            <div id="spell-cost-display" class="spell-cost-display">
                                <h4>Spell Cost</h4>
                                <div id="cost-breakdown" class="cost-breakdown">
                                    Base Cost: 1 MP
                                </div>
                                <div class="total-cost">
                                    Total: <span id="total-cost">1</span> MP
                                </div>
                            </div>

                            <button class="create-spell-btn" onclick="createSpell()" id="create-spell-btn">
                                <i class="ra ra-sparkles"></i>
                                Create Spell
                            </button>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Combat Tab (Merged Status + Rolling) -->
            <section class="tab-content" id="combat">
                <div class="content-wrapper">
                    <!-- Dice System Info -->
                    <div class="card dice-info-card">
                        <div class="card-header">
                            <i class="ra ra-perspective-dice-six"></i>
                            <h3>Dice System</h3>
                        </div>
                        <div id="dice-system-info" class="dice-info">
                            <div id="dice-explanation">
                                <!-- Dice system will be explained here -->
                            </div>
                        </div>
                    </div>

                    <!-- Roll History -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-scroll-unfurled"></i>
                            <h3>Roll History</h3>
                            <button class="clear-btn" onclick="clearRollHistory()">
                                <span class="material-icons">clear_all</span>
                            </button>
                        </div>
                        <div id="roll-history" class="roll-history">
                            <!-- Roll history will be rendered here -->
                        </div>
                    </div>

                    <!-- Status Effects -->
                    <div class="card">
                        <div class="card-header">
                            <i class="ra ra-biohazard"></i>
                            <h3>Status Effects</h3>
                        </div>
                        <div id="status-effects-grid" class="status-grid">
                            <!-- Status effects will be rendered here -->
                        </div>

                        <!-- Add Status Effect -->
                        <div class="add-status-section">
                            <h4>Apply Status Effect</h4>
                            <div class="status-form">
                                <select id="status-effect-type" class="status-select">
                                    <option value="bleeding">ü©∏ Bleeding</option>
                                    <option value="poisoned">ü§¢ Poisoned</option>
                                    <option value="radiation">‚ò¢Ô∏è Radiation</option>
                                    <option value="exhausted">üò¥ Exhausted</option>
                                    <option value="dehydrated">üíß Dehydrated</option>
                                    <option value="hypothermia">üßä Hypothermia</option>
                                    <option value="heatstroke">üî• Heat Exhaustion</option>
                                    <option value="broken_bone">ü¶¥ Broken Bone</option>
                                    <option value="stunned">‚ö° Stunned</option>
                                    <option value="feared">üò± Feared</option>
                                    <option value="inspired">‚ú® Inspired</option>
                                    <option value="custom">‚öôÔ∏è Custom</option>
                                </select>

                                <input type="text" id="custom-status-name" class="status-input"
                                    placeholder="Custom effect name" style="display: none;">

                                <div class="status-options">
                                    <input type="number" id="status-duration" class="duration-input" value="10" min="1"
                                        max="1440">
                                    <span class="duration-label">minutes</span>
                                </div>

                                <input type="text" id="status-notes" class="status-notes"
                                    placeholder="Additional notes...">

                                <button class="add-status-btn" onclick="addStatusEffect()">
                                    <i class="ra ra-flask"></i>
                                    Apply Effect
                                </button>
                            </div>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Notes Tab -->
            <section class="tab-content" id="notes">
                <div class="content-wrapper">
                    <div class="notes-header">
                        <h2><i class="ra ra-journal"></i> Campaign Notes</h2>
                        <button class="save-notes-btn" onclick="saveNotesToCharacter()">
                            <span class="material-icons">save</span>
                            Save Notes
                        </button>
                    </div>

                    <div class="notes-grid">
                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-hood"></i>
                                <h3>Personal</h3>
                            </div>
                            <textarea id="personal-notes" class="note-textarea"
                                placeholder="Character thoughts, development, personal goals..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-key"></i>
                                <h3>Party</h3>
                            </div>
                            <textarea id="party-notes" class="note-textarea"
                                placeholder="Party members, relationships, group dynamics..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-quill-ink"></i>
                                <h3>Session</h3>
                            </div>
                            <textarea id="session-notes" class="note-textarea"
                                placeholder="What happened this session..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-gold-bar"></i>
                                <h3>Trade</h3>
                            </div>
                            <textarea id="barter-notes" class="note-textarea"
                                placeholder="Merchants, deals, debts, opportunities..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-compass"></i>
                                <h3>World</h3>
                            </div>
                            <textarea id="world-notes" class="note-textarea"
                                placeholder="Locations, lore, important places..."></textarea>
                        </div>

                        <div class="note-card">
                            <div class="note-header">
                                <i class="ra ra-crossed-swords"></i>
                                <h3>Combat</h3>
                            </div>
                            <textarea id="combat-notes" class="note-textarea"
                                placeholder="Enemy tactics, weaknesses, strategies..."></textarea>
                        </div>
                    </div>
                </div>
            </section>

            <!-- Reference/How the Game Works Tab -->
            <section class="tab-content" id="reference">
                <div class="content-wrapper">
                    <div class="card">
                        <div class="card-header">
                            <i class="material-icons">help_outline</i>
                            <h3>How the Game Works</h3>
                        </div>
                        <div class="reference-loading">
                            <div class="loading-spinner"></div>
                            <p>Loading game reference...</p>
                        </div>
                        <div class="reference-content" id="reference-content" style="display: none;">
                            <!-- Markdown content will be loaded here -->
                        </div>
                    </div>
                </div>
            </section>
        </main>
    </div>

    <!-- Notification Container -->
    <div id="notification-container"></div>

    <!-- Character Landing Screen (Initially visible, managed by JS) -->
    <div id="character-landing" class="character-landing" style="display: none;">
        <div class="landing-header">
            <h1><i class="ra ra-knight-helmet"></i> Dungeon Crawler</h1>
            <p>Choose your character or create a new one</p>
        </div>

        <div class="landing-actions">
            <button class="landing-btn primary-btn" onclick="createNewCharacter()">
                <span class="material-icons">person_add</span>
                New Character
            </button>
            <button class="landing-btn secondary-btn" onclick="importCharacterToManager()">
                <span class="material-icons">upload</span>
                Import Character
            </button>
            <button class="landing-btn secondary-btn" onclick="exportAllCharacters()">
                <span class="material-icons">download</span>
                Export All
            </button>
        </div>

        <div class="characters-grid" id="characters-grid">
            <!-- Character cards will be populated here -->
        </div>

        <div class="landing-footer">
            <p>Characters are saved locally in your browser. Use Export to backup your characters.</p>
        </div>
    </div>

    <!-- Scripts -->
    <script src="main.js"></script>
    <script src="character-manager.js"></script>
    <script src="cache-manager.js"></script>
    <script>
        // Theme Toggle
        function toggleTheme() {
            document.body.classList.toggle('dark-theme');
            localStorage.setItem('theme', document.body.classList.contains('dark-theme') ? 'dark' : 'light');
        }

        // Load saved theme
        if (localStorage.getItem('theme') === 'dark' ||
            (!localStorage.getItem('theme') && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            document.body.classList.add('dark-theme');
        }

        // Mobile optimizations
        document.addEventListener('DOMContentLoaded', () => {
            // Prevent zoom on input focus (iOS)
            const inputs = document.querySelectorAll('input, select, textarea');
            inputs.forEach(input => {
                input.addEventListener('focus', () => {
                    document.querySelector('meta[name="viewport"]').setAttribute('content',
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                });
                input.addEventListener('blur', () => {
                    document.querySelector('meta[name="viewport"]').setAttribute('content',
                        'width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no');
                });
            });

            // Tab navigation
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const tabName = btn.dataset.tab;
                    switchTab(tabName);

                    // Update active states
                    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
                    btn.classList.add('active');
                });
            });

            // Ability navigation
            document.querySelectorAll('.ability-nav-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const abilityName = btn.dataset.ability;

                    // Update active states
                    document.querySelectorAll('.ability-nav-btn').forEach(b => b.classList.remove('active'));
                    document.querySelectorAll('.ability-panel').forEach(p => p.classList.remove('active'));

                    btn.classList.add('active');
                    document.getElementById(`${abilityName}-content`).classList.add('active');
                });
            });

            // Portrait upload
            document.getElementById('portrait-display').addEventListener('click', () => {
                document.getElementById('portrait-upload').click();
            });
        });
    </script>

    <script src="skills.js"></script>
    <script src="improvements.js"></script>
    <script src="achievements.js"></script>
    <!-- <script src="debug-dcc.js"></script> -->
    <script>
        // PWA Service Worker Registration - DISABLED TO PREVENT CACHING ISSUES
        /* 
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', function () {
                navigator.serviceWorker.register('./sw.js')
                    .then(function (registration) {
                        console.log('DCC Character Sheet: Service Worker registered successfully:', registration.scope);
                    })
                    .catch(function (error) {
                        console.log('DCC Character Sheet: Service Worker registration failed:', error);
                    });
            });
        }
        */
        console.log('üö´ Service Worker disabled - using browser cache only for better development experience');

        // PWA Install Prompt
        let deferredPrompt;
        window.addEventListener('beforeinstallprompt', (e) => {
            e.preventDefault();
            deferredPrompt = e;

            // Show install button
            const installBtn = document.createElement('button');
            installBtn.textContent = 'üì± Install App';
            installBtn.style.cssText = `
            position: fixed;
            top: 10px;
            right: 10px;
            z-index: 10000;
            background: #ff6b35;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
        `;
            installBtn.onclick = () => {
                deferredPrompt.prompt();
                deferredPrompt.userChoice.then((choiceResult) => {
                    if (choiceResult.outcome === 'accepted') {
                        console.log('User accepted the install prompt');
                    }
                    deferredPrompt = null;
                    installBtn.remove();
                });
            };
            document.body.appendChild(installBtn);
        });
    </script>
</body>

</html>
